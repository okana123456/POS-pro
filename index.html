function deleteProduct(id) {
        if (confirm('Delete this product?')) {
            products = products.filter(p => p.id !== id);
            saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);
            
            if (navigator.onLine) {
                db.collection('products').doc(id).delete()
                    .catch(err => console.error('Error deleting product:', err));
            }
            
            loadProducts();
            updateDashboard();
        }
    }
    
    function exportProducts() {
        const data = products.map(p => ({
            Name: p.name,
            Category: p.category,
            SKU: p.sku,
            'Buying Price': p.buyingPrice,
            'Selling Price': p.sellingPrice,
            Stock: p.stock
        }));
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Products");
        XLSX.writeFile(wb, `products_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
    
    // POS Functions
    function loadPOSProducts() {
        const grid = document.getElementById('posProductGrid');
        grid.innerHTML = '';
        
        if (products.length === 0) {
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <div class="empty-state-title">No Products</div>
                    <div class="empty-state-desc">Add products to start selling</div>
                </div>
            `;
            return;
        }
        
        products.forEach(product => {
            if (product.stock > 0) {
                const card = `
                    <div class="product-card" onclick="addToCart('${product.id}')">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">KES ${product.sellingPrice.toLocaleString()}</div>
                        <div class="product-stock">Stock: ${product.stock}</div>
                    </div>
                `;
                grid.innerHTML += card;
            }
        });
        
        updateCart();
    }
    
    function searchPOSProducts() {
        const searchTerm = document.getElementById('posSearch').value.toLowerCase();
        const grid = document.getElementById('posProductGrid');
        grid.innerHTML = '';
        
        const filteredProducts = products.filter(p => 
            p.name.toLowerCase().includes(searchTerm) && p.stock > 0
        );
        
        if (filteredProducts.length === 0) {
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <div class="empty-state-desc">No products found</div>
                </div>
            `;
            return;
        }
        
        filteredProducts.forEach(product => {
            const card = `
                <div class="product-card" onclick="addToCart('${product.id}')">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">KES ${product.sellingPrice.toLocaleString()}</div>
                    <div class="product-stock">Stock: ${product.stock}</div>
                </div>
            `;
            grid.innerHTML += card;
        });
    }
    
    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        const cartItem = cart.find(item => item.id === productId);
        
        if (cartItem) {
            if (cartItem.quantity < product.stock) {
                cartItem.quantity++;
            } else {
                alert('Insufficient stock');
                return;
            }
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: product.sellingPrice,
                quantity: 1
            });
        }
        
        saveToLocalStorage(STORAGE_KEYS.CART, cart);
        updateCart();
    }
    
    function updateCart() {
        const cartItems = document.getElementById('cartItems');
        const cartItemCount = document.getElementById('cartItemCount');
        
        if (cart.length === 0) {
            cartItems.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <div class="empty-state-desc">Cart is empty</div>
                </div>
            `;
            cartItemCount.textContent = '0 items';
            document.getElementById('cartSubtotal').textContent = 'KES 0';
            document.getElementById('cartTax').textContent = 'KES 0';
            document.getElementById('cartTotal').textContent = 'KES 0';
            return;
        }
        
        cartItems.innerHTML = '';
        let subtotal = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;
            
            const cartItemHTML = `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">KES ${item.price.toLocaleString()} √ó ${item.quantity}</div>
                    </div>
                    <div class="cart-item-qty">
                        <button class="qty-btn" onclick="updateCartQuantity('${item.id}', -1)">-</button>
                        <span class="qty-value">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateCartQuantity('${item.id}', 1)">+</button>
                    </div>
                    <span class="cart-item-remove" onclick="removeFromCart('${item.id}')">√ó</span>
                </div>
            `;
            cartItems.innerHTML += cartItemHTML;
        });
        
        const tax = subtotal * 0.16;
        const total = subtotal + tax;
        
        cartItemCount.textContent = `${cart.length} items`;
        document.getElementById('cartSubtotal').textContent = `KES ${subtotal.toLocaleString()}`;
        document.getElementById('cartTax').textContent = `KES ${tax.toLocaleString()}`;
        document.getElementById('cartTotal').textContent = `KES ${total.toLocaleString()}`;
    }
    
    function updateCartQuantity(productId, change) {
        const cartItem = cart.find(item => item.id === productId);
        const product = products.find(p => p.id === productId);
        
        if (!cartItem || !product) return;
        
        const newQuantity = cartItem.quantity + change;
        
        if (newQuantity <= 0) {
            removeFromCart(productId);
            return;
        }
        
        if (newQuantity > product.stock) {
            alert('Insufficient stock');
            return;
        }
        
        cartItem.quantity = newQuantity;
        saveToLocalStorage(STORAGE_KEYS.CART, cart);
        updateCart();
    }
    
    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        saveToLocalStorage(STORAGE_KEYS.CART, cart);
        updateCart();
    }
    
    function clearCart() {
        if (cart.length === 0) return;
        
        if (confirm('Clear all items from cart?')) {
            cart = [];
            saveToLocalStorage(STORAGE_KEYS.CART, cart);
            updateCart();
        }
    }
    
    function selectPayment(method) {
        document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        selectedPayment = method;
    }
    
    async function completeSale() {
        if (cart.length === 0) {
            alert('Cart is empty');
            return;
        }
        
        if (!selectedPayment) {
            alert('Please select a payment method');
            return;
        }
        
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const tax = subtotal * 0.16;
        const total = subtotal + tax;
        
        const sale = {
            id: Date.now().toString(),
            date: new Date().toISOString(),
            items: cart,
            subtotal: subtotal,
            tax: tax,
            total: total,
            payment: selectedPayment,
            seller: currentUser.name,
            customer: 'Walk-in'
        };
        
        // Update product stock
        cart.forEach(item => {
            const product = products.find(p => p.id === item.id);
            if (product) {
                product.stock -= item.quantity;
            }
        });
        
        sales.push(sale);
        saveToLocalStorage(STORAGE_KEYS.SALES, sales);
        saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);
        
        if (navigator.onLine) {
            try {
                await db.collection('sales').add(sale);
                
                // Update product stock in Firestore
                cart.forEach(async (item) => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        await db.collection('products').doc(item.id).update({
                            stock: product.stock
                        });
                    }
                });
            } catch (error) {
                console.error('Error saving sale to Firestore:', error);
                addToOfflineQueue('sale', sale);
            }
        } else {
            addToOfflineQueue('sale', sale);
        }
        
        alert(`Sale completed!\nTotal: KES ${total.toLocaleString()}\nPayment: ${selectedPayment}`);
        
        cart = [];
        selectedPayment = null;
        saveToLocalStorage(STORAGE_KEYS.CART, cart);
        document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
        updateCart();
        loadPOSProducts();
        updateDashboard();
    }
    
    // Sales
    function loadSales() {
        const table = document.getElementById('salesTable');
        table.innerHTML = '';
        
        if (sales.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-title">No Sales</div>
                        <div class="empty-state-desc">Sales will appear here</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        sales.reverse().forEach(sale => {
            const row = `
                <tr>
                    <td>${new Date(sale.date).toLocaleString()}</td>
                    <td>${sale.customer}</td>
                    <td>${sale.items.length}</td>
                    <td>KES ${sale.total.toLocaleString()}</td>
                    <td><span class="badge info">${sale.payment}</span></td>
                    <td>${sale.seller}</td>
                    <td>
                        <button class="btn btn-icon btn-secondary" onclick="viewSale('${sale.id}')">üëÅÔ∏è</button>
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    function exportSales() {
        const data = sales.map(s => ({
            Date: new Date(s.date).toLocaleString(),
            Customer: s.customer,
            Items: s.items.length,
            Subtotal: s.subtotal,
            Tax: s.tax,
            Total: s.total,
            Payment: s.payment,
            Seller: s.seller
        }));
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sales");
        XLSX.writeFile(wb, `sales_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
    
    // Expenses
    function addExpense() {
        const expense = {
            id: Date.now().toString(),
            category: document.getElementById('expenseCategory').value,
            description: document.getElementById('expenseDescription').value,
            amount: parseFloat(document.getElementById('expenseAmount').value),
            payment: document.getElementById('expensePayment').value,
            date: document.getElementById('expenseDate').value,
            createdAt: new Date().toISOString()
        };
        
        expenses.push(expense);
        saveToLocalStorage(STORAGE_KEYS.EXPENSES, expenses);
        
        if (navigator.onLine) {
            db.collection('expenses').add(expense)
                .catch(err => console.error('Error adding expense:', err));
        }
        
        loadExpenses();
        closeModal('addExpenseModal');
        document.getElementById('addExpenseForm').reset();
    }
    
    function loadExpenses() {
        const table = document.getElementById('expensesTable');
        table.innerHTML = '';
        
        if (expenses.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <div class="empty-state-title">No Expenses</div>
                        <div class="empty-state-desc">Add expenses to track costs</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        expenses.reverse().forEach(expense => {
            const row = `
                <tr>
                    <td>${new Date(expense.date).toLocaleDateString()}</td>
                    <td><span class="badge info">${expense.category}</span></td>
                    <td>${expense.description}</td>
                    <td>KES ${expense.amount.toLocaleString()}</td>
                    <td>${expense.payment}</td>
                    <td>
                        <button class="btn btn-icon btn-secondary" onclick="deleteExpense('${expense.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    function deleteExpense(id) {
        if (confirm('Delete this expense?')) {
            expenses = expenses.filter(e => e.id !== id);
            saveToLocalStorage(STORAGE_KEYS.EXPENSES, expenses);
            
            if (navigator.onLine) {
                db.collection('expenses').doc(id).delete()
                    .catch(err => console.error('Error deleting expense:', err));
            }
            
            loadExpenses();
        }
    }
    
    // Customers
    function addCustomer() {
        const customer = {
            id: Date.now().toString(),
            name: document.getElementById('customerName').value,
            email: document.getElementById('customerEmail').value,
            phone: document.getElementById('customerPhone').value,
            address: document.getElementById('customerAddress').value,
            totalPurchases: 0,
            createdAt: new Date().toISOString()
        };
        
        customers.push(customer);
        saveToLocalStorage(STORAGE_KEYS.CUSTOMERS, customers);
        
        if (navigator.onLine) {
            db.collection('customers').add(customer)
                .catch(err => console.error('Error adding customer:', err));
        }
        
        loadCustomers();
        closeModal('addCustomerModal');
        document.getElementById('addCustomerForm').reset();
    }
    
    function loadCustomers() {
        const table = document.getElementById('customersTable');
        table.innerHTML = '';
        
        if (customers.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div class="empty-state-title">No Customers</div>
                        <div class="empty-state-desc">Add customers to track purchases</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        customers.forEach(customer => {
            const row = `
                <tr>
                    <td><strong>${customer.name}</strong></td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${customer.phone}</td>
                    <td>KES ${customer.totalPurchases.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-icon btn-secondary" onclick="deleteCustomer('${customer.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    function deleteCustomer(id) {
        if (confirm('Delete this customer?')) {
            customers = customers.filter(c => c.id !== id);
            saveToLocalStorage(STORAGE_KEYS.CUSTOMERS, customers);
            
            if (navigator.onLine) {
                db.collection('customers').doc(id).delete()
                    .catch(err => console.error('Error deleting customer:', err));
            }
            
            loadCustomers();
        }
    }
    
    // Users
    function addUser() {
        const user = {
            id: Date.now().toString(),
            name: document.getElementById('newUserName').value,
            email: document.getElementById('newUserEmail').value,
            password: document.getElementById('newUserPassword').value,
            role: document.getElementById('newUserRole').value,
            status: 'active',
            createdAt: new Date().toISOString()
        };
        
        users.push(user);
        saveToLocalStorage(STORAGE_KEYS.USERS, users);
        
        if (navigator.onLine) {
            auth.createUserWithEmailAndPassword(user.email, user.password)
                .then((userCredential) => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name: user.name,
                        email: user.email,
                        role: user.role,
                        status: user.status
                    });
                })
                .catch(err => console.error('Error creating user:', err));
        }
        
        loadUsers();
        closeModal('addUserModal');
        document.getElementById('addUserForm').reset();
    }
    
    function loadUsers() {
        const table = document.getElementById('usersTable');
        table.innerHTML = '';
        
        if (users.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <div class="empty-state-title">No Users</div>
                        <div class="empty-state-desc">Add users to manage access</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        users.forEach(user => {
            const row = `
                <tr>
                    <td><strong>${user.name}</strong></td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'info' : 'success'}">${user.role}</span></td>
                    <td><span class="badge success">${user.status}</span></td>
                    <td>
                        <button class="btn btn-icon btn-secondary" onclick="deleteUser('${user.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    function deleteUser(id) {
        if (confirm('Delete this user?')) {
            users = users.filter(u => u.id !== id);
            saveToLocalStorage(STORAGE_KEYS.USERS, users);
            loadUsers();
        }
    }
    
    // Settings
    function showSettingsTab(tabName) {
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        
        event.currentTarget.classList.add('active');
        document.getElementById(`${tabName}Settings`).classList.add('active');
    }
    
    function saveBusinessSettings() {
        const settings = {
            businessName: document.getElementById('settingsBusinessName').value,
            email: document.getElementById('settingsEmail').value,
            phone: document.getElementById('settingsPhone').value,
            address: document.getElementById('settingsAddress').value
        };
        
        saveToLocalStorage(STORAGE_KEYS.SETTINGS, settings);
        alert('Business settings saved!');
    }
    
    function savePaymentSettings() {
        const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');
        
        settings.mpesa = {
            till: document.getElementById('mpesaTill').value,
            paybill: document.getElementById('mpesaPaybill').value,
            account: document.getElementById('mpesaAccount').value
        };
        
        settings.bank = {
            name: document.getElementById('bankName').value,
            account: document.getElementById('bankAccount').value
        };
        
        saveToLocalStorage(STORAGE_KEYS.SETTINGS, settings);
        alert('Payment settings saved!');
    }
    
    function saveTaxSettings() {
        const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');
        
        settings.tax = {
            vatRate: document.getElementById('vatRate').value,
            pin: document.getElementById('taxPin').value
        };
        
        saveToLocalStorage(STORAGE_KEYS.SETTINGS, settings);
        alert('Tax settings saved!');
    }
    
    // Dashboard Updates
    function updateDashboard() {
        // Today's sales
        const today = new Date().toDateString();
        const todaySales = sales.filter(s => new Date(s.date).toDateString() === today);
        const todayTotal = todaySales.reduce((sum, s) => sum + s.total, 0);
        document.getElementById('todaySales').textContent = `KES ${todayTotal.toLocaleString()}`;
        
        // Total products
        document.getElementById('totalProducts').textContent = products.length;
        
        // Low stock items
        const lowStock = products.filter(p => p.stock <= p.lowStock);
        document.getElementById('lowStockCount').textContent = lowStock.length;
        document.getElementById('lowStockBadge').textContent = lowStock.length;
        
        // Total customers
        document.getElementById('totalCustomers').textContent = customers.length;
        
        // Recent sales table
        const recentTable = document.getElementById('recentSalesTable');
        recentTable.innerHTML = '';
        
        const recentSales = sales.slice(-5).reverse();
        
        if (recentSales.length === 0) {
            recentTable.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <div class="empty-state-title">No Sales Yet</div>
                        <div class="empty-state-desc">Start making sales to see them here</div>
                    </td>
                </tr>
            `;
        } else {
            recentSales.forEach(sale => {
                const row = `
                    <tr>
                        <td>${new Date(sale.date).toLocaleString()}</td>
                        <td>${sale.customer}</td>
                        <td>${sale.items.length}</td>
                        <td>KES ${sale.total.toLocaleString()}</td>
                        <td><span class="badge info">${sale.payment}</span></td>
                        <td><span class="badge success">Completed</span></td>
                    </tr>
                `;
                recentTable.innerHTML += row;
            });
        }
    }
    
    // PWA Installation
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('[PWA] Install prompt available');
    });
    
    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const swCode = `
                const CACHE_NAME = 'biasharaflow-v1';
                const urlsToCache = [
                    './',
                    'https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap',
                    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                    'https://cdn.jsdelivr.net/npm/chart.js'
                ];
                
                self.addEventListener('install', (event) => {
                    console.log('[ServiceWorker] Installing...');
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then((cache) => {
                                console.log('[ServiceWorker] Caching app shell');
                                return cache.addAll(urlsToCache);
                            })
                            .then(() => self.skipWaiting())
                    );
                });
                
                self.addEventListener('activate', (event) => {
                    console.log('[ServiceWorker] Activating...');
                    event.waitUntil(
                        caches.keys().then((cacheNames) => {
                            return Promise.all(
                                cacheNames.map((cacheName) => {
                                    if (cacheName !== CACHE_NAME) {
                                        console.log('[ServiceWorker] Removing old cache:', cacheName);
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        }).then(() => self.clients.claim())
                    );
                });
                
                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request)
                            .then((response) => {
                                if (response) {
                                    return response;
                                }
                                
                                const fetchRequest = event.request.clone();
                                
                                return fetch(fetchRequest).then((response) => {
                                    if (!response || response.status !== 200 || response.type !== 'basic') {
                                        return response;
                                    }
                                    
                                    const responseToCache = response.clone();
                                    
                                    caches.open(CACHE_NAME).then((cache) => {
                                        cache.put(event.request, responseToCache);
                                    });
                                    
                                    return response;
                                }).catch(() => {
                                    return caches.match(event.request);
                                });
                            })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(() => console.log('[PWA] Service Worker registered - Offline mode available'))
                .catch((err) => console.log('[PWA] Service worker registration failed:', err));
        });
    }
    
    // Online/Offline Status Monitoring
    function updateOnlineStatus() {
        const isOnline = navigator.onLine;
        const offlineBanner = document.getElementById('offlineBanner');
        const syncStatus = document.getElementById('syncStatus');
        const syncText = document.getElementById('syncText');
        
        if (isOnline) {
            if (offlineBanner) offlineBanner.classList.add('hidden');
            if (syncStatus) {
                syncStatus.classList.remove('offline');
                syncStatus.classList.add('online');
            }
            if (syncText) syncText.textContent = 'Online';
            console.log('[Status] Online - Data will sync');
            
            // Sync offline queue when coming back online
            syncOfflineQueue();
        } else {
            if (offlineBanner) offlineBanner.classList.remove('hidden');
            if (syncStatus) {
                syncStatus.classList.remove('online');
                syncStatus.classList.add('offline');
            }
            if (syncText) syncText.textContent = 'Offline';
            console.log('[Status] Offline - Working locally');
        }
    }
    
    // Monitor connection status
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    window.addEventListener('load', updateOnlineStatus);
    
</script>
