<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Complete POS and Business Management System">
    <title>BiasharaFlow POS - Complete Business Management</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQmlhc2hhcmFGbG93IFBPUyIsInNob3J0X25hbWUiOiJCaWFzaGFyYUZsb3ciLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwYTBlMWEiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJkZXNjcmlwdGlvbiI6IkNvbXBsZXRlIFBPUyBhbmQgQnVzaW5lc3MgTWFuYWdlbWVudCBTeXN0ZW0iLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyUzRSUzQ3JlY3Qgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIGZpbGw9JyUyMzNiODJmNicgcng9JzQwJy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1zaXplPSc5MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZHk9Jy4zNWVtJyUzRfCfk7olM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifSx7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMiclM0UlM0NyZWN0IHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyBmaWxsPSclMjMzYjgyZjYnIHJ4PScxMDAnLyUzRSUzQ3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBmb250LXNpemU9JzI0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZHk9Jy4zNWVtJyUzRfCfk7olM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV0sImNhdGVnb3JpZXMiOlsiYnVzaW5lc3MiLCJmaW5hbmNlIiwicHJvZHVjdGl2aXR5Il0sImxhbmciOiJlbiJ9">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect width='180' height='180' fill='%233b82f6' rx='40'/%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dy='.35em'%3EðŸ“Š%3C/text%3E%3C/svg%3E">
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-dark:#0a0e1a;--bg-card:#111827;--bg-card-hover:#1a2234;--bg-sidebar:#0d1320;--border:#1e293b;--border-light:#334155;--text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;--accent-blue:#3b82f6;--accent-green:#10b981;--accent-emerald:#059669;--accent-yellow:#f59e0b;--accent-orange:#f97316;--accent-red:#ef4444;--accent-purple:#8b5cf6;--accent-pink:#ec4899;--accent-cyan:#06b6d4;--gradient-blue:linear-gradient(135deg,#3b82f6,#1d4ed8);--gradient-green:linear-gradient(135deg,#10b981,#059669);--gradient-purple:linear-gradient(135deg,#8b5cf6,#6d28d9);--gradient-orange:linear-gradient(135deg,#f97316,#ea580c);--gradient-red:linear-gradient(135deg,#ef4444,#dc2626);--gradient-cyan:linear-gradient(135deg,#06b6d4,#0891b2);--shadow-sm:0 1px 2px rgba(0,0,0,0.4);--shadow-md:0 4px 6px rgba(0,0,0,0.4);--shadow-lg:0 10px 15px rgba(0,0,0,0.5);--shadow-glow-blue:0 0 20px rgba(59,130,246,0.3);--shadow-glow-green:0 0 20px rgba(16,185,129,0.3);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:20px}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;overflow-x:auto;-webkit-overflow-scrolling:touch}
        
        /* Login Screen */
        .login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0a0e1a 0%,#1e1b4b 50%,#0f172a 100%);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;overflow-y:auto}
        .login-screen.hidden{display:none}
        .login-container{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);padding:40px;width:100%;max-width:420px;text-align:center;margin:auto;max-height:90vh;overflow-y:auto}
        .login-logo{font-size:4rem;margin-bottom:16px}
        .login-title{font-size:1.8rem;font-weight:800;margin-bottom:4px;background:linear-gradient(135deg,#fff,#94a3b8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .login-subtitle{color:var(--text-muted);font-size:.9rem;margin-bottom:32px}
        .login-form{text-align:left}
        .login-input-group{margin-bottom:20px}
        .login-label{display:block;font-size:.85rem;font-weight:600;margin-bottom:8px;color:var(--text-secondary)}
        .login-input{width:100%;padding:14px 16px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-size:1rem}
        .login-input:focus{outline:none;border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(59,130,246,0.2)}
        .login-input::placeholder{color:var(--text-muted)}
        .login-select{width:100%;padding:14px 16px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-size:1rem;cursor:pointer}
        .login-btn{width:100%;padding:16px;background:var(--gradient-blue);border:none;border-radius:var(--radius-md);color:white;font-size:1rem;font-weight:700;cursor:pointer;margin-top:8px;box-shadow:var(--shadow-glow-blue);transition:transform .2s}
        .login-btn:hover{transform:translateY(-2px)}
        .login-divider{display:flex;align-items:center;margin:24px 0;color:var(--text-muted);font-size:.85rem}
        .login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border)}
        .login-divider span{padding:0 16px}
        .demo-accounts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .demo-btn{padding:12px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;text-align:center}
        .demo-btn:hover{border-color:var(--accent-blue);background:var(--bg-card-hover)}
        .demo-btn-icon{font-size:1.5rem;margin-bottom:4px}
        .demo-btn-role{font-size:.8rem;font-weight:600;color:var(--text-primary)}
        .demo-btn-desc{font-size:.7rem;color:var(--text-muted)}
        .demo-btn.admin{border-color:var(--accent-purple)}
        .demo-btn.seller{border-color:var(--accent-green)}
        .demo-credentials{margin-top:16px;padding:12px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);border-radius:var(--radius-sm);font-size:.75rem;text-align:left}
        .demo-credentials-title{font-weight:600;color:var(--accent-blue);margin-bottom:6px}
        .demo-credentials-item{color:var(--text-secondary);margin:4px 0;font-family:'JetBrains Mono',monospace}
        .login-footer{margin-top:20px;text-align:center;font-size:.85rem}
        .login-link{color:var(--accent-blue);cursor:pointer;text-decoration:none;transition:all .2s}
        .login-link:hover{color:var(--accent-cyan);text-decoration:underline}
        .auth-screen{display:none}
        .auth-screen.active{display:block}
        .back-btn{display:inline-flex;align-items:center;gap:6px;color:var(--text-muted);cursor:pointer;font-size:.85rem;margin-bottom:16px;transition:color .2s}
        .back-btn:hover{color:var(--text-primary)}
        
        /* Main App Container */
        .app-container{display:flex;min-height:100vh}
        .app-container.hidden{display:none}
        
        /* Sidebar */
        .sidebar{width:260px;background:var(--bg-sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s;overflow-y:auto}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:44px;height:44px;background:var(--gradient-blue);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:var(--shadow-glow-blue)}
        .logo-text{font-size:1.3rem;font-weight:800;background:linear-gradient(135deg,#fff,#94a3b8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .logo-subtitle{font-size:.7rem;color:var(--text-muted);font-weight:500}
        .sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto}
        .nav-section{margin-bottom:24px}
        .nav-section-title{font-size:.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;padding:0 12px;margin-bottom:8px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:var(--radius-md);cursor:pointer;transition:all .2s;margin-bottom:4px;color:var(--text-secondary);font-weight:500;font-size:.9rem}
        .nav-item:hover{background:var(--bg-card);color:var(--text-primary)}
        .nav-item.active{background:var(--accent-blue);color:white;box-shadow:var(--shadow-glow-blue)}
        .nav-item.disabled{opacity:.4;pointer-events:none}
        .nav-item-icon{width:22px;text-align:center;font-size:1.1rem}
        .nav-badge{margin-left:auto;background:var(--accent-red);color:white;font-size:.65rem;font-weight:700;padding:2px 8px;border-radius:10px}
        .nav-badge.warning{background:var(--accent-yellow);color:#000}
        .nav-badge.info{background:var(--accent-blue)}
        .sidebar-footer{padding:16px;border-top:1px solid var(--border)}
        .sidebar-company{text-align:center;font-size:.65rem;color:var(--text-muted);margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
        .user-profile{display:flex;align-items:center;gap:12px;padding:12px;border-radius:var(--radius-md);background:var(--bg-card);cursor:pointer;transition:all .2s}
        .user-profile:hover{background:var(--bg-card-hover)}
        .user-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem}
        .user-avatar.admin{background:var(--gradient-purple)}
        .user-avatar.seller{background:var(--gradient-green)}
        .user-info{flex:1}
        .user-name{font-weight:600;font-size:.9rem}
        .user-role{font-size:.7rem;color:var(--text-muted)}
        .user-role.admin{color:var(--accent-purple)}
        .user-role.seller{color:var(--accent-green)}
        .logout-btn{background:transparent;border:none;color:var(--text-muted);cursor:pointer;padding:8px;border-radius:var(--radius-sm);transition:all .2s}
        .logout-btn:hover{color:var(--accent-red);background:rgba(239,68,68,.1)}
        
        /* Main Content */
        .main-content{flex:1;margin-left:260px;min-height:100vh;display:flex;flex-direction:column;overflow-x:auto;-webkit-overflow-scrolling:touch}
        .top-bar{height:64px;background:var(--bg-sidebar);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:50}
        .top-bar-left{display:flex;align-items:center;gap:16px}
        .mobile-menu-btn{display:none;width:40px;height:40px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);align-items:center;justify-content:center;cursor:pointer;color:var(--text-primary);font-size:1.2rem}
        .page-title{font-size:1.2rem;font-weight:700}
        .page-subtitle{font-size:.75rem;color:var(--text-muted)}
        .top-bar-right{display:flex;align-items:center;gap:12px}
        .search-box{display:flex;align-items:center;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:8px 16px;gap:10px;width:280px}
        .search-box input{background:transparent;border:none;color:var(--text-primary);font-size:.85rem;width:100%;outline:none}
        .search-box input::placeholder{color:var(--text-muted)}
        .top-btn{width:40px;height:40px;border:1px solid var(--border);background:var(--bg-card);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);transition:all .2s;position:relative}
        .top-btn:hover{background:var(--bg-card-hover);color:var(--text-primary)}
        .sync-status{display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);font-size:.85rem;font-weight:500}
        .sync-status.online{color:var(--accent-green);border-color:rgba(16,185,129,0.3)}
        .sync-status.offline{color:var(--accent-yellow);border-color:rgba(245,158,11,0.3)}
        .sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .notification-dot{position:absolute;top:8px;right:8px;width:8px;height:8px;background:var(--accent-red);border-radius:50%}
        .current-time{font-size:.85rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
        .page-content{flex:1;padding:24px;overflow-y:auto;overflow-x:auto;height:calc(100vh - 64px);-webkit-overflow-scrolling:touch}
        
        /* Tab Content */
        .tab-content{display:none;overflow-x:auto;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .tab-content.active{display:block;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* Dashboard Stats */
        .welcome-section{margin-bottom:24px}
        .welcome-title{font-size:1.6rem;font-weight:800;margin-bottom:4px}
        .welcome-subtitle{color:var(--text-secondary);font-size:.9rem}
        .date-filter-bar{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
        .date-btn{padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;color:var(--text-secondary);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s}
        .date-btn:hover{border-color:var(--accent-blue)}
        .date-btn.active{background:var(--accent-blue);border-color:var(--accent-blue);color:white}
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
        .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;position:relative;overflow:hidden;transition:all .2s}
        .stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
        .stat-card.blue::before{background:var(--gradient-blue)}
        .stat-card.green::before{background:var(--gradient-green)}
        .stat-card.purple::before{background:var(--gradient-purple)}
        .stat-card.orange::before{background:var(--gradient-orange)}
        .stat-card.red::before{background:var(--gradient-red)}
        .stat-card.cyan::before{background:var(--gradient-cyan)}
        .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
        .stat-label{font-size:.8rem;color:var(--text-secondary);font-weight:500}
        .stat-icon{width:40px;height:40px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .stat-icon.blue{background:rgba(59,130,246,.15);color:var(--accent-blue)}
        .stat-icon.green{background:rgba(16,185,129,.15);color:var(--accent-green)}
        .stat-icon.purple{background:rgba(139,92,246,.15);color:var(--accent-purple)}
        .stat-icon.orange{background:rgba(249,115,22,.15);color:var(--accent-orange)}
        .stat-icon.red{background:rgba(239,68,68,.15);color:var(--accent-red)}
        .stat-icon.cyan{background:rgba(6,182,212,.15);color:var(--accent-cyan)}
        .stat-value{font-size:1.8rem;font-weight:800;font-family:'JetBrains Mono',monospace;margin-bottom:4px}
        .stat-change{font-size:.75rem;display:flex;align-items:center;gap:4px}
        .stat-change.up{color:var(--accent-green)}
        .stat-change.down{color:var(--accent-red)}
        .stat-change.neutral{color:var(--text-muted)}
        
        /* Quick Actions */
        .quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
        .quick-action-btn{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center}
        .quick-action-btn:hover{border-color:var(--accent-blue);transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .quick-action-btn.primary{background:var(--gradient-blue);border:none;color:white}
        .quick-action-btn.success{background:var(--gradient-green);border:none;color:white}
        .quick-action-btn.warning{background:var(--gradient-orange);border:none;color:white}
        .quick-action-btn.danger{background:var(--gradient-red);border:none;color:white}
        .quick-action-btn.purple{background:var(--gradient-purple);border:none;color:white}
        .quick-action-icon{font-size:1.8rem}
        .quick-action-label{font-size:.85rem;font-weight:600}
        
        /* Dashboard Grid */
        .dashboard-grid{display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-bottom:24px}
        .dashboard-grid-full{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px;overflow-x:auto;-webkit-overflow-scrolling:touch}
        .dashboard-grid-triple{display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px;margin-bottom:24px}
        
        /* Cards */
        .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;min-width:300px}
        .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .card-title{font-size:1rem;font-weight:700;display:flex;align-items:center;gap:10px}
        .card-title-icon{width:10px;height:10px;border-radius:50%}
        .card-action{font-size:.8rem;color:var(--accent-blue);cursor:pointer;font-weight:600}
        .card-body{padding:20px;overflow-x:auto;-webkit-overflow-scrolling:touch}
        .card-body.no-padding{padding:0;overflow-x:visible}
        
        /* Breakdown Lists */
        .breakdown-list{display:flex;flex-direction:column;gap:10px}
        .breakdown-item{display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--bg-dark);border-radius:var(--radius-sm);transition:all .2s}
        .breakdown-item:hover{background:var(--bg-card-hover)}
        .breakdown-left{display:flex;align-items:center;gap:12px}
        .breakdown-icon{width:36px;height:36px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1rem}
        .breakdown-label{font-size:.85rem;color:var(--text-secondary)}
        .breakdown-sublabel{font-size:.7rem;color:var(--text-muted)}
        .breakdown-value{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:.95rem}
        
        /* Charts */
        .chart-container{position:relative;height:250px}
        .chart-container.small{height:180px}
        .chart-container.large{height:350px}
        
        /* KRA Section */
        .kra-status-card{background:linear-gradient(135deg,#059669,#047857);border-radius:var(--radius-lg);padding:20px;color:white;margin-bottom:24px}
        .kra-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .kra-title{font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:10px}
        .kra-badge{background:rgba(255,255,255,.2);padding:4px 12px;border-radius:12px;font-size:.75rem;font-weight:600}
        .kra-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
        .kra-stat{background:rgba(255,255,255,.1);padding:14px;border-radius:var(--radius-sm);text-align:center}
        .kra-stat-value{font-size:1.3rem;font-weight:800;font-family:'JetBrains Mono',monospace}
        .kra-stat-label{font-size:.7rem;opacity:.8;margin-top:4px}
        
        /* Tables */
        .table-container{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
        .data-table{width:100%;border-collapse:collapse}
        .data-table th{text-align:left;padding:14px 16px;font-size:.75rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;background:var(--bg-dark);border-bottom:1px solid var(--border)}
        .data-table td{padding:14px 16px;font-size:.85rem;border-bottom:1px solid var(--border)}
        .data-table tr:hover{background:var(--bg-card-hover)}
        .data-table tr:last-child td{border-bottom:none}
        .table-status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:12px;font-size:.75rem;font-weight:600}
        .table-status.success{background:rgba(16,185,129,.15);color:var(--accent-green)}
        .table-status.warning{background:rgba(245,158,11,.15);color:var(--accent-yellow)}
        .table-status.danger{background:rgba(239,68,68,.15);color:var(--accent-red)}
        .table-status.info{background:rgba(59,130,246,.15);color:var(--accent-blue)}
        .action-btn{padding:6px 12px;border-radius:var(--radius-sm);font-size:.75rem;font-weight:600;cursor:pointer;border:none;margin-right:4px;transition:all .2s}
        .action-btn:hover{transform:translateY(-1px)}
        .action-btn.primary{background:rgba(59,130,246,.15);color:var(--accent-blue)}
        .action-btn.success{background:rgba(16,185,129,.15);color:var(--accent-green)}
        .action-btn.warning{background:rgba(245,158,11,.15);color:var(--accent-yellow)}
        .action-btn.danger{background:rgba(239,68,68,.15);color:var(--accent-red)}
        /* POS Styles */
        .pos-layout{display:grid;grid-template-columns:1fr 400px;gap:24px;height:calc(100vh - 140px)}
        .pos-products{display:flex;flex-direction:column;overflow:hidden}
        .pos-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .pos-search{flex:1;max-width:400px}
        .pos-search input{width:100%;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-size:.9rem}
        .pos-categories{display:flex;gap:8px;padding-bottom:16px;overflow-x:auto;flex-shrink:0}
        .category-chip{padding:10px 20px;background:var(--bg-card);border:1px solid var(--border);border-radius:25px;color:var(--text-secondary);font-weight:600;font-size:.85rem;cursor:pointer;white-space:nowrap;transition:all .2s}
        .category-chip:hover{border-color:var(--accent-blue);color:var(--text-primary)}
        .category-chip.active{background:var(--accent-blue);border-color:var(--accent-blue);color:white}
        .pos-product-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;overflow-y:auto;padding:4px;align-content:start}
        .product-card{background:var(--bg-card);border:2px solid var(--border);border-radius:var(--radius-md);padding:16px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;text-align:center}
        .product-card:hover{border-color:var(--accent-blue);transform:translateY(-2px);box-shadow:var(--shadow-glow-blue)}
        .product-card.low-stock{border-color:var(--accent-yellow);background:rgba(245,158,11,.03)}
        .product-card.out-of-stock{border-color:var(--accent-red);background:rgba(239,68,68,.03);opacity:.6;pointer-events:none}
        .product-emoji{font-size:2.8rem;margin-bottom:10px}
        .product-name{font-weight:600;font-size:.85rem;margin-bottom:6px;line-height:1.3}
        .sku-code{font-size:.7rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace;margin-bottom:4px}
        .product-price{font-weight:800;color:var(--accent-blue);font-family:'JetBrains Mono',monospace;font-size:1rem}
        .product-stock{font-size:.7rem;color:var(--text-muted);margin-top:6px;padding:2px 8px;background:var(--bg-dark);border-radius:10px}
        .product-stock.low{color:var(--accent-yellow);background:rgba(245,158,11,.1)}
        .product-stock.out{color:var(--accent-red);background:rgba(239,68,68,.1)}
        
        /* Cart Panel */
        .pos-cart{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);display:flex;flex-direction:column;height:100%;overflow:hidden}
        .cart-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--bg-dark)}
        .cart-title{font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:10px}
        .cart-count{background:var(--accent-blue);color:white;padding:4px 12px;border-radius:12px;font-size:.8rem;font-weight:700}
        .cart-clear-btn{background:transparent;border:1px solid var(--border);color:var(--text-secondary);padding:8px 14px;border-radius:var(--radius-sm);cursor:pointer;font-size:.8rem;font-weight:600;transition:all .2s}
        .cart-clear-btn:hover{border-color:var(--accent-red);color:var(--accent-red)}
        .cart-items{flex:1;overflow-y:auto;padding:16px}
        .cart-empty{text-align:center;padding:50px 20px;color:var(--text-muted)}
        .cart-empty-icon{font-size:4rem;margin-bottom:16px;opacity:.5}
        .cart-empty-text{font-size:.95rem;margin-bottom:4px}
        .cart-empty-hint{font-size:.8rem}
        .cart-item{background:var(--bg-dark);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
        .cart-item-info{flex:1}
        .cart-item-name{font-weight:600;font-size:.9rem;margin-bottom:4px}
        .cart-item-price{font-size:.8rem;color:var(--text-muted)}
        .cart-item-controls{display:flex;align-items:center;gap:10px}
        .qty-btn{width:32px;height:32px;border:none;border-radius:8px;cursor:pointer;font-size:1.1rem;font-weight:700;display:flex;align-items:center;justify-content:center;transition:all .2s}
        .qty-btn.minus{background:var(--bg-card);color:var(--text-secondary);border:1px solid var(--border)}
        .qty-btn.minus:hover{border-color:var(--accent-red);color:var(--accent-red)}
        .qty-btn.plus{background:var(--accent-blue);color:white}
        .qty-btn.plus:hover{background:#2563eb}
        .cart-item-qty{font-weight:700;min-width:28px;text-align:center;font-size:1rem}
        .cart-item-total{font-weight:700;font-family:'JetBrains Mono',monospace;min-width:90px;text-align:right;color:var(--accent-green);font-size:.95rem}
        .cart-item-remove{background:transparent;border:none;color:var(--text-muted);cursor:pointer;padding:6px;margin-left:8px;font-size:1.1rem;transition:all .2s}
        .cart-item-remove:hover{color:var(--accent-red)}
        
        /* Cart Footer */
        .cart-footer{padding:20px;border-top:1px solid var(--border);background:var(--bg-dark);max-height:50vh;overflow-y:auto;overflow-x:auto;-webkit-overflow-scrolling:touch}
        .cart-totals{margin-bottom:16px}
        .cart-row{display:flex;justify-content:space-between;padding:8px 0;font-size:.9rem}
        .cart-row.subtotal{color:var(--text-secondary)}
        .cart-row.tax{color:var(--text-muted);font-size:.85rem}
        .cart-row.total{font-size:1.4rem;font-weight:800;padding-top:14px;margin-top:10px;border-top:2px dashed var(--border)}
        .cart-row.total span:last-child{color:var(--accent-green);font-family:'JetBrains Mono',monospace}
        
        /* Payment Methods */
        .payment-section{margin-bottom:16px}
        .payment-label{font-size:.75rem;font-weight:600;color:var(--text-muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}
        .payment-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
        .pay-btn{padding:14px 8px;background:var(--bg-card);border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:all .2s}
        .pay-btn:hover{border-color:var(--accent-blue)}
        .pay-btn.active{border-color:var(--accent-green);background:rgba(16,185,129,.1)}
        .pay-btn.mpesa-pending{border-color:var(--accent-yellow);background:rgba(245,158,11,.1);animation:pulse 2s infinite}
        .pay-btn.mpesa-confirmed{border-color:var(--accent-green);background:rgba(16,185,129,.15)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
        .pay-icon{font-size:1.5rem;display:block;margin-bottom:6px}
        .pay-label{font-size:.8rem;font-weight:600;color:var(--text-secondary)}
        .pay-btn.active .pay-label{color:var(--accent-green)}
        
        /* M-Pesa Panel */
        .mpesa-panel{background:linear-gradient(135deg,#059669,#047857);border-radius:var(--radius-md);padding:16px;margin-bottom:16px;display:none}
        .mpesa-panel.show{display:block;animation:slideDown .3s ease}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .mpesa-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .mpesa-title{font-weight:700;font-size:.95rem;color:white;display:flex;align-items:center;gap:8px}
        .mpesa-status{display:flex;align-items:center;gap:6px;font-size:.8rem;color:rgba(255,255,255,.9)}
        .mpesa-dot{width:8px;height:8px;background:white;border-radius:50%;animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        .mpesa-input{width:100%;padding:12px 14px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);border-radius:var(--radius-sm);color:white;font-size:.95rem;margin-bottom:12px}
        .mpesa-input::placeholder{color:rgba(255,255,255,.6)}
        .stk-push-btn{width:100%;padding:14px;background:white;color:#059669;border:none;border-radius:var(--radius-sm);font-weight:700;cursor:pointer;font-size:.95rem;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}
        .stk-push-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
        .stk-push-btn:disabled{opacity:.7;cursor:not-allowed;transform:none}
        .mpesa-confirmation{background:rgba(255,255,255,.2);padding:14px;border-radius:var(--radius-sm);margin-top:12px;display:none}
        .mpesa-confirmation.show{display:block}
        .mpesa-confirm-row{display:flex;justify-content:space-between;font-size:.85rem;color:white;padding:4px 0}
        
        /* Complete Sale Button */
        .complete-sale-btn{width:100%;padding:18px;background:var(--gradient-green);border:none;border-radius:var(--radius-md);color:white;font-size:1.1rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:var(--shadow-glow-green);transition:all .2s}
        .complete-sale-btn:hover{transform:translateY(-2px)}
        .complete-sale-btn:disabled{background:var(--bg-card);box-shadow:none;cursor:not-allowed;opacity:.6}
        /* Inventory Styles */
        .inventory-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}
        .inventory-title{font-size:1.3rem;font-weight:700}
        .inventory-actions{display:flex;gap:10px;flex-wrap:wrap}
        .inv-btn{padding:10px 18px;border-radius:var(--radius-sm);font-weight:600;font-size:.85rem;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s;border:none}
        .inv-btn.primary{background:var(--gradient-blue);color:white}
        .inv-btn.success{background:var(--gradient-green);color:white}
        .inv-btn.secondary{background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary)}
        .inv-btn:hover{transform:translateY(-1px)}
        .inventory-filters{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
        .filter-select{padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:.85rem;min-width:150px}
        .filter-input{flex:1;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:.85rem;min-width:200px}
        
        /* Restock Banner */
        .restock-banner{background:var(--gradient-orange);padding:16px 24px;border-radius:var(--radius-md);margin-bottom:20px;display:none;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;color:white}
        .restock-banner.show{display:flex}
        .restock-banner-info{display:flex;align-items:center;gap:14px}
        .restock-banner-icon{font-size:2rem}
        .restock-banner-text h4{font-weight:700;font-size:1rem;margin-bottom:2px}
        .restock-banner-text p{font-size:.85rem;opacity:.9}
        .exit-restock-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:white;padding:10px 20px;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;font-size:.9rem;transition:all .2s}
        .exit-restock-btn:hover{background:rgba(255,255,255,.3)}
        
        /* Inventory Grid */
        .inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px;margin-bottom:20px}
        .inventory-card{background:var(--bg-card);border:2px solid var(--border);border-radius:var(--radius-md);padding:18px;cursor:pointer;transition:all .2s;text-align:center}
        .inventory-card:hover{border-color:var(--accent-blue);transform:translateY(-2px)}
        .inventory-card.low{border-color:var(--accent-yellow)}
        .inventory-card.out{border-color:var(--accent-red)}
        .inventory-card-emoji{font-size:2.2rem;margin-bottom:10px}
        .inventory-card-name{font-weight:600;font-size:.9rem;margin-bottom:6px}
        .inventory-card-stock{display:inline-block;padding:4px 12px;border-radius:12px;font-size:.8rem;font-weight:700}
        .inventory-card-stock.normal{background:rgba(16,185,129,.15);color:var(--accent-green)}
        .inventory-card-stock.low{background:rgba(245,158,11,.15);color:var(--accent-yellow)}
        .inventory-card-stock.out{background:rgba(239,68,68,.15);color:var(--accent-red)}
        
        /* Modals */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;opacity:0;visibility:hidden;transition:all .3s;overflow-y:auto}
        .modal-overlay.show{opacity:1;visibility:visible}
        .modal{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);width:100%;max-width:480px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;transform:scale(.9);transition:transform .3s;margin:auto}
        .modal.large{max-width:600px}
        .modal-overlay.show .modal{transform:scale(1)}
        .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:1.15rem;font-weight:700;display:flex;align-items:center;gap:10px}
        .modal-close{width:36px;height:36px;background:var(--bg-dark);border:none;border-radius:50%;color:var(--text-secondary);cursor:pointer;font-size:1.3rem;display:flex;align-items:center;justify-content:center;transition:all .2s}
        .modal-close:hover{color:var(--text-primary);background:var(--bg-card-hover)}
        .modal-body{padding:24px;overflow-y:auto;overflow-x:auto;max-height:calc(80vh - 160px);-webkit-overflow-scrolling:touch}
        .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;background:var(--bg-dark)}
        .modal-btn{flex:1;padding:14px;border-radius:var(--radius-sm);font-weight:600;cursor:pointer;transition:all .2s;font-size:.95rem;border:none}
        .modal-btn.cancel{background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary)}
        .modal-btn.primary{background:var(--gradient-blue);color:white}
        .modal-btn.success{background:var(--gradient-green);color:white}
        .modal-btn.danger{background:var(--gradient-red);color:white}
        .modal-btn:hover{transform:translateY(-1px)}
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Reduce all font sizes for mobile */
            body{font-size:13px}
            .login-title{font-size:1.4rem}
            .login-subtitle{font-size:.8rem}
            .login-input{padding:12px 14px;font-size:.9rem}
            .login-btn{padding:14px;font-size:.9rem}
            .demo-btn{padding:10px}
            .demo-btn-icon{font-size:1.3rem}
            .demo-btn-role{font-size:.75rem}
            .demo-btn-desc{font-size:.65rem}
            .demo-credentials{font-size:.7rem}
            
            /* Sidebar */
            .sidebar{width:100%;transform:translateX(-100%);position:fixed;z-index:1000}
            .sidebar.show{transform:translateX(0)}
            .main-content{margin-left:0}
            .mobile-menu-btn{display:flex}
            
            /* Top bar */
            .top-bar{padding:0 12px;height:56px}
            .page-title{font-size:1rem}
            .search-box{display:none}
            
            /* Stats grid */
            .stats-grid{grid-template-columns:1fr 1fr;gap:10px}
            .stat-card{padding:14px}
            .stat-label{font-size:.7rem}
            .stat-value{font-size:1.3rem}
            .stat-icon{font-size:1.5rem}
            .stat-change{font-size:.65rem}
            
            /* Content sections */
            .section-header{flex-direction:column;align-items:flex-start;gap:12px}
            .section-actions{width:100%}
            .btn{padding:10px 14px;font-size:.8rem}
            
            /* POS Layout */
            .pos-layout{grid-template-columns:1fr;gap:16px;height:auto}
            .pos-cart{position:fixed;bottom:0;left:0;right:0;height:70vh;border-radius:var(--radius-lg) var(--radius-lg) 0 0;z-index:100;transform:translateY(calc(100% - 60px));transition:transform .3s;display:flex;flex-direction:column}
            .pos-cart.expanded{transform:translateY(0);box-shadow:0 -4px 20px rgba(0,0,0,0.5)}
            .cart-header{cursor:pointer;flex-shrink:0}
            .cart-items{flex:1;overflow-y:auto;min-height:0}
            .cart-footer{flex-shrink:0;max-height:50vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
            .pos-product-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;max-height:calc(100vh - 200px)}
            .product-card{padding:12px}
            .product-emoji{font-size:2rem}
            .product-name{font-size:.75rem}
            .product-price{font-size:.9rem}
            
            /* Tables */
            .data-table{font-size:.75rem}
            .data-table th,.data-table td{padding:10px 8px;font-size:.75rem}
            
            /* Modal */
            .modal{width:95%;max-width:95%;margin:20px}
            .modal-body{max-height:calc(70vh - 140px);padding:16px;overflow-x:auto}
            .modal-header{padding:14px 16px}
            .modal-footer{padding:12px 16px;flex-direction:column}
            .modal-btn{width:100%}
            
            /* Form elements */
            .form-input,.form-select,.form-textarea{font-size:.85rem;padding:10px 12px}
            .form-row{grid-template-columns:1fr}
            
            /* Make payment options section portrait on mobile */
            .payment-options-section .form-row{grid-template-columns:1fr !important}
            
            /* Charts */
            .chart-container{height:250px}
            
            /* Content wrapper padding */
            .content-wrapper{padding:16px 12px}
            
            /* Toast notifications */
            .toast{min-width:280px;font-size:.85rem}
            .toast-title{font-size:.85rem}
            .toast-message{font-size:.75rem}
            
            /* Payment grid */
            .payment-grid{grid-template-columns:1fr 1fr;gap:6px}
            .pay-btn{padding:10px 6px;font-size:.75rem}
            
            /* Hide bottom nav on desktop */
            .bottom-nav{display:none}
        }
        
        @media (max-width: 768px) {
            /* Show bottom nav on mobile */
            .bottom-nav{display:flex}
            .main-content{padding-bottom:70px}
        }
        
        /* Form Elements */
        .form-group{margin-bottom:18px}
        .form-label{display:block;font-size:.85rem;font-weight:600;margin-bottom:8px;color:var(--text-secondary)}
        .form-input,.form-select,.form-textarea{width:100%;padding:12px 14px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:.95rem;transition:all .2s}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
        .form-input::placeholder{color:var(--text-muted)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        .form-hint{font-size:.75rem;color:var(--text-muted);margin-top:6px}
        
        /* Make payment options section portrait (single column) on all devices */
        .payment-options-section .form-row{grid-template-columns:1fr !important}
        
        /* Make settings cards narrower on desktop so payment options are visible */
        #settingsTab .dashboard-grid-full{grid-template-columns:1fr;max-width:1400px}
        #settingsTab .dashboard-grid-full > .card{max-width:700px}
        
        /* Quick Add Modal */
        .quick-add-product{text-align:center;margin-bottom:24px}
        .quick-add-emoji{font-size:4rem;margin-bottom:12px}
        .quick-add-name{font-size:1.2rem;font-weight:700;margin-bottom:6px}
        .quick-add-price{color:var(--text-secondary);font-size:1rem}
        .quick-qty-controls{display:flex;align-items:center;justify-content:center;gap:24px;margin-bottom:24px}
        .quick-qty-btn{width:56px;height:56px;border-radius:50%;border:none;font-size:1.8rem;font-weight:700;cursor:pointer;transition:all .2s}
        .quick-qty-btn.minus{background:var(--bg-dark);color:var(--text-secondary);border:2px solid var(--border)}
        .quick-qty-btn.minus:hover{border-color:var(--accent-red);color:var(--accent-red)}
        .quick-qty-btn.plus{background:var(--gradient-blue);color:white}
        .quick-qty-btn.plus:hover{transform:scale(1.05)}
        .quick-qty-display{font-size:3rem;font-weight:800;min-width:80px;text-align:center}
        .quick-total{text-align:center;font-size:1.3rem;margin-bottom:24px;padding:16px;background:var(--bg-dark);border-radius:var(--radius-md)}
        .quick-total span{font-weight:800;color:var(--accent-green);font-family:'JetBrains Mono',monospace}
        
        /* Restock Modal */
        .restock-current{display:inline-block;background:var(--bg-dark);padding:12px 24px;border-radius:var(--radius-md);margin-bottom:20px}
        .restock-current-label{font-size:.8rem;color:var(--text-muted)}
        .restock-current-value{font-size:1.8rem;font-weight:800;color:var(--accent-blue)}
        .restock-quick-btns{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
        .restock-quick-btn{padding:10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;font-weight:600;transition:all .2s}
        .restock-quick-btn:hover{border-color:var(--accent-blue);color:var(--accent-blue)}
        .restock-new-total{text-align:center;padding:18px;background:rgba(16,185,129,.1);border-radius:var(--radius-md);border:1px solid rgba(16,185,129,.3);margin-top:20px}
        .restock-new-label{font-size:.85rem;color:var(--accent-green);margin-bottom:6px}
        .restock-new-value{font-size:2rem;font-weight:800;color:var(--accent-green)}
        
        /* Receipt */
        .receipt{background:white;color:#111;padding:28px;border-radius:var(--radius-md);font-family:'JetBrains Mono',monospace}
        .receipt-header{text-align:center;border-bottom:2px dashed #ddd;padding-bottom:20px;margin-bottom:20px}
        .receipt-logo{font-size:1.3rem;font-weight:800;margin-bottom:4px}
        .receipt-shop{font-size:.9rem}
        .receipt-info{font-size:.75rem;color:#666;margin-top:10px;line-height:1.5}
        .receipt-items{border-bottom:1px dashed #ddd;padding-bottom:16px;margin-bottom:16px}
        .receipt-item{display:flex;justify-content:space-between;font-size:.8rem;padding:6px 0}
        .receipt-totals{margin-bottom:20px}
        .receipt-row{display:flex;justify-content:space-between;font-size:.85rem;padding:4px 0}
        .receipt-row.grand{font-size:1.2rem;font-weight:800;border-top:2px solid #111;padding-top:12px;margin-top:10px}
        .receipt-payment{background:#f5f5f5;padding:14px;border-radius:8px;margin-bottom:16px}
        .receipt-payment.mpesa{background:#e8f5e9}
        .receipt-footer{text-align:center;font-size:.75rem;color:#666;border-top:2px dashed #ddd;padding-top:20px}
        .receipt-kra{margin-top:12px;padding-top:12px;border-top:1px dashed #ddd;font-size:.7rem}
        .receipt-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px}
        .receipt-btn{padding:14px;border:none;border-radius:var(--radius-sm);font-weight:600;cursor:pointer;font-size:.95rem}
        .receipt-btn.print{background:var(--gradient-blue);color:white}
        .receipt-btn.done{background:var(--gradient-green);color:white}
        /* Toast Notifications */
        .toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:10px}
        .toast{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px 20px;display:flex;align-items:center;gap:14px;box-shadow:var(--shadow-lg);animation:slideInRight .3s ease;min-width:320px}
        @keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .toast.success{border-left:4px solid var(--accent-green)}
        .toast.error{border-left:4px solid var(--accent-red)}
        .toast.warning{border-left:4px solid var(--accent-yellow)}
        .toast.info{border-left:4px solid var(--accent-blue)}
        .toast-icon{font-size:1.4rem}
        .toast-content{flex:1}
        .toast-title{font-weight:600;font-size:.95rem;margin-bottom:2px}
        .toast-message{font-size:.8rem;color:var(--text-secondary)}
        .toast-close{background:transparent;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;padding:4px}
        
        /* Accounting Specific */
        .ledger-entry{display:grid;grid-template-columns:100px 1fr 120px 120px;gap:16px;padding:14px;border-bottom:1px solid var(--border);align-items:center}
        .ledger-entry:hover{background:var(--bg-card-hover)}
        .ledger-date{font-size:.8rem;color:var(--text-muted)}
        .ledger-desc{font-size:.9rem}
        .ledger-debit,.ledger-credit{font-family:'JetBrains Mono',monospace;font-weight:600;text-align:right}
        .ledger-debit{color:var(--accent-red)}
        .ledger-credit{color:var(--accent-green)}
        
        .account-balance{display:flex;justify-content:space-between;padding:16px;background:var(--bg-dark);border-radius:var(--radius-sm);margin-bottom:12px}
        .account-name{font-weight:600}
        .account-amount{font-family:'JetBrains Mono',monospace;font-weight:700}
        .account-amount.positive{color:var(--accent-green)}
        .account-amount.negative{color:var(--accent-red)}
        
        /* Mobile Responsive */
        @media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}.dashboard-grid{grid-template-columns:1fr}.dashboard-grid-full,.dashboard-grid-triple{grid-template-columns:1fr}.quick-actions{grid-template-columns:repeat(2,1fr)}.pos-layout{grid-template-columns:1fr}.kra-stats{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:768px){
            .sidebar{transform:translateX(-100%)}
            .sidebar.open{transform:translateX(0)}
            .main-content{margin-left:0}
            .mobile-menu-btn{display:flex}
            .search-box{display:none}
            .stats-grid{grid-template-columns:1fr}
            .quick-actions{grid-template-columns:1fr 1fr}
            .pos-product-grid{grid-template-columns:repeat(2,1fr)}
            .page-content{padding:16px;height:calc(100vh - 56px);overflow-y:auto;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:90px}
            .pos-cart{position:fixed;bottom:0;left:0;right:0;height:65vh;border-radius:var(--radius-xl) var(--radius-xl) 0 0;transform:translateY(calc(100% - 80px));transition:transform .3s;z-index:100}
            .pos-cart.expanded{transform:translateY(0)}
            .pos-products{height:calc(100vh - 180px);padding-bottom:90px}
            .form-row{grid-template-columns:1fr}
            .current-time{display:none}
        }
        .mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}
        .mobile-overlay.show{display:block}
        .bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-sidebar);border-top:1px solid var(--border);padding:8px 16px;z-index:90}
        @media(max-width:768px){.bottom-nav{display:flex;justify-content:space-around}body{padding-bottom:70px}}
        .bottom-nav-item{display:flex;flex-direction:column;align-items:center;padding:8px 12px;cursor:pointer;color:var(--text-muted);transition:all .2s}
        .bottom-nav-item.active{color:var(--accent-blue)}
        .bottom-nav-icon{font-size:1.4rem;margin-bottom:4px}
        .bottom-nav-label{font-size:.65rem;font-weight:600}
        .offline-indicator{position:fixed;top:70px;right:24px;background:var(--accent-yellow);color:#000;padding:10px 18px;border-radius:var(--radius-sm);font-size:.85rem;font-weight:600;display:none;z-index:1000;box-shadow:var(--shadow-md)}
        .offline-indicator.show{display:flex;align-items:center;gap:8px}
        ::-webkit-scrollbar{width:6px;height:6px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
        ::-webkit-scrollbar-thumb:hover{background:var(--border-light)}
        
        /* Print Styles */
        @media print{body *{visibility:hidden}.receipt,.receipt *{visibility:visible}.receipt{position:absolute;left:0;top:0;width:80mm}}
        
        /* Offline Banner */
        .offline-banner{position:fixed;top:64px;left:0;right:0;background:linear-gradient(135deg,#f59e0b,#f97316);color:#000;padding:12px 24px;text-align:center;font-weight:600;font-size:.9rem;z-index:60;box-shadow:0 4px 6px rgba(0,0,0,0.3);animation:slideDown .3s ease}
        .offline-banner.hidden{display:none}
        @keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
        
        /* Loading Spinner */
        .login-loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;flex-direction:column;gap:20px}
        .login-loading.show{display:flex}
        .spinner{width:60px;height:60px;border:4px solid rgba(59,130,246,0.2);border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        @keyframes errorShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
        .login-loading-text{color:var(--text-primary);font-size:1.1rem;font-weight:600}
        
        /* Error Message */
        .login-error{display:none;margin-bottom:20px;padding:14px 16px;background:rgba(239,68,68,0.15);border:2px solid rgba(239,68,68,0.5);border-radius:var(--radius-md);color:#ff6b6b;font-size:0.95rem;font-weight:600;text-align:center;box-shadow:0 4px 6px rgba(239,68,68,0.2)}
        .login-error.show{display:block;animation:errorShake 0.4s ease}
    </style>
</head>
<body>
    <!-- Offline Banner -->
    <div class="offline-banner hidden" id="offlineBanner">
        âš ï¸ You are currently offline. All data is being saved locally and will sync when connection is restored.
    </div>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <!-- Error Message -->
            <div class="login-error" id="loginError"></div>
            
            <!-- Login Form -->
            <div class="auth-screen active" id="loginForm">
                <div style="margin-bottom:16px;padding:12px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:var(--radius-sm);font-size:.85rem;text-align:center">
                    <strong style="color:var(--accent-green)">ðŸª New Shop Owner?</strong><br>
                    <span style="color:var(--text-secondary);font-size:.8rem">Click "First Time Setup" below to create your account</span>
                </div>
                <div class="login-logo">ðŸª</div>
                <h1 class="login-title">BiasharaFlow POS</h1>
                <p class="login-subtitle">Complete Business Management System</p>
                <div class="login-form">
                    <div class="login-input-group">
                        <label class="login-label">Username</label>
                        <input type="text" class="login-input" id="loginUsername" placeholder="Enter username" onkeypress="if(event.key==='Enter')handleLogin()">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Password</label>
                        <input type="password" class="login-input" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')handleLogin()">
                    </div>
                    <button class="login-btn" onclick="handleLogin()">ðŸ” Sign In</button>
                </div>
                <div class="login-footer">
                    <span class="login-link" onclick="showAuthScreen('forgotPassword')">Forgot Password?</span>
                    <span style="margin:0 8px;color:var(--text-muted)">â€¢</span>
                    <span class="login-link" onclick="showAuthScreen('firstSetup')">First Time Setup</span>
                </div>
                <div class="login-divider" id="loginTypeSection"><span>Login As</span></div>
                <div class="login-type-buttons" id="loginTypeButtons" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
                    <button class="login-type-btn" onclick="selectLoginType('admin')" id="adminLoginBtn" style="padding:16px;background:var(--bg-dark);border:2px solid var(--border);border-radius:var(--radius-md);cursor:pointer;transition:all .2s;text-align:center">
                        <div style="font-size:2rem;margin-bottom:8px">ðŸ‘‘</div>
                        <div style="font-size:.9rem;font-weight:600;color:var(--text-primary)">Admin Login</div>
                        <div style="font-size:.75rem;color:var(--text-muted);margin-top:4px">Full System Access</div>
                    </button>
                    <button class="login-type-btn" onclick="selectLoginType('seller')" id="sellerLoginBtn" style="padding:16px;background:var(--bg-dark);border:2px solid var(--border);border-radius:var(--radius-md);cursor:pointer;transition:all .2s;text-align:center">
                        <div style="font-size:2rem;margin-bottom:8px">ðŸ›’</div>
                        <div style="font-size:.9rem;font-weight:600;color:var(--text-primary)">Seller Login</div>
                        <div style="font-size:.75rem;color:var(--text-muted);margin-top:4px">POS Only Access</div>
                    </button>
                </div>
                <input type="hidden" id="selectedLoginType" value="admin">
            </div>

            <!-- REMOVED: Signup Form (admin-only user creation now) -->

            <!-- Forgot Password Form -->
            <div class="auth-screen" id="forgotPasswordForm">
                <div class="back-btn" onclick="showAuthScreen('login')">â† Back to Login</div>
                <div class="login-logo">ðŸ”‘</div>
                <h1 class="login-title">Forgot Password</h1>
                <p class="login-subtitle">Enter your email to reset password</p>
                <div class="login-form">
                    <div class="login-input-group">
                        <label class="login-label">Email Address *</label>
                        <input type="email" class="login-input" id="forgotEmail" placeholder="your.email@example.com">
                    </div>
                    <button class="login-btn" onclick="handleForgotPassword()">ðŸ“§ Send Reset Link</button>
                    <div style="margin-top:16px;padding:12px;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);border-radius:var(--radius-sm);font-size:.8rem;color:var(--text-secondary)">
                        â„¹ï¸ For demo purposes, password reset will be simulated. In production, this would send an email with a reset link.
                    </div>
                </div>
            </div>

            <!-- First Time Setup Form -->
            <div class="auth-screen" id="firstSetupForm">
                <div class="back-btn" onclick="showAuthScreen('login')">â† Back to Login</div>
                <div class="login-logo">ðŸŽ‰</div>
                <h1 class="login-title">Welcome to BiasharaFlow POS!</h1>
                <p class="login-subtitle">Create your admin account to get started</p>
                <div class="login-form">
                    <div class="login-input-group">
                        <label class="login-label">Business Name *</label>
                        <input type="text" class="login-input" id="setupBusinessName" placeholder="e.g., Mary's General Store">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Your Full Name *</label>
                        <input type="text" class="login-input" id="setupName" placeholder="e.g., Mary Wanjiku">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Email Address *</label>
                        <input type="email" class="login-input" id="setupEmail" placeholder="your.email@example.com">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Phone Number (Optional)</label>
                        <input type="tel" class="login-input" id="setupPhone" placeholder="0712345678" maxlength="10">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Username *</label>
                        <input type="text" class="login-input" id="setupUsername" placeholder="Choose a username">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Password *</label>
                        <input type="password" class="login-input" id="setupPassword" placeholder="Create a strong password">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Confirm Password *</label>
                        <input type="password" class="login-input" id="setupPasswordConfirm" placeholder="Re-enter password">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Admin Authorization Key *</label>
                        <input type="password" class="login-input" id="setupSecretKey" placeholder="Enter admin authorization key">
                        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:6px">
                            ðŸ”’ Contact the system administrator for the authorization key
                        </div>
                    </div>
                    <button class="login-btn" onclick="handleFirstTimeSetup()">ðŸš€ Create Account</button>
                    <div style="margin-top:16px;padding:12px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);border-radius:var(--radius-sm);font-size:.8rem;color:var(--text-secondary)">
                        âœ… 100% FREE - No billing required<br>
                        âœ… Instant signup with email<br>
                        âœ… All data syncs across devices
                    </div>
                </div>
            </div>

            <!-- Email auth - no OTP needed -->
        </div>
    </div>
    
    <!-- Loading Spinner Overlay -->
    <div class="login-loading" id="loginLoading">
        <div class="spinner"></div>
        <div class="login-loading-text">Logging you in...</div>
    </div>
    
    <!-- Main App -->
    <div class="app-container hidden" id="appContainer">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">ðŸª</div>
                    <div>
                        <div class="logo-text">BiasharaFlow POS</div>
                        <div class="logo-subtitle">Business Management</div>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <div class="nav-item active" data-tab="dashboard" data-role="admin" onclick="switchTab('dashboard')">
                        <span class="nav-item-icon">ðŸ“Š</span>Dashboard
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Sales</div>
                    <div class="nav-item" data-tab="pos" data-role="all" onclick="switchTab('pos')">
                        <span class="nav-item-icon">ðŸ›’</span>Point of Sale
                    </div>
                    <div class="nav-item" data-tab="sales" data-role="admin" onclick="switchTab('sales')">
                        <span class="nav-item-icon">ðŸ“‹</span>Sales History
                    </div>
                    <div class="nav-item" data-tab="credit" data-role="admin" onclick="switchTab('credit')">
                        <span class="nav-item-icon">ðŸ’³</span>Credit Sales
                        <span class="nav-badge warning" id="creditBadge">0</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Inventory</div>
                    <div class="nav-item" data-tab="inventory" data-role="admin" onclick="switchTab('inventory')">
                        <span class="nav-item-icon">ðŸ“¦</span>Products
                        <span class="nav-badge info" id="lowStockBadge">0</span>
                    </div>
                    <div class="nav-item" data-tab="categories" data-role="admin" onclick="switchTab('categories')">
                        <span class="nav-item-icon">ðŸ“</span>Categories
                    </div>
                    <div class="nav-item" data-tab="suppliers" data-role="admin" onclick="switchTab('suppliers')">
                        <span class="nav-item-icon">ðŸšš</span>Suppliers
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Accounting</div>
                    <div class="nav-item" data-tab="expenses" data-role="admin" onclick="switchTab('expenses')">
                        <span class="nav-item-icon">ðŸ’¸</span>Expenses
                    </div>
                    <div class="nav-item" data-tab="accounts" data-role="admin" onclick="switchTab('accounts')">
                        <span class="nav-item-icon">ðŸ“’</span>Chart of Accounts
                    </div>
                    <div class="nav-item" data-tab="journal" data-role="admin" onclick="switchTab('journal')">
                        <span class="nav-item-icon">ðŸ“</span>Journal Entries
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reports & Compliance</div>
                    <div class="nav-item" data-tab="reports" data-role="admin" onclick="switchTab('reports')">
                        <span class="nav-item-icon">ðŸ“ˆ</span>Analytics
                    </div>
                    <div class="nav-item" data-tab="kra" data-role="admin" onclick="switchTab('kra')">
                        <span class="nav-item-icon">ðŸ›ï¸</span>KRA/Tax Reports
                    </div>
                    <div class="nav-item" data-tab="profit" data-role="admin" onclick="switchTab('profit')">
                        <span class="nav-item-icon">ðŸ’°</span>Profit & Loss
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Settings</div>
                    <div class="nav-item" data-tab="users" data-role="admin" onclick="switchTab('users')">
                        <span class="nav-item-icon">ðŸ‘¥</span>User Management
                    </div>
                    <div class="nav-item" data-tab="settings" data-role="admin" onclick="switchTab('settings')">
                        <span class="nav-item-icon">âš™ï¸</span>Settings
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-item" onclick="logout()" style="color:var(--accent-red);border:1px solid var(--accent-red);margin-top:8px;">
                        <span class="nav-item-icon">ðŸšª</span>Logout
                    </div>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile" onclick="showProfileModal()">
                    <div class="user-avatar admin" id="userAvatar">AD</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin User</div>
                        <div class="user-role admin" id="userRole">Administrator</div>
                    </div>
                    <button class="logout-btn" onclick="event.stopPropagation();logout()" title="Logout">ðŸšª</button>
                </div>
                <div class="sidebar-company">Powered by Rudder Research<br>and Data Analytics</div>
            </div>
        </aside>
        
        <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebar()"></div>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
                    <div>
                        <h1 class="page-title" id="pageTitle">Dashboard</h1>
                        <div class="page-subtitle" id="pageSubtitle">Overview of your business</div>
                    </div>
                </div>
                <div class="top-bar-right">
                    <div class="sync-status online" id="syncStatus">
                        <span class="sync-dot"></span>
                        <span id="syncText">Online</span>
                    </div>
                    <div class="current-time" id="currentTime">--:--</div>
                    <div class="search-box">
                        <span>ðŸ”</span>
                        <input type="text" placeholder="Search..." id="globalSearch" oninput="handleGlobalSearch(this.value)">
                    </div>
                    <button class="top-btn" onclick="exportToExcel()" title="Export Data">ðŸ“Š</button>
                    <button class="top-btn" onclick="showNotifications()" title="Notifications">
                        ðŸ””<span class="notification-dot" id="notifDot"></span>
                    </button>
                    <button class="top-btn" onclick="logout()" title="Logout" style="color:var(--accent-red)">ðŸšª</button>
                </div>
            </div>
            
            <div class="page-content">
                <!-- Dashboard Tab -->
                <div class="tab-content active" id="dashboardTab">
                    <div class="welcome-section">
                        <h2 class="welcome-title">Welcome back, <span id="welcomeName">Admin</span>! ðŸ‘‹</h2>
                        <p class="welcome-subtitle">Here's what's happening with your business today</p>
                    </div>
                    
                    <div class="date-filter-bar">
                        <button class="date-btn active" onclick="setDateFilter('today')">Today</button>
                        <button class="date-btn" onclick="setDateFilter('week')">This Week</button>
                        <button class="date-btn" onclick="setDateFilter('month')">This Month</button>
                        <button class="date-btn" onclick="setDateFilter('year')">This Year</button>
                        <button class="date-btn" onclick="setDateFilter('all')">All Time</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <div class="stat-header">
                                <span class="stat-label">Total Revenue</span>
                                <div class="stat-icon blue">ðŸ’°</div>
                            </div>
                            <div class="stat-value" id="dashRevenue">Ksh 0</div>
                            <div class="stat-change up" id="dashRevenueChange">â†— +0% from last period</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-header">
                                <span class="stat-label">Net Profit</span>
                                <div class="stat-icon green">ðŸ“ˆ</div>
                            </div>
                            <div class="stat-value" id="dashProfit">Ksh 0</div>
                            <div class="stat-change up" id="dashProfitChange">â†— After expenses</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-header">
                                <span class="stat-label">Total Sales</span>
                                <div class="stat-icon purple">ðŸ›’</div>
                            </div>
                            <div class="stat-value" id="dashSalesCount">0</div>
                            <div class="stat-change neutral">Transactions completed</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-header">
                                <span class="stat-label">Outstanding Credit</span>
                                <div class="stat-icon orange">ðŸ’³</div>
                            </div>
                            <div class="stat-value" id="dashCredit">Ksh 0</div>
                            <div class="stat-change down" id="dashCreditCount">0 pending payments</div>
                        </div>
                    </div>
                    
                    <!-- KRA Status Card -->
                    <div class="kra-status-card">
                        <div class="kra-header">
                            <div class="kra-title">ðŸ›ï¸ KRA Tax Compliance Status</div>
                            <div class="kra-badge">eTIMS Ready</div>
                        </div>
                        <div class="kra-stats">
                            <div class="kra-stat">
                                <div class="kra-stat-value" id="kraVatCollected">Ksh 0</div>
                                <div class="kra-stat-label">VAT Collected (16%)</div>
                            </div>
                            <div class="kra-stat">
                                <div class="kra-stat-value" id="kraTaxableSales">Ksh 0</div>
                                <div class="kra-stat-label">Taxable Sales</div>
                            </div>
                            <div class="kra-stat">
                                <div class="kra-stat-value" id="kraExemptSales">Ksh 0</div>
                                <div class="kra-stat-label">Exempt Sales</div>
                            </div>
                            <div class="kra-stat">
                                <div class="kra-stat-value" id="kraInvoices">0</div>
                                <div class="kra-stat-label">eTIMS Invoices</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-action-btn primary" onclick="switchTab('pos')">
                            <span class="quick-action-icon">ðŸ›’</span>
                            <span class="quick-action-label">New Sale</span>
                        </button>
                        <button class="quick-action-btn success" onclick="showAddExpenseModal()">
                            <span class="quick-action-icon">ðŸ’¸</span>
                            <span class="quick-action-label">Add Expense</span>
                        </button>
                        <button class="quick-action-btn warning" onclick="switchTab('inventory');toggleRestockMode()">
                            <span class="quick-action-icon">ðŸ“¦</span>
                            <span class="quick-action-label">Quick Restock</span>
                        </button>
                        <button class="quick-action-btn purple" onclick="switchTab('reports')">
                            <span class="quick-action-icon">ðŸ“Š</span>
                            <span class="quick-action-label">View Reports</span>
                        </button>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><span class="card-title-icon" style="background:var(--accent-blue)"></span>Sales by Payment Method</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container"><canvas id="paymentChart"></canvas></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><span class="card-title-icon" style="background:var(--accent-green)"></span>Today's Breakdown</h3>
                            </div>
                            <div class="card-body">
                                <div class="breakdown-list" id="dashBreakdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid-full">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><span class="card-title-icon" style="background:var(--accent-purple)"></span>Revenue Trend (Last 7 Days)</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><span class="card-title-icon" style="background:var(--accent-orange)"></span>Top Selling Products</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container"><canvas id="productsChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- POS Tab -->
                <div class="tab-content" id="posTab">
                    <div class="pos-layout">
                        <div class="pos-products">
                            <div class="pos-header">
                                <div class="pos-search">
                                    <input type="text" placeholder="ðŸ” Search products..." id="posSearch" oninput="filterPOSProducts(this.value)">
                                </div>
                            </div>
                            <div class="pos-categories" id="posCategories"></div>
                            <div class="pos-product-grid" id="posProductGrid"></div>
                        </div>
                        <div class="pos-cart" id="posCart">
                            <div class="cart-header" onclick="toggleCartMobile()">
                                <div class="cart-title">ðŸ›’ Current Sale <span class="cart-count" id="cartCount">0</span></div>
                                <button class="cart-clear-btn" onclick="event.stopPropagation();clearCart()">Clear All</button>
                            </div>
                            <div class="cart-items" id="cartItems" onclick="event.stopPropagation()">
                                <div class="cart-empty">
                                    <div class="cart-empty-icon">ðŸ›’</div>
                                    <div class="cart-empty-text">Cart is empty</div>
                                    <div class="cart-empty-hint">Tap on products to add them</div>
                                </div>
                            </div>
                            <div class="cart-footer" onclick="event.stopPropagation()">
                                <div class="cart-totals">
                                    <div class="cart-row subtotal"><span>Subtotal</span><span id="cartSubtotal">Ksh 0</span></div>
                                    <div class="cart-row tax"><span>VAT (16%)</span><span id="cartVat">Ksh 0</span></div>
                                    <div class="cart-row total"><span>TOTAL</span><span id="cartTotal">Ksh 0</span></div>
                                </div>
                                <div class="payment-section">
                                    <div class="payment-label">Payment Method</div>
                                    <div class="payment-grid">
                                        <button class="pay-btn active" data-method="Cash" onclick="selectPayment('Cash',this)">
                                            <span class="pay-icon">ðŸ’µ</span><span class="pay-label">Cash</span>
                                        </button>
                                        <button class="pay-btn" data-method="M-Pesa" onclick="selectPayment('M-Pesa',this)">
                                            <span class="pay-icon">ðŸ“±</span><span class="pay-label">M-Pesa</span>
                                        </button>
                                        <button class="pay-btn" data-method="Credit" onclick="selectPayment('Credit',this)">
                                            <span class="pay-icon">ðŸ’³</span><span class="pay-label">Credit</span>
                                        </button>
                                    </div>
                                </div>
                                <!-- UPDATED: M-Pesa Payment with IntaSend & Manual Options -->
                                <div class="mpesa-panel" id="mpesaPanel">
                                    <div class="mpesa-header">
                                        <span class="mpesa-title">ðŸ“± M-Pesa Payment</span>
                                    </div>
                                    
                                    <!-- IntaSend Automatic Mode -->
                                    <div id="mpesaIntasendMode" style="display:none;">
                                        <div style="background:rgba(16,185,129,0.15); padding:16px; border-radius:12px; margin:16px 0; border:2px solid rgba(16,185,129,0.4); text-align:center;">
                                            <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:8px;">ðŸš€ Automatic Verification Enabled</div>
                                            <div style="font-size:1.6rem; font-weight:800; color:#10b981;" id="mpesaAmountIntasend">Ksh 0</div>
                                        </div>
                                        <div style="margin-bottom:8px;">
                                            <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:6px; color:var(--text-secondary);">Customer Phone Number *</label>
                                            <input type="tel" class="mpesa-input" id="mpesaPhoneIntasend" placeholder="07XXXXXXXX" style="font-size:1.1rem; text-align:center; letter-spacing:1px;">
                                        </div>
                                        <button class="complete-sale-btn" onclick="sendIntasendSTKPush()" style="background:var(--gradient-green);">
                                            ðŸ“² Send Payment Request to Customer
                                        </button>
                                        <div id="intasendStatus" style="margin-top:12px; padding:12px; border-radius:8px; text-align:center; display:none;"></div>
                                    </div>
                                    
                                    <!-- Manual Mode -->
                                    <div id="mpesaManualMode">
                                        <div style="background:rgba(16,185,129,0.15); padding:20px; border-radius:12px; margin:16px 0; border:2px solid rgba(16,185,129,0.4);">
                                            <div style="text-align:center; margin-bottom:12px;">
                                                <div style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:8px;">Customer Pays To:</div>
                                                <div style="font-size:2.2rem; font-weight:800; color:#10b981; font-family:'JetBrains Mono',monospace; letter-spacing:2px;" id="mpesaTillDisplay">Not set</div>
                                                <div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">Till/Paybill Number</div>
                                            </div>
                                            <div style="border-top:1px solid rgba(16,185,129,0.3); padding-top:12px; margin-top:12px;">
                                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                                    <span style="color:var(--text-secondary);">Amount to Pay:</span>
                                                    <span style="font-size:1.4rem; font-weight:800; color:#fff;" id="mpesaAmount">Ksh 0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="background:rgba(59,130,246,0.1); padding:12px; border-radius:8px; margin-bottom:16px; border-left:3px solid #3b82f6;">
                                            <div style="font-size:0.85rem; color:var(--text-secondary);">
                                                <strong style="color:#3b82f6;">ðŸ“‹ Steps:</strong><br>
                                                1. Customer sends M-Pesa to the number above<br>
                                                2. Wait for M-Pesa confirmation message<br>
                                                3. Enter customer's phone number below to confirm
                                            </div>
                                        </div>
                                        <div style="margin-bottom:8px;">
                                            <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:6px; color:var(--text-secondary);">Customer Phone Number *</label>
                                            <input type="tel" class="mpesa-input" id="mpesaPhoneConfirm" placeholder="07XXXXXXXX" oninput="updateMpesaConfirm(this.value)" style="font-size:1.1rem; text-align:center; letter-spacing:1px;">
                                        </div>
                                        <div id="mpesaConfirmMsg" style="margin:12px 0; font-size:1.05rem; color:#10b981; min-height:28px; text-align:center; font-weight:600;"></div>
                                        <button class="complete-sale-btn" id="confirmMpesaBtn" onclick="confirmManualMpesa()" disabled style="background:var(--gradient-green);">âœ“ Confirm Payment & Complete Sale</button>
                                    </div>
                                </div>
                                <button class="complete-sale-btn" id="completeSaleBtn" onclick="completeSale()" disabled>
                                    âœ“ Complete Sale
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sales History Tab -->
                <div class="tab-content" id="salesTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Sales History</h2>
                        <div class="inventory-actions">
                            <button class="inv-btn secondary" onclick="exportSalesToExcel()">ðŸ“Š Export</button>
                        </div>
                    </div>
                    <div class="inventory-filters">
                        <input type="date" class="filter-select" id="salesDateFrom">
                        <input type="date" class="filter-select" id="salesDateTo">
                        <select class="filter-select" id="salesPaymentFilter" onchange="filterSales()">
                            <option value="all">All Payments</option>
                            <option value="Cash">Cash</option>
                            <option value="M-Pesa">M-Pesa</option>
                            <option value="Credit">Credit</option>
                        </select>
                        <button class="inv-btn primary" onclick="filterSales()">Apply Filter</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>Receipt #</th><th>Date/Time</th><th>Items</th><th>Total</th><th>VAT</th><th>Payment</th><th>Cashier</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="salesTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Credit Sales Tab -->
                <div class="tab-content" id="creditTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Credit Sales Management</h2>
                    </div>
                    <div class="stats-grid" style="margin-bottom:24px">
                        <div class="stat-card orange">
                            <div class="stat-header"><span class="stat-label">Total Outstanding</span><div class="stat-icon orange">ðŸ’°</div></div>
                            <div class="stat-value" id="creditOutstanding">Ksh 0</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-header"><span class="stat-label">Collected This Month</span><div class="stat-icon green">âœ…</div></div>
                            <div class="stat-value" id="creditCollected">Ksh 0</div>
                        </div>
                        <div class="stat-card red">
                            <div class="stat-header"><span class="stat-label">Overdue (>30 days)</span><div class="stat-icon red">âš ï¸</div></div>
                            <div class="stat-value" id="creditOverdue">Ksh 0</div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>Customer</th><th>Phone</th><th>Total Owed</th><th>Paid</th><th>Balance</th><th>Due Date</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="creditTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Inventory Tab -->
                <div class="tab-content" id="inventoryTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Product Inventory</h2>
                        <div class="inventory-actions">
                            <button class="inv-btn secondary" onclick="toggleRestockMode()">ðŸ“¦ Quick Restock</button>
                            <button class="inv-btn secondary" onclick="exportInventory()">ðŸ“Š Export</button>
                            <button class="inv-btn primary" onclick="showAddProductModal()">âž• Add Product</button>
                        </div>
                    </div>
                    <div class="restock-banner" id="restockBanner">
                        <div class="restock-banner-info">
                            <span class="restock-banner-icon">ðŸ“¦</span>
                            <div class="restock-banner-text">
                                <h4>Restock Mode Active</h4>
                                <p>Tap any product to quickly add stock - just like making a sale!</p>
                            </div>
                        </div>
                        <button class="exit-restock-btn" onclick="toggleRestockMode()">Exit Restock Mode</button>
                    </div>
                    <div class="inventory-filters">
                        <select class="filter-select" id="invCategoryFilter" onchange="filterInventory()">
                            <option value="all">All Categories</option>
                        </select>
                        <select class="filter-select" id="invStockFilter" onchange="filterInventory()">
                            <option value="all">All Stock Levels</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                        </select>
                        <input type="text" class="filter-input" id="invSearch" placeholder="ðŸ” Search products..." oninput="filterInventory()">
                    </div>
                    <div class="inventory-grid" id="inventoryGrid"></div>
                    <div class="table-container" id="inventoryTable">
                        <table class="data-table">
                            <thead>
                                <tr><th>Product</th><th>SKU</th><th>Category</th><th>Cost</th><th>Price</th><th>Margin</th><th>Stock</th><th>Value</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="inventoryTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Categories Tab -->
                <div class="tab-content" id="categoriesTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Product Categories</h2>
                        <div class="inventory-actions">
                            <button class="inv-btn primary" onclick="showAddCategoryModal()">âž• Add Category</button>
                        </div>
                    </div>
                    <div class="inventory-grid" id="categoriesGrid"></div>
                </div>
                
                <!-- Suppliers Tab -->
                <div class="tab-content" id="suppliersTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Supplier Management</h2>
                        <div class="inventory-actions">
                            <button class="inv-btn primary" onclick="showAddSupplierModal()">âž• Add Supplier</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>Supplier Name</th><th>Contact Person</th><th>Phone</th><th>Email</th><th>Products</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="suppliersTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Expenses Tab -->
                <div class="tab-content" id="expensesTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Expense Tracking</h2>
                        <div class="inventory-actions">
                            <button class="inv-btn primary" onclick="showAddExpenseModal()">âž• Add Expense</button>
                        </div>
                    </div>
                    <div class="stats-grid" style="margin-bottom:24px">
                        <div class="stat-card orange">
                            <div class="stat-header"><span class="stat-label">Today's Expenses</span><div class="stat-icon orange">ðŸ’¸</div></div>
                            <div class="stat-value" id="expenseToday">Ksh 0</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-header"><span class="stat-label">This Month</span><div class="stat-icon purple">ðŸ“…</div></div>
                            <div class="stat-value" id="expenseMonth">Ksh 0</div>
                        </div>
                        <div class="stat-card red">
                            <div class="stat-header"><span class="stat-label">Total Expenses</span><div class="stat-icon red">ðŸ“Š</div></div>
                            <div class="stat-value" id="expenseTotal">Ksh 0</div>
                        </div>
                    </div>
                    <div class="dashboard-grid-full" style="margin-bottom:24px">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Expenses by Category</h3></div>
                            <div class="card-body"><div class="chart-container small"><canvas id="expenseCategoryChart"></canvas></div></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Monthly Trend</h3></div>
                            <div class="card-body"><div class="chart-container small"><canvas id="expenseTrendChart"></canvas></div></div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Recorded By</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="expenseTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Chart of Accounts Tab -->
                <div class="tab-content" id="accountsTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Chart of Accounts</h2>
                        <div class="inventory-actions">
                            <button class="inv-btn primary" onclick="showAddAccountModal()">âž• Add Account</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>Account Code</th><th>Account Name</th><th>Type</th><th>Balance</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="accountsTableBody">
                                <tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted);">No accounts configured yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Journal Entries Tab -->
                <div class="tab-content" id="journalTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Journal Entries</h2>
                        <div class="inventory-actions">
                            <button class="inv-btn primary" onclick="showAddJournalModal()">âž• New Entry</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>Date</th><th>Reference</th><th>Description</th><th>Debit</th><th>Credit</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="journalTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Reports/Analytics Tab -->
                <div class="tab-content" id="reportsTab">
                    <div class="welcome-section">
                        <h2 class="welcome-title">Business Analytics ðŸ“Š</h2>
                        <p class="welcome-subtitle">Comprehensive insights into your business performance</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <div class="stat-header"><span class="stat-label">Gross Revenue</span><div class="stat-icon blue">ðŸ’°</div></div>
                            <div class="stat-value" id="reportGrossRevenue">Ksh 0</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-header"><span class="stat-label">Gross Profit</span><div class="stat-icon green">ðŸ“ˆ</div></div>
                            <div class="stat-value" id="reportGrossProfit">Ksh 0</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-header"><span class="stat-label">Total Expenses</span><div class="stat-icon orange">ðŸ’¸</div></div>
                            <div class="stat-value" id="reportExpenses">Ksh 0</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-header"><span class="stat-label">Net Profit</span><div class="stat-icon purple">ðŸŽ¯</div></div>
                            <div class="stat-value" id="reportNetProfit">Ksh 0</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid-full">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Sales Trend (30 Days)</h3></div>
                            <div class="card-body"><div class="chart-container large"><canvas id="salesTrendChart"></canvas></div></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Profit vs Expenses</h3></div>
                            <div class="card-body"><div class="chart-container large"><canvas id="profitExpenseChart"></canvas></div></div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid-triple">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Sales by Category</h3></div>
                            <div class="card-body"><div class="chart-container"><canvas id="categorySalesChart"></canvas></div></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Top 10 Products</h3></div>
                            <div class="card-body" id="topProductsList"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Sales by Hour</h3></div>
                            <div class="card-body"><div class="chart-container"><canvas id="hourlyChart"></canvas></div></div>
                        </div>
                    </div>
                </div>
                
                <!-- KRA/Tax Reports Tab -->
                <div class="tab-content" id="kraTab">
                    <div class="welcome-section">
                        <h2 class="welcome-title">KRA Tax Compliance ðŸ›ï¸</h2>
                        <p class="welcome-subtitle">eTIMS integration and tax reporting</p>
                    </div>
                    
                    <div class="kra-status-card" style="background:linear-gradient(135deg,#1e40af,#3b82f6)">
                        <div class="kra-header">
                            <div class="kra-title">ðŸ“‹ Tax Period Summary</div>
                            <select class="filter-select" style="background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.3);color:white" id="kraPeriod" onchange="updateKRAReport()">
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="kra-stats">
                            <div class="kra-stat">
                                <div class="kra-stat-value" id="kraTotalSales">Ksh 0</div>
                                <div class="kra-stat-label">Total Sales (Incl. VAT)</div>
                            </div>
                            <div class="kra-stat">
                                <div class="kra-stat-value" id="kraOutputVat">Ksh 0</div>
                                <div class="kra-stat-label">Output VAT (16%)</div>
                            </div>
                            <div class="kra-stat">
                                <div class="kra-stat-value" id="kraInputVat">Ksh 0</div>
                                <div class="kra-stat-label">Input VAT (Expenses)</div>
                            </div>
                            <div class="kra-stat">
                                <div class="kra-stat-value" id="kraNetVat">Ksh 0</div>
                                <div class="kra-stat-label">Net VAT Payable</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid-full">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">eTIMS Invoice Summary</h3>
                                <button class="action-btn primary" onclick="generateETIMSReport()">ðŸ“„ Generate Report</button>
                            </div>
                            <div class="card-body">
                                <div class="breakdown-list">
                                    <div class="breakdown-item">
                                        <div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(16,185,129,.15);color:var(--accent-green)">ðŸ“ƒ</div><div><div class="breakdown-label">Total Invoices Issued</div><div class="breakdown-sublabel">eTIMS compliant receipts</div></div></div>
                                        <div class="breakdown-value" id="kraInvoiceCount">0</div>
                                    </div>
                                    <div class="breakdown-item">
                                        <div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(59,130,246,.15);color:var(--accent-blue)">ðŸ’°</div><div><div class="breakdown-label">Standard Rated (16%)</div><div class="breakdown-sublabel">Taxable supplies</div></div></div>
                                        <div class="breakdown-value" id="kraStandardRated">Ksh 0</div>
                                    </div>
                                    <div class="breakdown-item">
                                        <div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(139,92,246,.15);color:var(--accent-purple)">ðŸ·ï¸</div><div><div class="breakdown-label">Zero Rated (0%)</div><div class="breakdown-sublabel">Exempt supplies</div></div></div>
                                        <div class="breakdown-value" id="kraZeroRated">Ksh 0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Tax Calendar</h3>
                            </div>
                            <div class="card-body">
                                <div class="breakdown-list">
                                    <div class="breakdown-item">
                                        <div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(245,158,11,.15);color:var(--accent-yellow)">ðŸ“…</div><div><div class="breakdown-label">VAT Return Due</div><div class="breakdown-sublabel">20th of every month</div></div></div>
                                        <div class="breakdown-value" id="kraVatDue">20th Feb</div>
                                    </div>
                                    <div class="breakdown-item">
                                        <div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(239,68,68,.15);color:var(--accent-red)">âš ï¸</div><div><div class="breakdown-label">Days Until Due</div><div class="breakdown-sublabel">File on time to avoid penalties</div></div></div>
                                        <div class="breakdown-value" id="kraDaysUntil" style="color:var(--accent-yellow)">16 days</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">VAT Return Details</h3>
                            <button class="action-btn success" onclick="exportKRAReport()">ðŸ“Š Export for KRA</button>
                        </div>
                        <div class="card-body">
                            <table class="data-table">
                                <thead><tr><th>Description</th><th>Amount (Ksh)</th><th>VAT (Ksh)</th></tr></thead>
                                <tbody id="kraDetailsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Profit & Loss Tab -->
                <div class="tab-content" id="profitTab">
                    <div class="welcome-section">
                        <h2 class="welcome-title">Profit & Loss Statement ðŸ’°</h2>
                        <p class="welcome-subtitle">Financial performance summary</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Income Statement</h3>
                            <div>
                                <select class="filter-select" id="plPeriod" onchange="updateProfitLoss()">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                </select>
                                <button class="action-btn primary" onclick="exportProfitLoss()">ðŸ“Š Export</button>
                            </div>
                        </div>
                        <div class="card-body" id="profitLossStatement"></div>
                    </div>
                </div>
                
                <!-- Users Tab -->
                <div class="tab-content" id="usersTab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">User Management</h2>
                        <div class="inventory-actions">
                            <button class="inv-btn primary" onclick="showAddUserModal()">âž• Add User</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Name</th><th>Username</th><th>Password</th><th>Role</th><th>Status</th><th>Last Login</th><th>Actions</th></tr></thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="tab-content" id="settingsTab">
                    <div class="welcome-section">
                        <h2 class="welcome-title">System Settings âš™ï¸</h2>
                        <p class="welcome-subtitle">Configure your business preferences</p>
                    </div>
                    <div class="dashboard-grid-full">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Business Information</h3></div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Business Name</label>
                                    <input type="text" class="form-input" id="settingBusinessName" placeholder="Your Business Name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">KRA PIN</label>
                                    <input type="text" class="form-input" id="settingKraPin" placeholder="P000000000X">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone Number</label>
                                    <input type="text" class="form-input" id="settingPhone" placeholder="0712345678">
                                </div>
                                
                                <!-- M-PESA Payment Options -->
                                <div class="payment-options-section" style="margin-top:24px;padding:16px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;">
                                    <h4 style="margin-bottom:16px;font-size:1.1rem;color:var(--accent-green);">ðŸ’³ M-PESA Payment Methods</h4>
                                    <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px;">Configure your M-PESA payment options. Customers will see these when making payments.</p>
                                    
                                    <!-- Paybill -->
                                    <div style="margin-bottom:20px;padding:16px;background:var(--bg-dark);border-radius:8px;">
                                        <h5 style="margin-bottom:12px;font-size:1rem;display:flex;align-items:center;gap:8px;">
                                            ðŸ“± M-PESA Paybill
                                        </h5>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">Business Number (Paybill)</label>
                                                <input type="text" class="form-input" id="settingMpesaPaybillNumber" placeholder="e.g., 123456" style="font-family:'JetBrains Mono',monospace;">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Account Number</label>
                                                <input type="text" class="form-input" id="settingMpesaPaybillAccount" placeholder="Account number" style="font-family:'JetBrains Mono',monospace;">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Till Number -->
                                    <div style="margin-bottom:20px;padding:16px;background:var(--bg-dark);border-radius:8px;">
                                        <h5 style="margin-bottom:12px;font-size:1rem;display:flex;align-items:center;gap:8px;">
                                            ðŸª M-PESA Buy Goods (Till)
                                        </h5>
                                        <div class="form-group">
                                            <label class="form-label">Till Number</label>
                                            <input type="text" class="form-input" id="settingMpesa" placeholder="e.g., 123456" style="font-family:'JetBrains Mono',monospace;letter-spacing:1px;">
                                            <div style="margin-top:8px;padding:10px;background:rgba(59,130,246,0.1);border-left:3px solid #3b82f6;border-radius:4px;font-size:0.8rem;color:var(--text-secondary);">
                                                <strong style="color:#3b82f6;">ðŸ’¡ Note:</strong> Customers will see this number when paying via M-Pesa. Make sure it's correct!
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Pochi la Biashara -->
                                    <div style="margin-bottom:20px;padding:16px;background:var(--bg-dark);border-radius:8px;">
                                        <h5 style="margin-bottom:12px;font-size:1rem;display:flex;align-items:center;gap:8px;">
                                            ðŸ’¼ Pochi la Biashara
                                        </h5>
                                        <div class="form-group">
                                            <label class="form-label">Pochi Phone Number</label>
                                            <input type="text" class="form-input" id="settingMpesaPochi" placeholder="e.g., 0712345678" style="font-family:'JetBrains Mono',monospace;">
                                        </div>
                                    </div>
                                    
                                    <!-- Send Money -->
                                    <div style="margin-bottom:0;padding:16px;background:var(--bg-dark);border-radius:8px;">
                                        <h5 style="margin-bottom:12px;font-size:1rem;display:flex;align-items:center;gap:8px;">
                                            ðŸ’¸ M-PESA Send Money
                                        </h5>
                                        <div class="form-group">
                                            <label class="form-label">Recipient Phone Number</label>
                                            <input type="text" class="form-input" id="settingMpesaSend" placeholder="e.g., 0712345678" style="font-family:'JetBrains Mono',monospace;">
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="inv-btn success" onclick="saveSettings()" style="margin-top:16px;">ðŸ’¾ Save Settings</button>
                                <!-- ADDED: Client onboarding button -->
                                <button class="inv-btn primary" onclick="showOnboardModal()" style="margin-top:12px">ðŸš€ Onboard New Client</button>
                            </div>
                        </div>
                        <!-- ADDED: IntaSend API Configuration -->
                        <div class="card" style="border-color:var(--accent-green)">
                            <div class="card-header" style="background:rgba(16,185,129,.1)">
                                <h3 class="card-title" style="color:var(--accent-green)">ðŸ”Œ IntaSend M-Pesa API (Automatic Verification)</h3>
                            </div>
                            <div class="card-body">
                                <div style="margin-bottom:16px; padding:12px; background:rgba(59,130,246,0.1); border-left:3px solid #3b82f6; border-radius:4px; font-size:0.85rem;">
                                    <strong style="color:#3b82f6;">ðŸš€ Enable Automatic Payment Verification</strong><br>
                                    <span style="color:var(--text-secondary);">No SMS checking needed! System automatically detects M-Pesa payments via IntaSend API.</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" style="display:flex; align-items:center; gap:8px;">
                                        <input type="checkbox" id="settingIntasendEnabled" onchange="toggleIntasendFields()" style="width:18px; height:18px;">
                                        <span>Enable IntaSend Integration</span>
                                    </label>
                                </div>
                                
                                <!-- ADDED: Quick Client Registration Helper -->
                                <div id="intasendQuickRegister" style="display:none; margin:16px 0; padding:16px; background:rgba(139,92,246,0.1); border:2px dashed rgba(139,92,246,0.4); border-radius:12px;">
                                    <div style="text-align:center; margin-bottom:12px;">
                                        <div style="font-size:1.8rem; margin-bottom:8px;">ðŸŽ¯</div>
                                        <h4 style="color:var(--accent-purple); margin-bottom:8px; font-size:1.1rem;">Quick Client Registration</h4>
                                        <p style="color:var(--text-secondary); font-size:0.85rem;">Register this client on IntaSend and get their API keys</p>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Client Business Name *</label>
                                        <input type="text" class="form-input" id="regBusinessName" placeholder="e.g., Mama Pendo Shop">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Client Email *</label>
                                        <input type="email" class="form-input" id="regEmail" placeholder="client@example.com">
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Client Phone *</label>
                                            <input type="tel" class="form-input" id="regPhone" placeholder="0712345678">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">KRA PIN</label>
                                            <input type="text" class="form-input" id="regKraPin" placeholder="P000000000X">
                                        </div>
                                    </div>
                                    
                                    <div style="margin:12px 0; padding:12px; background:rgba(59,130,246,0.1); border-radius:8px; font-size:0.8rem;">
                                        <strong style="color:#3b82f6;">ðŸ“‹ What happens next:</strong><br>
                                        <ol style="margin:8px 0 0 20px; color:var(--text-secondary); line-height:1.6;">
                                            <li>This opens IntaSend registration page in new tab</li>
                                            <li>You register the client's business</li>
                                            <li>IntaSend sends verification email to client</li>
                                            <li>Client verifies account (upload ID, KRA)</li>
                                            <li>You get API keys from IntaSend dashboard</li>
                                            <li>Come back here and paste API keys below</li>
                                        </ol>
                                    </div>
                                    
                                    <button class="inv-btn" onclick="openIntasendRegistration()" style="width:100%; background:var(--gradient-purple); color:white;">
                                        ðŸš€ Open IntaSend Registration
                                    </button>
                                    
                                    <div style="margin-top:12px; text-align:center;">
                                        <button onclick="toggleQuickRegister()" style="background:transparent; border:none; color:var(--accent-purple); cursor:pointer; text-decoration:underline; font-size:0.85rem;">
                                            I already have API keys â†’
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="intasendFields" style="display:none;">
                                    <div class="form-group">
                                        <label class="form-label">IntaSend Public Key *</label>
                                        <input type="text" class="form-input" id="settingIntasendPublicKey" placeholder="ISPubKey_test_xxxxx" style="font-family:'JetBrains Mono',monospace;">
                                        <div style="margin-top:4px; font-size:0.75rem; color:var(--text-muted);">
                                            Get from: <a href="https://dashboard.intasend.com/api-keys" target="_blank" style="color:#3b82f6;">IntaSend Dashboard â†’ API Keys</a>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">IntaSend Secret Key *</label>
                                        <input type="password" class="form-input" id="settingIntasendSecretKey" placeholder="ISSecretKey_test_xxxxx" style="font-family:'JetBrains Mono',monospace;">
                                        <div style="margin-top:4px; font-size:0.75rem; color:var(--text-muted);">
                                            ðŸ”’ Kept secure - never shared with cashiers
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Environment</label>
                                        <select class="form-select" id="settingIntasendEnvironment">
                                            <option value="test">Test Mode (Sandbox)</option>
                                            <option value="live">Live Mode (Production)</option>
                                        </select>
                                        <div style="margin-top:4px; font-size:0.75rem; color:var(--text-muted);">
                                            Start with Test Mode to try it out, then switch to Live
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top:16px; padding:12px; background:rgba(251,191,36,0.1); border-left:3px solid #f59e0b; border-radius:4px; font-size:0.8rem;">
                                        <strong style="color:#f59e0b;">ðŸ’° Cost:</strong> 3.5% + Ksh 10 per transaction<br>
                                        <span style="color:var(--text-secondary);">Example: Ksh 1,500 sale = Ksh 62.50 fee</span>
                                    </div>
                                    
                                    <div style="margin-top:12px; padding:12px; background:rgba(16,185,129,0.1); border-left:3px solid #10b981; border-radius:4px; font-size:0.8rem;">
                                        <strong style="color:#10b981;">âœ… Benefits:</strong><br>
                                        â€¢ No SMS phone needed at POS<br>
                                        â€¢ Automatic payment verification<br>
                                        â€¢ STK Push to customer phone<br>
                                        â€¢ Secure - cashiers never see payment details<br>
                                        â€¢ Falls back to manual if API fails
                                    </div>
                                    
                                    <button class="inv-btn primary" onclick="testIntasendConnection()" style="width:100%; margin-top:12px;">
                                        ðŸ”Œ Test API Connection
                                    </button>
                                </div>
                                
                                <div style="margin-top:16px; padding:12px; background:var(--bg-dark); border-radius:8px; font-size:0.8rem;">
                                    <strong style="color:var(--text-secondary);">ðŸ“‹ Setup Instructions:</strong><br>
                                    <ol style="margin:8px 0 0 20px; color:var(--text-muted); line-height:1.8;">
                                        <li>Go to <a href="https://intasend.com" target="_blank" style="color:#3b82f6;">intasend.com</a> and create account</li>
                                        <li>Verify your business (KRA PIN, ID, etc.)</li>
                                        <li>Get API keys from Dashboard â†’ API Keys</li>
                                        <li>Enter keys above and enable integration</li>
                                        <li>Test with small transaction first</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Tax Settings</h3></div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">VAT Rate (%)</label>
                                    <input type="number" class="form-input" id="settingVatRate" value="16">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Receipt Footer Message</label>
                                    <textarea class="form-input" id="settingReceiptFooter" rows="3" placeholder="Thank you for shopping with us!"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="card" style="border-color:var(--accent-red)">
                            <div class="card-header" style="background:rgba(239,68,68,.1)"><h3 class="card-title" style="color:var(--accent-red)">âš ï¸ Danger Zone</h3></div>
                            <div class="card-body">
                                <p style="color:var(--text-secondary);margin-bottom:16px;font-size:.9rem">These actions are irreversible. Use with caution.</p>
                                <button class="inv-btn danger" onclick="resetSystemData()" style="width:100%">ðŸ”„ Reset All System Data</button>
                                <p style="color:var(--text-muted);margin-top:8px;font-size:.75rem">This will clear all sales, inventory, expenses, and reset to demo data. Users will be preserved.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" id="bottomNav">
        <div class="bottom-nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
            <span class="bottom-nav-icon">ðŸ“Š</span><span class="bottom-nav-label">Home</span>
        </div>
        <div class="bottom-nav-item" data-tab="pos" onclick="switchTab('pos')">
            <span class="bottom-nav-icon">ðŸ›’</span><span class="bottom-nav-label">Sell</span>
        </div>
        <div class="bottom-nav-item" data-tab="inventory" onclick="switchTab('inventory')">
            <span class="bottom-nav-icon">ðŸ“¦</span><span class="bottom-nav-label">Stock</span>
        </div>
        <div class="bottom-nav-item" data-tab="reports" onclick="switchTab('reports')">
            <span class="bottom-nav-icon">ðŸ“ˆ</span><span class="bottom-nav-label">Reports</span>
        </div>
    </nav>
    
    <div class="toast-container" id="toastContainer"></div>
    <div class="offline-indicator" id="offlineIndicator">ðŸ“¡ Offline Mode</div>
    <!-- Modals -->
    <div class="modal-overlay" id="quickAddModal" onclick="if(event.target===this)closeModal('quickAddModal')">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ðŸ›’ Add to Cart</h3><button class="modal-close" onclick="closeModal('quickAddModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="quick-add-product"><div class="quick-add-emoji" id="quickAddEmoji">ðŸ“¦</div><div class="quick-add-name" id="quickAddName">Product</div><div class="quick-add-price" id="quickAddPrice">Ksh 0</div></div>
                <div class="quick-qty-controls"><button class="quick-qty-btn minus" onclick="changeQuickQty(-1)">âˆ’</button><div class="quick-qty-display" id="quickQtyDisplay">1</div><button class="quick-qty-btn plus" onclick="changeQuickQty(1)">+</button></div>
                <div class="quick-total">Total: <span id="quickTotal">Ksh 0</span></div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('quickAddModal')">Cancel</button><button class="modal-btn success" onclick="confirmQuickAdd()">Add to Cart</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="restockModal" onclick="if(event.target===this)closeModal('restockModal')">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ðŸ“¦ Restock Product</h3><button class="modal-close" onclick="closeModal('restockModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="quick-add-product"><div class="quick-add-emoji" id="restockEmoji">ðŸ“¦</div><div class="quick-add-name" id="restockName">Product</div></div>
                <div class="restock-current"><div class="restock-current-label">Current Stock</div><div class="restock-current-value" id="restockCurrentStock">0</div></div>
                <div class="form-group">
                    <label class="form-label">Add Quantity</label>
                    <input type="number" class="form-input" id="restockQty" value="10" min="1" oninput="updateRestockTotal()" style="text-align:center;font-size:1.2rem">
                    <div class="restock-quick-btns"><button class="restock-quick-btn" onclick="setRestockQty(5)">+5</button><button class="restock-quick-btn" onclick="setRestockQty(10)">+10</button><button class="restock-quick-btn" onclick="setRestockQty(20)">+20</button><button class="restock-quick-btn" onclick="setRestockQty(50)">+50</button></div>
                </div>
                <div class="restock-new-total"><div class="restock-new-label">New Stock Level</div><div class="restock-new-value" id="restockNewTotal">10</div></div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('restockModal')">Cancel</button><button class="modal-btn success" onclick="confirmRestock()">âœ“ Confirm Restock</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="receiptModal" onclick="if(event.target===this)closeModal('receiptModal')">
        <div class="modal"><div class="modal-body" style="padding:0"><div class="receipt" id="receiptContent"></div><div class="receipt-actions"><button class="receipt-btn print" onclick="printReceipt()">ðŸ–¨ï¸ Print</button><button class="receipt-btn done" onclick="closeModal('receiptModal')">âœ“ Done</button></div></div></div>
    </div>
    
    <div class="modal-overlay" id="addProductModal" onclick="if(event.target===this)closeModal('addProductModal')">
        <div class="modal large">
            <div class="modal-header"><h3 class="modal-title">âž• Add New Product</h3><button class="modal-close" onclick="closeModal('addProductModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Product Name *</label><input type="text" class="form-input" id="newProductName" placeholder="e.g., Jogoo Maize Flour 2kg"></div>
                    <div class="form-group"><label class="form-label">Category (auto-generated, optional)</label><select class="form-select" id="newProductCategory"></select></div>
                </div>
                <!-- ADDED: SKU field -->
                <div class="form-group">
                    <label class="form-label">SKU (optional â€“ auto-generated)</label>
                    <input type="text" class="form-input" id="newProductSKU" placeholder="e.g. MAI-47291">
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Cost Price (Ksh) *</label><input type="number" class="form-input" id="newProductCost" placeholder="150"></div>
                    <div class="form-group"><label class="form-label">Selling Price (Ksh) *</label><input type="number" class="form-input" id="newProductPrice" placeholder="180"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Initial Stock</label><input type="number" class="form-input" id="newProductStock" placeholder="50" value="0"></div>
                    <div class="form-group"><label class="form-label">Reorder Level</label><input type="number" class="form-input" id="newProductReorder" placeholder="10" value="10"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">VAT Category</label>
                    <select class="form-select" id="newProductVat"><option value="16">Standard Rate (16%)</option><option value="0">Zero Rated (0%)</option><option value="exempt">Exempt</option></select>
                </div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('addProductModal')">Cancel</button><button class="modal-btn success" onclick="addNewProduct()">Add Product</button></div>
        </div>
    </div>
    
    <!-- Edit Product Modal -->
    <div class="modal-overlay" id="editProductModal" onclick="if(event.target===this)closeModal('editProductModal')">
        <div class="modal large">
            <div class="modal-header"><h3 class="modal-title">âœï¸ Edit Product</h3><button class="modal-close" onclick="closeModal('editProductModal')">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="editProductId">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Product Name *</label><input type="text" class="form-input" id="editProductName" placeholder="e.g., Jogoo Maize Flour 2kg"></div>
                    <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="editProductCategory"></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Cost Price (Ksh) *</label><input type="number" class="form-input" id="editProductCost" placeholder="150"></div>
                    <div class="form-group"><label class="form-label">Selling Price (Ksh) *</label><input type="number" class="form-input" id="editProductPrice" placeholder="180"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Stock</label><input type="number" class="form-input" id="editProductStock" placeholder="50"></div>
                    <div class="form-group"><label class="form-label">Reorder Level</label><input type="number" class="form-input" id="editProductReorder" placeholder="10"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">VAT Category</label>
                    <select class="form-select" id="editProductVat"><option value="16">Standard Rate (16%)</option><option value="0">Zero Rated (0%)</option><option value="exempt">Exempt</option></select>
                </div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('editProductModal')">Cancel</button><button class="modal-btn success" onclick="saveProductEdit()">Save Changes</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="addExpenseModal" onclick="if(event.target===this)closeModal('addExpenseModal')">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ðŸ’¸ Record Expense</h3><button class="modal-close" onclick="closeModal('addExpenseModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="expenseCategory"><option value="Rent">Rent</option><option value="Utilities">Utilities (Electric/Water)</option><option value="Salaries">Salaries & Wages</option><option value="Transport">Transport & Fuel</option><option value="Supplies">Office Supplies</option><option value="Repairs">Repairs & Maintenance</option><option value="Marketing">Marketing & Advertising</option><option value="Licenses">Licenses & Permits</option><option value="Insurance">Insurance</option><option value="Other">Other</option></select></div>
                <div class="form-group"><label class="form-label">Description *</label><input type="text" class="form-input" id="expenseDesc" placeholder="e.g., Monthly electricity bill"></div>
                <div class="form-group"><label class="form-label">Amount (Ksh) *</label><input type="number" class="form-input" id="expenseAmount" placeholder="5000"></div>
                <div class="form-group"><label class="form-label">Receipt/Reference No.</label><input type="text" class="form-input" id="expenseRef" placeholder="Optional"></div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('addExpenseModal')">Cancel</button><button class="modal-btn success" onclick="addExpense()">Record Expense</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="creditSaleModal" onclick="if(event.target===this)closeModal('creditSaleModal')">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ðŸ’³ Credit Sale Details</h3><button class="modal-close" onclick="closeModal('creditSaleModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Customer Name *</label><input type="text" class="form-input" id="creditCustomerName" placeholder="e.g., Mama Njeri"></div>
                <div class="form-group"><label class="form-label">Phone Number *</label><input type="tel" class="form-input" id="creditCustomerPhone" placeholder="07XXXXXXXX"></div>
                <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="creditDueDate"></div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('creditSaleModal')">Cancel</button><button class="modal-btn success" onclick="confirmCreditSale()">Complete Credit Sale</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="paymentModal" onclick="if(event.target===this)closeModal('paymentModal')">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ðŸ’° Record Payment</h3><button class="modal-close" onclick="closeModal('paymentModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="quick-add-product"><div class="quick-add-name" id="paymentCustomer">Customer Name</div><div style="margin:16px 0;padding:16px;background:var(--bg-dark);border-radius:var(--radius-sm)"><span style="color:var(--text-muted)">Outstanding Balance:</span><br><span style="font-size:1.5rem;font-weight:800;color:var(--accent-orange)" id="paymentBalance">Ksh 0</span></div></div>
                <div class="form-group"><label class="form-label">Amount Received (Ksh)</label><input type="number" class="form-input" id="paymentAmount" placeholder="Enter amount" style="font-size:1.2rem;text-align:center"></div>
                <div class="form-group"><label class="form-label">Payment Method</label><select class="form-select" id="paymentMethod"><option value="Cash">Cash</option><option value="M-Pesa">M-Pesa</option></select></div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('paymentModal')">Cancel</button><button class="modal-btn success" onclick="recordCreditPayment()">Record Payment</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="addUserModal" onclick="if(event.target===this)closeModal('addUserModal')">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ðŸ‘¤ Add New User</h3><button class="modal-close" onclick="closeModal('addUserModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Full Name *</label><input type="text" class="form-input" id="newUserName" placeholder="John Doe"></div>
                <div class="form-group"><label class="form-label">Email Address *</label><input type="email" class="form-input" id="newUserEmail" placeholder="user@example.com"></div>
                <div class="form-group"><label class="form-label">Username *</label><input type="text" class="form-input" id="newUserUsername" placeholder="johnd"></div>
                <div class="form-group"><label class="form-label">PIN/Password *</label><input type="password" class="form-input" id="newUserPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
                <div class="form-group"><label class="form-label">Role *</label><select class="form-select" id="newUserRole"><option value="seller">Seller (POS Only)</option><option value="admin">Administrator (Full Access)</option></select></div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('addUserModal')">Cancel</button><button class="modal-btn success" onclick="addNewUser()">Add User</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="resetPasswordModal" onclick="if(event.target===this)closeModal('resetPasswordModal')">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ðŸ”‘ Reset User Password</h3><button class="modal-close" onclick="closeModal('resetPasswordModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="quick-add-product"><div class="quick-add-name" id="resetUserName">User Name</div><div class="quick-add-price" id="resetUserEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="aadfd9cfd8eacfd2cbc7dac6cf84c9c5c7">[email&#160;protected]</a></div></div>
                <div class="form-group"><label class="form-label">New Password *</label><input type="password" class="form-input" id="resetNewPassword" placeholder="Enter new password"></div>
                <div class="form-group"><label class="form-label">Confirm Password *</label><input type="password" class="form-input" id="resetConfirmPassword" placeholder="Confirm new password"></div>
            </div>
            <div class="modal-footer"><button class="modal-btn cancel" onclick="closeModal('resetPasswordModal')">Cancel</button><button class="modal-btn success" onclick="confirmPasswordReset()">Reset Password</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="stkModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ðŸ“± M-Pesa STK Push</h3></div>
            <div class="modal-body" style="text-align:center">
                <p style="color:var(--text-secondary);margin-bottom:12px">Sending payment request to:</p>
                <div style="font-size:1.8rem;font-weight:800;color:var(--accent-green);margin-bottom:8px" id="stkPhone">0712345678</div>
                <div style="font-size:2.2rem;font-weight:800;margin-bottom:24px" id="stkAmount">Ksh 0</div>
                <div id="stkPending" style="padding:24px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:var(--radius-md);margin-bottom:20px">
                    <div style="width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--accent-yellow);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px"></div>
                    <p style="font-weight:600">Waiting for customer to enter PIN...</p>
                    <p style="font-size:.85rem;color:var(--text-muted);margin-top:8px">This may take up to 60 seconds</p>
                </div>
                <div id="stkSuccess" style="display:none;padding:24px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:var(--radius-md)">
                    <div style="font-size:4rem;margin-bottom:8px">âœ“</div>
                    <p style="font-weight:700;color:var(--accent-green);font-size:1.1rem">Payment Confirmed!</p>
                    <p style="color:var(--text-secondary);margin-top:8px" id="stkCode">Transaction: SH12345678</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ADDED: Onboard New Client Modal -->
    <div class="modal-overlay" id="onboardModal">
        <div class="modal">
            <div class="modal-header"><h3>Onboard New Client</h3><button class="modal-close" onclick="closeModal('onboardModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Business Name</label><input type="text" class="form-input" id="onboardName"></div>
                <div class="form-group"><label>Bulk Products (Name | Category | Cost | Price | Stock)</label>
                    <textarea class="form-textarea" id="onboardProducts" rows="6" placeholder="Example:&#10;Milk 1L | Dairy | 80 | 100 | 50&#10;Bread White | Bakery | 40 | 55 | 30"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('onboardModal')">Cancel</button>
                <button class="modal-btn success" onclick="processOnboard()">Add Products</button>
            </div>
        </div>
    </div>
    
    <!-- Subscription Payment Modal -->
    <div class="modal-overlay" id="subscriptionModal" style="z-index:10000">
        <div class="modal">
            <div class="modal-header" style="background:var(--gradient-orange)">
                <h3 class="modal-title" style="color:white">â° Subscription Payment Due</h3>
            </div>
            <div class="modal-body" style="text-align:center">
                <div style="font-size:3rem;margin-bottom:16px">ðŸ’³</div>
                <h3 style="margin-bottom:8px;font-size:1.3rem">Your BiasharaFlow subscription is due</h3>
                <p style="color:var(--text-muted);margin-bottom:24px">To continue using the system, please pay your monthly fee</p>
                
                <div style="background:rgba(251,191,36,0.1);padding:20px;border-radius:12px;margin-bottom:24px;border:2px solid rgba(251,191,36,0.3)">
                    <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px">Amount Due</div>
                    <div style="font-size:2.5rem;font-weight:800;color:#f59e0b" id="subscriptionAmount">KSh 1,500</div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px">Monthly Maintenance Fee</div>
                </div>
                
                <div style="background:rgba(16,185,129,0.1);padding:16px;border-radius:8px;margin-bottom:16px;text-align:left">
                    <div style="font-size:0.9rem;font-weight:600;margin-bottom:12px;color:var(--accent-green)">ðŸ“± M-Pesa Payment Instructions</div>
                    <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6">
                        1. Go to M-Pesa on your phone<br>
                        2. Select Lipa Na M-Pesa â†’ Buy Goods & Services<br>
                        3. Enter Till Number: <strong id="subsTillNumber" style="color:var(--text-primary);font-family:'JetBrains Mono',monospace">000000</strong><br>
                        4. Enter Amount: <strong style="color:var(--text-primary)">1500</strong><br>
                        5. Enter your M-Pesa PIN and confirm
                    </div>
                </div>
                
                <div class="form-group" style="margin-top:20px">
                    <label class="form-label">Enter your M-Pesa Phone Number</label>
                    <input type="tel" class="form-input" id="subsPhoneNumber" placeholder="07XXXXXXXX" maxlength="10" style="text-align:center;font-size:1.1rem;letter-spacing:1px">
                </div>
                
                <div style="background:rgba(59,130,246,0.1);padding:12px;border-radius:8px;margin-top:16px;font-size:0.8rem;color:var(--text-secondary);text-align:left">
                    <strong style="color:#3b82f6">â„¹ï¸ Note:</strong> After payment, enter your phone number above and click "Verify Payment". The system will check and activate your subscription automatically.
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn success" onclick="verifySubscriptionPayment()" style="width:100%">âœ“ I Have Paid - Verify Payment</button>
                <button class="modal-btn cancel" onclick="closeSubscriptionModal()" style="width:100%;margin-top:8px">Cancel (Limited Access)</button>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        // âš ï¸ IMPORTANT: Replace this with YOUR Firebase config after setup!
        // Get it from: Firebase Console â†’ Project Settings â†’ Your apps â†’ Config
        const firebaseConfig = {
            apiKey: "AIzaSyBFIym52ZFkqqVZ6vuHplDjL8IJ0TZEzC8",
            authDomain: "biasharaflow-pos.firebaseapp.com",
            projectId: "biasharaflow-pos",
            storageBucket: "biasharaflow-pos.firebasestorage.app",
            messagingSenderId: "107440683990",
            appId: "1:107440683990:web:398c54ab823a814399c277"
        };
        
        // Initialize Firebase
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('âœ… Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showToast('Firebase not configured. See setup guide.', 'warning');
        }
        
        // Global variables for Firebase operations
        let confirmationResult = null;
        let recaptchaVerifier = null;
        
        // ==================== DUKAPOS PRO v3.0 (Firebase Edition) ====================
        // CLOUD-POWERED FEATURES:
        // - Phone authentication with SMS verification (FREE 10/day from Firebase)
        // - Real-time multi-device sync via Firestore
        // - Never lose data - stored in Google Cloud
        // - Works across all devices automatically
        // - 100% FREE for small to medium shops
        
        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let config = { 
            businessName: 'BiasharaFlow Business',
            businessId: '', // Unique ID for cloud sync
            cloudSyncEnabled: false,
            cloudSyncUrl: '', // Backend API URL
            kraPin: '', 
            phone: '', 
            mpesaTill: '',
            mpesaPaybillNumber: '',
            mpesaPaybillAccount: '',
            mpesaPochi: '',
            mpesaSend: '',
            vatRate: 16,
            // ADDED: IntaSend API configuration
            intasendEnabled: false,
            intasendPublicKey: '',
            intasendSecretKey: '',
            intasendEnvironment: 'test', // 'test' or 'live'
            // ADDED: Subscription management
            subscriptionStatus: 'trial', // 'trial', 'active', 'expired', 'suspended'
            subscriptionStartDate: null, // Date when subscription started
            subscriptionLastPayment: null, // Last payment date
            subscriptionNextDue: null, // Next payment due date
            subscriptionFee: 1500, // Monthly fee in KSh
            isRealUser: false, // Track if demo or real user
            // Payment details for subscription collection
            adminMpesaTill: '', // Your till number for collecting subscription fees
            adminMpesaPaybill: '',
            adminMpesaAccount: ''
        };
        let users = [
            { id: 1, name: 'Admin User', email: 'admin@biasharaflow.demo', username: 'admin', password: 'demo2024', role: 'admin', status: 'active', lastLogin: null },
            { id: 2, name: 'Sales Staff', email: 'seller@biasharaflow.demo', username: 'seller', password: 'demo2024', role: 'seller', status: 'active', lastLogin: null }
        ];
        let products = [], sales = [], creditSales = [], expenses = [], categories = [], suppliers = [], journalEntries = [];
        let cart = [], selectedPayment = 'Cash', selectedCategory = 'All', quickAddProduct = null, quickAddQty = 1;
        let restockProduct = null, restockMode = false, mpesaConfirmed = false, mpesaData = null;
        let paymentCreditId = null, dateFilter = 'today', isOnline = navigator.onLine;
        let charts = {};
        
        const STORAGE_KEYS = { 
            config: 'dpos_config', 
            users: 'dpos_users', 
            products: 'dpos_products', 
            sales: 'dpos_sales', 
            credit: 'dpos_credit', 
            expenses: 'dpos_expenses', 
            categories: 'dpos_categories', 
            suppliers: 'dpos_suppliers', 
            journal: 'dpos_journal',
            businessId: 'dpos_business_id' // Store business ID separately
        };
        
        // ==================== INITIALIZATION ====================
        window.addEventListener('load', init);
        window.addEventListener('online', () => { isOnline = true; document.getElementById('offlineIndicator').classList.remove('show'); });
        window.addEventListener('offline', () => { isOnline = false; document.getElementById('offlineIndicator').classList.add('show'); });
        
        function init() {
            loadAllData();
            updateTime();
            setInterval(updateTime, 1000);
            if (!isOnline) document.getElementById('offlineIndicator').classList.add('show');
            
            // Hide demo accounts if real user exists
            updateDemoVisibility();
            
            // Initialize Admin login button as selected by default
            setTimeout(() => {
                selectLoginType('admin');
            }, 100);
            
            // Check if user is already logged in
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
                // Check subscription status after login
                checkSubscriptionStatus();
            }
        }
        
        function loadAllData() {
            config = JSON.parse(localStorage.getItem(STORAGE_KEYS.config)) || config;
            
            // Load or generate business ID
            let businessId = localStorage.getItem(STORAGE_KEYS.businessId);
            if (!businessId && config.businessId) {
                businessId = config.businessId;
                localStorage.setItem(STORAGE_KEYS.businessId, businessId);
            } else if (businessId) {
                config.businessId = businessId;
            }
            
            users = JSON.parse(localStorage.getItem(STORAGE_KEYS.users)) || users;
            
            // Migration: Add email to old users if missing
            let needsUpdate = false;
            users = users.map(user => {
                if (!user.email) {
                    needsUpdate = true;
                    // Generate default email based on username
                    return { ...user, email: `${user.username}@dukapos.com` };
                }
                // Add businessId to users if missing
                if (!user.businessId && businessId) {
                    needsUpdate = true;
                    return { ...user, businessId: businessId };
                }
                return user;
            });
            
            // Save updated users if migration occurred
            if (needsUpdate) {
                localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(users));
            }
            
            products = JSON.parse(localStorage.getItem(STORAGE_KEYS.products)) || [];
            sales = JSON.parse(localStorage.getItem(STORAGE_KEYS.sales)) || [];
            creditSales = JSON.parse(localStorage.getItem(STORAGE_KEYS.credit)) || [];
            expenses = JSON.parse(localStorage.getItem(STORAGE_KEYS.expenses)) || [];
            categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.categories)) || [];
            suppliers = JSON.parse(localStorage.getItem(STORAGE_KEYS.suppliers)) || [];
            journalEntries = JSON.parse(localStorage.getItem(STORAGE_KEYS.journal)) || [];
            
            // Try to sync from cloud if enabled
            if (config.cloudSyncEnabled && config.businessId) {
                syncFromCloud();
            }
        }
        
        function saveAllData() {
            localStorage.setItem(STORAGE_KEYS.config, JSON.stringify(config));
            localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(users));
            localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEYS.sales, JSON.stringify(sales));
            localStorage.setItem(STORAGE_KEYS.credit, JSON.stringify(creditSales));
            localStorage.setItem(STORAGE_KEYS.expenses, JSON.stringify(expenses));
            localStorage.setItem(STORAGE_KEYS.categories, JSON.stringify(categories));
            localStorage.setItem(STORAGE_KEYS.suppliers, JSON.stringify(suppliers));
            localStorage.setItem(STORAGE_KEYS.journal, JSON.stringify(journalEntries));
            
            // Auto-sync to cloud if business ID exists (user is logged in with Firebase)
            if (config.businessId && db) {
                syncToCloud();
            }
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' });
        }
        
        // ==================== AUTHENTICATION ====================
        async function handleLogin() {
            console.log('Login button clicked');
            const emailOrUsername = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Clear previous error
            hideLoginError();
            
            if (!emailOrUsername || !password) { 
                showLoginError('Please enter email/username and password');
                return; 
            }
            
            // Show loading spinner
            showLoginLoading();
            
            // Check for demo accounts FIRST
            const demoAccounts = {
                'admin@biasharaflow.demo': { password: 'demo2024', role: 'admin', name: 'Demo Admin', username: 'demoadmin' },
                'seller@biasharaflow.demo': { password: 'demo2024', role: 'seller', name: 'Demo Seller', username: 'demoseller' }
            };
            
            if (demoAccounts[emailOrUsername] && demoAccounts[emailOrUsername].password === password) {
                const demoUser = demoAccounts[emailOrUsername];
                const selectedType = document.getElementById('selectedLoginType').value;
                
                if (demoUser.role !== selectedType) {
                    hideLoginLoading();
                    showLoginError(`This is a ${demoUser.role} account. Please select the correct login type.`);
                    return;
                }
                
                // Simulate network delay for realistic feel
                setTimeout(() => {
                    hideLoginLoading();
                    handleDemoLogin(demoUser);
                }, 1500);
                return;
            }
            
            // Check if offline or Firebase not configured
            if (!navigator.onLine || !auth || !db) {
                console.log('Offline mode or Firebase not configured - using local login');
                showToast(navigator.onLine ? 'Firebase not configured! Using demo mode.' : 'Offline mode - using local data', 'warning');
                setTimeout(() => {
                    hideLoginLoading();
                    handleLocalLogin(emailOrUsername, password);
                }, 1000);
                return;
            }
            
            try {
                // If it looks like an email, use Firebase auth
                const isEmail = emailOrUsername.includes('@');
                
                if (isEmail) {
                    // Try Firebase email login
                    const userCredential = await auth.signInWithEmailAndPassword(emailOrUsername, password);
                    const firebaseUser = userCredential.user;
                    
                    // Get user data from Firestore
                    const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                    
                    if (!userDoc.exists) {
                        hideLoginLoading();
                        showLoginError('User data not found');
                        await auth.signOut();
                        return;
                    }
                    
                    const userData = userDoc.data();
                    
                    // Sync password to Firestore if it's different (e.g., after password reset)
                    if (userData.password !== password) {
                        try {
                            await db.collection('users').doc(firebaseUser.uid).update({
                                password: password,
                                passwordLastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log('Password synced to Firestore');
                        } catch (error) {
                            console.error('Failed to sync password:', error);
                        }
                    }
                    
                    // Validate user role matches selected login type
                    const selectedType = document.getElementById('selectedLoginType').value;
                    if (userData.role !== selectedType) {
                        hideLoginLoading();
                        showLoginError(`This account is ${userData.role === 'admin' ? 'an Admin' : 'a Seller'}. Please select the correct login type.`);
                        await auth.signOut();
                        return;
                    }
                    
                    // Load business data
                    await loadUserData(userData.businessId);
                    
                    hideLoginLoading();
                    // Show app
                    showApp(userData.name, userData.username, userData.role, userData.businessId);
                    showToast(`Welcome back, ${userData.name}!`, 'success');
                    
                } else {
                    // Username login - need to find user by username in Firestore to get their email
                    const usersSnapshot = await db.collection('users')
                        .where('username', '==', emailOrUsername)
                        .limit(1)
                        .get();
                    
                    if (usersSnapshot.empty) {
                        hideLoginLoading();
                        showLoginError('Invalid username or password');
                        return;
                    }
                    
                    const userData = usersSnapshot.docs[0].data();
                    const userEmail = userData.email;
                    
                    // Sign in with Firebase using the email and password
                    // This will validate against Firebase Auth (which has the updated password after reset)
                    try {
                        const userCredential = await auth.signInWithEmailAndPassword(userEmail, password);
                        const firebaseUser = userCredential.user;
                        
                        // Sync password to Firestore if it's different (e.g., after password reset)
                        if (userData.password !== password) {
                            try {
                                await db.collection('users').doc(firebaseUser.uid).update({
                                    password: password,
                                    passwordLastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                console.log('Password synced to Firestore');
                            } catch (error) {
                                console.error('Failed to sync password:', error);
                            }
                        }
                        
                        // Validate user role matches selected login type
                        const selectedType = document.getElementById('selectedLoginType').value;
                        if (userData.role !== selectedType) {
                            hideLoginLoading();
                            showLoginError(`This account is ${userData.role === 'admin' ? 'an Admin' : 'a Seller'}. Please select the correct login type.`);
                            await auth.signOut();
                            return;
                        }
                        
                        // Load business data
                        await loadUserData(userData.businessId);
                        
                        hideLoginLoading();
                        // Show app
                        showApp(userData.name, userData.username, userData.role, userData.businessId);
                        showToast(`Welcome back, ${userData.name}!`, 'success');
                    } catch (authError) {
                        hideLoginLoading();
                        // If Firebase auth fails, it means wrong password
                        if (authError.code === 'auth/wrong-password') {
                            showLoginError('Wrong password. Please try again.');
                        } else {
                            showLoginError('Login failed. Please try again.');
                        }
                        return;
                    }
                }
                
            } catch (error) {
                console.error('Login Error:', error);
                
                // If network error or Firebase unavailable, try local login
                if (error.code === 'auth/network-request-failed' || error.message.includes('network') || error.message.includes('offline')) {
                    console.log('Network error detected - switching to offline mode');
                    showToast('Network error - trying offline mode...', 'warning');
                    setTimeout(() => {
                        hideLoginLoading();
                        handleLocalLogin(emailOrUsername, password);
                    }, 1000);
                    return;
                }
                
                hideLoginLoading();
                
                // Clear, user-friendly error messages
                let errorMsg = '';
                
                if (error.code === 'auth/user-not-found') {
                    errorMsg = 'No account found with this email. Please check your email or sign up.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMsg = 'Wrong password. Please try again or reset your password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'Invalid email format. Please enter a valid email address.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMsg = 'Invalid email or password. Please try again.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMsg = 'Too many failed attempts. Please try again in a few minutes.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMsg = 'This account has been disabled. Contact support.';
                } else {
                    errorMsg = 'Login failed. ' + (error.message || 'Please try again.');
                }
                
                showLoginError(errorMsg);
            }
        }
        
        // Helper function for demo account login
        function handleDemoLogin(demoUser) {
            // Load comprehensive demo data (1 year past + 3 months future)
            loadExtendedDemoData();
            
            currentUser = {
                id: 'DEMO_' + demoUser.role.toUpperCase(),
                name: demoUser.name,
                username: demoUser.username,
                email: demoUser.role + '@biasharaflow.demo',
                role: demoUser.role,
                status: 'active',
                businessId: 'DEMO_BUSINESS',
                lastLogin: new Date().toISOString()
            };
            
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('lastLoggedUser', JSON.stringify(currentUser));
            
            showApp();
            showToast(`Welcome to Demo Mode, ${demoUser.name}! ðŸ“Š Loaded 15 months of sample data`, 'success');
        }
        
        // Extended demo data loader - 1 year past + 3 months future
        function loadExtendedDemoData() {
            // Business configuration
            config = { 
                businessName: 'Demo Supermarket - Nairobi CBD', 
                kraPin: 'P051234567X', 
                phone: '0712345678', 
                mpesaTill: '7028833',
                mpesaPaybillNumber: '400200',
                mpesaPaybillAccount: 'DEMO2024',
                vatRate: 16,
                receiptFooter: 'Thank you for your business! Karibu tena.',
                isRealUser: false,
                businessId: 'DEMO_BUSINESS'
            };
            
            // Comprehensive categories
            categories = ['Maize Flour', 'Sugar', 'Rice', 'Cooking Oil', 'Milk', 'Tea', 'Coffee', 'Soft Drinks', 'Water', 'Bread', 'Soap', 'Detergent', 'Snacks', 'Cereals', 'Spices', 'Pasta', 'Beans'];
            
            // Extensive product catalog
            products = [
                {id:'P001',sku:'MAI10245',name:'Jogoo Maize Flour 2kg',category:'Maize Flour',cost:165,price:185,stock:50,reorder:20,vat:16},
                {id:'P002',sku:'MAI10352',name:'Pembe Maize Flour 2kg',category:'Maize Flour',cost:158,price:175,stock:45,reorder:15,vat:16},
                {id:'P003',sku:'MAI10468',name:'Exe Maize Flour 2kg',category:'Maize Flour',cost:162,price:180,stock:38,reorder:15,vat:16},
                {id:'P004',sku:'SUG20145',name:'Mumias Sugar 1kg',category:'Sugar',cost:145,price:165,stock:60,reorder:25,vat:16},
                {id:'P005',sku:'SUG20256',name:'Kabras Sugar 1kg',category:'Sugar',cost:142,price:162,stock:55,reorder:20,vat:16},
                {id:'P006',sku:'SUG20378',name:'Sony Sugar 1kg',category:'Sugar',cost:140,price:160,stock:48,reorder:20,vat:16},
                {id:'P007',sku:'RIC30125',name:'Pishori Rice 1kg',category:'Rice',cost:180,price:220,stock:40,reorder:15,vat:16},
                {id:'P008',sku:'RIC30247',name:'Sindano Rice 1kg',category:'Rice',cost:120,price:150,stock:52,reorder:15,vat:16},
                {id:'P009',sku:'RIC30389',name:'Basmati Rice 1kg',category:'Rice',cost:250,price:300,stock:25,reorder:10,vat:16},
                {id:'P010',sku:'OIL40156',name:'Elianto Cooking Oil 1L',category:'Cooking Oil',cost:280,price:320,stock:35,reorder:15,vat:16},
                {id:'P011',sku:'OIL40278',name:'Fresh Fri Cooking Oil 2L',category:'Cooking Oil',cost:520,price:600,stock:28,reorder:12,vat:16},
                {id:'P012',sku:'OIL40391',name:'Kimbo 500g',category:'Cooking Oil',cost:180,price:210,stock:42,reorder:15,vat:16},
                {id:'P013',sku:'MLK50134',name:'Brookside Fresh Milk 500ml',category:'Milk',cost:55,price:70,stock:50,reorder:30,vat:0},
                {id:'P014',sku:'MLK50245',name:'Tuzo UHT Milk 500ml',category:'Milk',cost:52,price:68,stock:60,reorder:35,vat:0},
                {id:'P015',sku:'TEA60123',name:'Ketepa Tea 100g',category:'Tea',cost:110,price:140,stock:40,reorder:20,vat:16},
                {id:'P016',sku:'TEA60234',name:'Chai ya Baba Tea 100g',category:'Tea',cost:95,price:125,stock:35,reorder:18,vat:16},
                {id:'P017',sku:'COF70145',name:'Dormans Coffee 100g',category:'Coffee',cost:180,price:230,stock:20,reorder:10,vat:16},
                {id:'P018',sku:'SDK80167',name:'Coca Cola 500ml',category:'Soft Drinks',cost:60,price:80,stock:48,reorder:24,vat:16},
                {id:'P019',sku:'SDK80278',name:'Fanta Orange 500ml',category:'Soft Drinks',cost:58,price:75,stock:36,reorder:20,vat:16},
                {id:'P020',sku:'SDK80389',name:'Sprite 500ml',category:'Soft Drinks',cost:58,price:75,stock:40,reorder:20,vat:16},
                {id:'P021',sku:'WAT90123',name:'Keringet Water 500ml',category:'Water',cost:25,price:40,stock:60,reorder:30,vat:16},
                {id:'P022',sku:'WAT90234',name:'Dasani Water 500ml',category:'Water',cost:28,price:45,stock:55,reorder:28,vat:16},
                {id:'P023',sku:'BRD10145',name:'Supa Loaf Bread 400g',category:'Bread',cost:52,price:65,stock:20,reorder:10,vat:0},
                {id:'P024',sku:'BRD10256',name:'Festive Bread 450g',category:'Bread',cost:55,price:68,stock:18,reorder:10,vat:0},
                {id:'P025',sku:'SOP11167',name:'Jamaa Bar Soap',category:'Soap',cost:45,price:60,stock:100,reorder:30,vat:16},
                {id:'P026',sku:'SOP11278',name:'Geisha Bar Soap',category:'Soap',cost:48,price:63,stock:85,reorder:28,vat:16},
                {id:'P027',sku:'DET12189',name:'Omo Detergent 500g',category:'Detergent',cost:120,price:150,stock:45,reorder:15,vat:16},
                {id:'P028',sku:'DET12290',name:'Ariel Detergent 500g',category:'Detergent',cost:125,price:155,stock:38,reorder:12,vat:16},
                {id:'P029',sku:'SNK13101',name:'Tropical Heat Crisps',category:'Snacks',cost:10,price:20,stock:150,reorder:50,vat:16},
                {id:'P030',sku:'SNK13212',name:'Big G Peanuts 50g',category:'Snacks',cost:15,price:30,stock:120,reorder:40,vat:16}
            ];
            
            // Generate sales for last 12 months + next 3 months (15 months total)
            const today = new Date();
            sales = [];
            let saleIdCounter = 1000;
            
            // Past 12 months of data
            for (let monthsAgo = 12; monthsAgo >= 0; monthsAgo--) {
                const monthDate = new Date(today);
                monthDate.setMonth(monthDate.getMonth() - monthsAgo);
                const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const saleDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), day);
                    const dateStr = saleDate.toISOString().split('T')[0];
                    
                    // Generate 10-30 sales per day
                    const numSales = 10 + Math.floor(Math.random() * 20);
                    
                    for (let i = 0; i < numSales; i++) {
                        const numItems = 1 + Math.floor(Math.random() * 4); // 1-4 items per sale
                        const items = [];
                        let subtotal = 0;
                        let totalVat = 0;
                        let totalCost = 0;
                        
                        for (let j = 0; j < numItems; j++) {
                            const p = products[Math.floor(Math.random() * products.length)];
                            const qty = 1 + Math.floor(Math.random() * 3);
                            const itemSubtotal = p.price * qty;
                            const itemVat = p.vat === 16 ? Math.round(itemSubtotal * 16 / 116) : 0;
                            
                            items.push({
                                productId: p.id,
                                name: p.name,
                                qty: qty,
                                price: p.price,
                                cost: p.cost,
                                vat: p.vat
                            });
                            
                            subtotal += itemSubtotal;
                            totalVat += itemVat;
                            totalCost += p.cost * qty;
                        }
                        
                        const paymentMethods = ['Cash', 'M-Pesa', 'M-Pesa', 'Cash', 'Credit']; // More M-Pesa
                        const hour = 7 + Math.floor(Math.random() * 13); // 7 AM to 8 PM
                        const minute = Math.floor(Math.random() * 60);
                        
                        sales.push({
                            id: 'S' + (saleIdCounter++),
                            date: dateStr,
                            time: `${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}`,
                            items: items,
                            subtotal: subtotal,
                            vat: totalVat,
                            total: subtotal,
                            profit: subtotal - totalCost,
                            paymentMethod: paymentMethods[Math.floor(Math.random() * paymentMethods.length)],
                            cashier: Math.random() > 0.5 ? 'Demo Admin' : 'Demo Seller'
                        });
                    }
                }
            }
            
            // Future 3 months of projected data (lighter sales)
            for (let monthsAhead = 1; monthsAhead <= 3; monthsAhead++) {
                const futureMonth = new Date(today);
                futureMonth.setMonth(futureMonth.getMonth() + monthsAhead);
                const daysInMonth = new Date(futureMonth.getFullYear(), futureMonth.getMonth() + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const saleDate = new Date(futureMonth.getFullYear(), futureMonth.getMonth(), day);
                    const dateStr = saleDate.toISOString().split('T')[0];
                    
                    // Projected sales (fewer, for forecasting)
                    const numSales = 5 + Math.floor(Math.random() * 10);
                    
                    for (let i = 0; i < numSales; i++) {
                        const p = products[Math.floor(Math.random() * products.length)];
                        const qty = 1 + Math.floor(Math.random() * 2);
                        const itemSubtotal = p.price * qty;
                        const itemVat = p.vat === 16 ? Math.round(itemSubtotal * 16 / 116) : 0;
                        
                        sales.push({
                            id: 'SF' + (saleIdCounter++), // F for Future
                            date: dateStr,
                            time: '12:00',
                            items: [{
                                productId: p.id,
                                name: p.name,
                                qty: qty,
                                price: p.price,
                                cost: p.cost,
                                vat: p.vat
                            }],
                            subtotal: itemSubtotal,
                            vat: itemVat,
                            total: itemSubtotal,
                            profit: (p.price - p.cost) * qty,
                            paymentMethod: 'Cash',
                            cashier: 'Projected'
                        });
                    }
                }
            }
            
            // Credit sales
            creditSales = [
                { id: 'CR1', customer: 'Mama Njeri', phone: '0712345678', amount: 2500, paid: 1000, date: getTodayDate(), dueDate: '2026-02-15' },
                { id: 'CR2', customer: 'John Kamau', phone: '0722111222', amount: 4200, paid: 2000, date: getTodayDate(), dueDate: '2026-02-20' },
                { id: 'CR3', customer: 'Wanjiku Stores', phone: '0733444555', amount: 8500, paid: 5000, date: '2025-12-15', dueDate: '2026-01-15' },
                { id: 'CR4', customer: 'Peter Ochieng', phone: '0744666777', amount: 3200, paid: 3200, date: '2025-11-20', dueDate: '2025-12-20' },
                { id: 'CR5', customer: 'Grace Muthoni', phone: '0755888999', amount: 5600, paid: 2000, date: getTodayDate(), dueDate: '2026-03-01' }
            ];
            
            // Expenses across the year
            expenses = [];
            let expenseId = 1;
            for (let monthsAgo = 12; monthsAgo >= 0; monthsAgo--) {
                const expMonth = new Date(today);
                expMonth.setMonth(expMonth.getMonth() - monthsAgo);
                const dateStr = expMonth.toISOString().split('T')[0];
                
                // Monthly recurring expenses
                expenses.push(
                    { id: 'E' + (expenseId++), date: dateStr, category: 'Rent', description: 'Monthly shop rent', amount: 25000, ref: 'RNT-' + expenseId, recordedBy: 'Admin' },
                    { id: 'E' + (expenseId++), date: dateStr, category: 'Utilities', description: 'Electricity bill - KPLC', amount: 2500 + Math.floor(Math.random() * 1500), ref: 'KPLC-' + expenseId, recordedBy: 'Admin' },
                    { id: 'E' + (expenseId++), date: dateStr, category: 'Salaries', description: 'Staff salaries', amount: 35000, ref: 'SAL-' + expenseId, recordedBy: 'Admin' }
                );
                
                // Random occasional expenses
                if (Math.random() > 0.5) {
                    expenses.push(
                        { id: 'E' + (expenseId++), date: dateStr, category: 'Transport', description: 'Stock delivery', amount: 1500 + Math.floor(Math.random() * 1000), ref: '', recordedBy: 'Admin' }
                    );
                }
                if (Math.random() > 0.7) {
                    expenses.push(
                        { id: 'E' + (expenseId++), date: dateStr, category: 'Maintenance', description: 'Shop repairs', amount: 3000 + Math.floor(Math.random() * 5000), ref: '', recordedBy: 'Admin' }
                    );
                }
            }
            
            // Suppliers
            suppliers = [
                { id: 'SUP1', name: 'Unga Group Ltd', contact: 'James Mwangi', phone: '0720123456', email: 'sales@unga.co.ke', products: 'Maize Flour, Wheat Flour' },
                { id: 'SUP2', name: 'Mumias Sugar Company', contact: 'Mary Akinyi', phone: '0733987654', email: 'orders@mumias.co.ke', products: 'Sugar, Sweeteners' },
                { id: 'SUP3', name: 'Bidco Africa', contact: 'David Otieno', phone: '0744556677', email: 'sales@bidco.co.ke', products: 'Cooking Oil, Soap, Detergents' },
                { id: 'SUP4', name: 'Brookside Dairy', contact: 'Sarah Wangari', phone: '0755889900', email: 'orders@brookside.co.ke', products: 'Milk, Dairy Products' },
                { id: 'SUP5', name: 'KWAL Beverages', contact: 'Simon Mutua', phone: '0766112233', email: 'sales@coca-cola.co.ke', products: 'Soft Drinks, Water' }
            ];
            
            // Journal entries (sample accounting entries)
            journalEntries = [
                { id: 'J001', date: getTodayDate(), description: 'Monthly sales revenue', debit: 'Cash', credit: 'Sales Revenue', amount: 450000, ref: 'Monthly closing' },
                { id: 'J002', date: getTodayDate(), description: 'Rent expense payment', debit: 'Rent Expense', credit: 'Cash', amount: 25000, ref: 'RNT-001' }
            ];
            
            saveAllData();
        }
        
        // Helper functions for login UI
        function showLoginLoading() {
            const loading = document.getElementById('loginLoading');
            if (loading) loading.classList.add('show');
        }
        
        function hideLoginLoading() {
            const loading = document.getElementById('loginLoading');
            if (loading) loading.classList.remove('show');
        }
        
        function showLoginError(message) {
            console.log('ðŸ”´ Login Error:', message); // Debug log
            const errorEl = document.getElementById('loginError');
            if (errorEl) {
                errorEl.textContent = 'âŒ ' + message;
                errorEl.classList.add('show');
                errorEl.style.display = 'block'; // Force display
                
                // Auto-hide after 8 seconds
                setTimeout(() => {
                    if (errorEl.classList.contains('show')) {
                        hideLoginError();
                    }
                }, 8000);
            } else {
                console.error('Error element not found!');
            }
        }
        
        function hideLoginError() {
            const errorEl = document.getElementById('loginError');
            if (errorEl) {
                errorEl.classList.remove('show');
                errorEl.style.display = 'none';
                errorEl.textContent = '';
            }
        }
        
        // Fallback local login (for demo mode)
        function handleLocalLogin(username, password) {
            let user = users.find(u => (u.username === username || u.email === username) && u.password === password);
            
            if (!user) {
                const allKeys = Object.keys(localStorage);
                for (const key of allKeys) {
                    if (key.startsWith('cloud_BIZ')) {
                        try {
                            const cloudData = JSON.parse(localStorage.getItem(key));
                            const cloudUser = cloudData.users?.find(u => 
                                (u.username === username || u.email === username) && u.password === password
                            );
                            
                            if (cloudUser) {
                                config.businessId = cloudData.businessId;
                                config = { ...config, ...cloudData.config };
                                users = cloudData.users || users;
                                products = cloudData.products || [];
                                sales = cloudData.sales || [];
                                creditSales = cloudData.creditSales || [];
                                expenses = cloudData.expenses || [];
                                saveAllData();
                                user = cloudUser;
                                showToast(`Welcome back ${user.name}! Loaded your business data.`, 'success');
                                break;
                            }
                        } catch (e) {
                            console.error('Error checking cloud business:', e);
                        }
                    }
                }
            }
            
            if (user) {
                if (user.status !== 'active') { 
                    showLoginError('Account is inactive');
                    return; 
                }
                
                // Validate user role matches selected login type
                const selectedType = document.getElementById('selectedLoginType').value;
                if (user.role !== selectedType) {
                    showLoginError(`This account is ${user.role === 'admin' ? 'an Admin' : 'a Seller'}. Please select the correct login type.`);
                    return;
                }
                
                user.lastLogin = new Date().toISOString();
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                localStorage.setItem('lastLoggedUser', JSON.stringify(user)); // Persist across page refreshes
                saveAllData();
                
                if (config.businessId) {
                    syncToCloud();
                }
                
                showApp();
                showToast(`Welcome back, ${user.name}!`, 'success');
            } else {
                showLoginError('Wrong email or password. Try again.');
            }
        }
        
        function showAuthScreen(screen) {
            document.querySelectorAll('.auth-screen').forEach(s => s.classList.remove('active'));
            if (screen === 'login') {
                document.getElementById('loginForm').classList.add('active');
            } else if (screen === 'forgotPassword') {
                document.getElementById('forgotPasswordForm').classList.add('active');
            } else if (screen === 'firstSetup') {
                document.getElementById('firstSetupForm').classList.add('active');
            }
        }
        
        // REMOVED: Public signup disabled - admin creates users now
        function handleSignup() {
            showToast('Public signup disabled. Contact administrator for account creation.', 'error');
            return;
        }
        
        async function handleFirstTimeSetup() {
            const businessName = document.getElementById('setupBusinessName').value.trim();
            const name = document.getElementById('setupName').value.trim();
            const email = document.getElementById('setupEmail').value.trim();
            const phone = document.getElementById('setupPhone').value.trim();
            const username = document.getElementById('setupUsername').value.trim();
            const password = document.getElementById('setupPassword').value;
            const passwordConfirm = document.getElementById('setupPasswordConfirm').value;
            const secretKey = document.getElementById('setupSecretKey').value.trim();
            
            // CRITICAL: Validate admin authorization key FIRST
            const ADMIN_SECRET_KEY = 'BF2024ADMIN';  // Change this to your own secret key
            if (secretKey !== ADMIN_SECRET_KEY) {
                showToast('âŒ Invalid authorization key. Contact the system administrator.', 'error');
                return;
            }
            
            // Validation
            if (!businessName || !name || !email || !username || !password || !passwordConfirm) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            if (!username.match(/^[a-zA-Z0-9_]{3,20}$/)) {
                showToast('Username: 3-20 characters, letters/numbers only', 'error');
                return;
            }
            
            // Check if Firebase is configured
            if (!auth || !db) {
                showToast('Firebase not configured! Check setup guide.', 'error');
                return;
            }
            
            try {
                showToast('Creating your account...', 'info');
                
                // Create Firebase user with email/password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const firebaseUser = userCredential.user;
                
                showToast('âœ… Account created! Setting up your business...', 'success');
                
                // Generate unique business ID
                const businessId = 'BIZ' + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
                
                // Create business document in Firestore
                await db.collection('businesses').doc(businessId).set({
                    name: businessName,
                    ownerId: firebaseUser.uid,
                    ownerEmail: email,
                    ownerPhone: phone || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                
                // Create user document
                await db.collection('users').doc(firebaseUser.uid).set({
                    businessId: businessId,
                    name: name,
                    username: username,
                    password: password,
                    email: email,
                    phone: phone || '',
                    role: 'admin',
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create initial empty data document
                await db.collection('data').doc(businessId).set({
                    products: [],
                    sales: [],
                    creditSales: [],
                    expenses: [],
                    categories: [],
                    suppliers: [],
                    config: {
                        businessName: businessName,
                        phone: phone || '',
                        email: email,
                        businessId: businessId,
                        cloudSyncEnabled: true, // Enable cloud sync for new accounts
                        vatRate: 16,
                        isRealUser: true, // Mark as real user
                        subscriptionStatus: 'trial',
                        subscriptionStartDate: new Date().toISOString(),
                        subscriptionNextDue: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days from now
                        subscriptionLastPayment: new Date().toISOString(),
                        subscriptionFee: 1500
                    },
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local config
                config.isRealUser = true;
                config.subscriptionStatus = 'trial';
                config.subscriptionStartDate = new Date().toISOString();
                config.subscriptionNextDue = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();
                config.subscriptionLastPayment = new Date().toISOString();
                saveAllData();
                
                // Store in localStorage for quick access
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: firebaseUser.uid,
                    businessId: businessId,
                    username: username,
                    name: name,
                    email: email,
                    role: 'admin'
                }));
                
                showToast(`ðŸŽ‰ Welcome ${name}! 30-Day Trial Started!`, 'success');
                
                // Load user data and show app
                await loadUserData(businessId);
                showApp(name, username, 'admin', businessId);
                
            } catch (error) {
                console.error('Signup Error:', error);
                let errorMsg = 'Failed to create account. ';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg += 'This email is already registered.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg += 'Invalid email format.';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg += 'Password is too weak.';
                } else {
                    errorMsg += error.message;
                }
                
                showToast(errorMsg, 'error');
            }
        }
        
        async function handleForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            
            if (!email) {
                showToast('Please enter your email address', 'error');
                return;
            }
            
            // Check if Firebase Auth is configured
            if (!auth) {
                // Fallback for demo mode - check local users
                const user = users.find(u => u.email === email);
                
                if (user) {
                    showToast('Demo Mode: Password reset not available', 'warning');
                    console.log(`Demo: Password for ${email}: ${user.password}`);
                    setTimeout(() => {
                        showToast(`Demo: Your password is "${user.password}"`, 'info', 'Password Retrieved');
                    }, 1000);
                } else {
                    showToast('No account found with this email', 'error');
                }
                
                setTimeout(() => {
                    showAuthScreen('login');
                    document.getElementById('forgotEmail').value = '';
                }, 3000);
                return;
            }
            
            try {
                // Use Firebase's built-in password reset email functionality
                showToast('Sending password reset email...', 'info');
                
                console.log('Attempting to send password reset to:', email);
                await auth.sendPasswordResetEmail(email);
                
                showToast('âœ… Password reset email sent!', 'success', 'Check Your Email');
                console.log('Password reset email sent successfully to:', email);
                
                setTimeout(() => {
                    showToast('ðŸ“§ After resetting your password, login with your new password. Your password will be automatically synced.', 'info');
                }, 1500);
                
                // Go back to login after showing success
                setTimeout(() => {
                    showAuthScreen('login');
                    document.getElementById('forgotEmail').value = '';
                }, 4000);
                
            } catch (error) {
                console.error('Password reset error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                let errorMsg = 'Failed to send reset email. ';
                
                if (error.code === 'auth/user-not-found') {
                    errorMsg = 'âŒ No account exists with this email. Please check the email or sign up first.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'âŒ Invalid email address format.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMsg = 'âš ï¸ Too many attempts. Please try again in a few minutes.';
                } else if (error.code === 'auth/network-request-failed' || error.message.includes('network')) {
                    errorMsg = 'ðŸŒ Network error. Please check your internet connection.';
                } else {
                    errorMsg += error.message;
                }
                
                showToast(errorMsg, 'error');
            }
        }
        
        function demoLogin(role) {
            console.log('Demo login clicked for role:', role); // Debug log
            if (products.length === 0) loadDemoData();
            const user = users.find(u => u.role === role);
            if (user) {
                user.lastLogin = new Date().toISOString();
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                showToast(`Demo login as ${user.name}`, 'success');
                showApp();
            } else {
                console.error('Demo user not found for role:', role);
                showToast('Demo user not found', 'error');
            }
        }
        
        function logout() {
            if (currentUser) {
                const userName = currentUser.name;
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                localStorage.removeItem('lastLoggedUser'); // Clear persisted user
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                showToast(`${userName} logged out successfully`, 'success');
                console.log('User logged out successfully');
            }
        }
        
        function showApp(name, username, role, businessId) {
            // If parameters provided (from Firebase), set currentUser
            if (name && username && role) {
                currentUser = {
                    name: name,
                    username: username,
                    role: role,
                    businessId: businessId,
                    status: 'active'
                };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('lastLoggedUser', JSON.stringify(currentUser)); // Persist across refreshes
                
                // Set businessId in config for cloud sync
                if (businessId) {
                    config.businessId = businessId;
                    config.cloudSyncEnabled = true; // Enable cloud sync
                }
            }
            
            // Otherwise use currentUser from session/localStorage
            if (!currentUser) {
                currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                // Also set businessId from currentUser if available
                if (currentUser.businessId) {
                    config.businessId = currentUser.businessId;
                    config.cloudSyncEnabled = true;
                }
            }
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            setupRoleBasedAccess();
            document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrator' : 'Sales Staff';
            document.getElementById('userRole').className = 'user-role ' + currentUser.role;
            document.getElementById('userAvatar').textContent = currentUser.name.substring(0, 2).toUpperCase();
            document.getElementById('userAvatar').className = 'user-avatar ' + currentUser.role;
            
            if (currentUser.role === 'seller') {
                switchTab('pos');
                document.getElementById('bottomNav').style.display = 'none';
            } else {
                switchTab('dashboard');
            }
            renderAll();
        }
        
        // Load user data from Firestore
        async function loadUserData(businessId) {
            try {
                const dataDoc = await db.collection('data').doc(businessId).get();
                
                if (dataDoc.exists) {
                    const data = dataDoc.data();
                    
                    // Load all data into local arrays
                    products = data.products || [];
                    sales = data.sales || [];
                    creditSales = data.creditSales || [];
                    expenses = data.expenses || [];
                    categories = data.categories || [];
                    suppliers = data.suppliers || [];
                    config = { ...config, ...data.config };
                    
                    // Ensure businessId is set in config
                    config.businessId = businessId;
                    config.cloudSyncEnabled = true;
                    
                    // Save to localStorage for offline access
                    saveAllData();
                    
                    console.log('User data loaded from Firestore');
                } else {
                    console.log('No data found for business, starting fresh');
                    // Even if no data exists, set businessId for future syncs
                    config.businessId = businessId;
                    config.cloudSyncEnabled = true;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Could not load business data', 'error');
            }
        }
        
        function setupRoleBasedAccess() {
            document.querySelectorAll('.nav-item').forEach(item => {
                const role = item.dataset.role;
                if (role === 'admin' && currentUser.role !== 'admin') {
                    item.classList.add('disabled');
                } else {
                    item.classList.remove('disabled');
                }
            });
        }
        
        // ==================== DEMO DATA ====================
        function loadDemoData() {
            config = { businessName: 'Demo Supermarket - Nairobi', kraPin: 'P051234567X', phone: '0712345678', mpesaTill: '123456', vatRate: 16 };
            categories = ['Maize Flour', 'Sugar', 'Rice', 'Cooking Oil', 'Milk', 'Tea', 'Soft Drinks', 'Water', 'Bread', 'Soap', 'Detergent', 'Snacks'];
            products = [
                {id:'P001',name:'Jogoo Maize Flour 2kg',category:'Maize Flour',cost:165,price:185,stock:50,reorder:20,vat:16},
                {id:'P002',name:'Pembe Maize Flour 2kg',category:'Maize Flour',cost:158,price:175,stock:8,reorder:15,vat:16},
                {id:'P003',name:'Mumias Sugar 1kg',category:'Sugar',cost:145,price:165,stock:60,reorder:25,vat:16},
                {id:'P004',name:'Kabras Sugar 1kg',category:'Sugar',cost:142,price:162,stock:5,reorder:20,vat:16},
                {id:'P005',name:'Pishori Rice 1kg',category:'Rice',cost:180,price:220,stock:40,reorder:15,vat:16},
                {id:'P006',name:'Sindano Rice 1kg',category:'Rice',cost:120,price:150,stock:0,reorder:15,vat:16},
                {id:'P007',name:'Elianto Cooking Oil 1L',category:'Cooking Oil',cost:280,price:320,stock:35,reorder:15,vat:16},
                {id:'P008',name:'Kimbo 500g',category:'Cooking Oil',cost:180,price:210,stock:7,reorder:15,vat:16},
                {id:'P009',name:'Brookside Fresh Milk 500ml',category:'Milk',cost:55,price:70,stock:50,reorder:30,vat:0},
                {id:'P010',name:'Ketepa Tea 100g',category:'Tea',cost:110,price:140,stock:40,reorder:20,vat:16},
                {id:'P011',name:'Coca Cola 500ml',category:'Soft Drinks',cost:60,price:80,stock:48,reorder:24,vat:16},
                {id:'P012',name:'Fanta Orange 500ml',category:'Soft Drinks',cost:58,price:75,stock:36,reorder:20,vat:16},
                {id:'P013',name:'Keringet Water 500ml',category:'Water',cost:25,price:40,stock:60,reorder:30,vat:16},
                {id:'P014',name:'Supa Loaf Bread 400g',category:'Bread',cost:52,price:65,stock:20,reorder:10,vat:0},
                {id:'P015',name:'Jamaa Bar Soap',category:'Soap',cost:45,price:60,stock:100,reorder:30,vat:16},
                {id:'P016',name:'Omo Detergent 500g',category:'Detergent',cost:120,price:150,stock:3,reorder:10,vat:16}
            ];
            
            // Generate demo sales for last 30 days
            const today = new Date();
            sales = [];
            for (let d = 0; d < 30; d++) {
                const dt = new Date(today); dt.setDate(dt.getDate() - d);
                const ds = dt.toISOString().split('T')[0];
                const numSales = 8 + Math.floor(Math.random() * 20);
                for (let i = 0; i < numSales; i++) {
                    const p = products[Math.floor(Math.random() * products.length)];
                    const q = 1 + Math.floor(Math.random() * 4);
                    const pm = ['Cash', 'M-Pesa', 'Credit'][Math.floor(Math.random() * 3)];
                    const subtotal = p.price * q;
                    const vatAmt = p.vat === 16 ? Math.round(subtotal * 16 / 116) : 0;
                    const hour = 8 + Math.floor(Math.random() * 12);
                    const minute = Math.floor(Math.random() * 60);
                    sales.push({
                        id: 'S' + Date.now() + Math.random().toString(36).substr(2, 4),
                        date: ds,
                        time: `${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}`,
                        items: [{ productId: p.id, name: p.name, qty: q, price: p.price, cost: p.cost, vat: p.vat }],
                        subtotal: subtotal,
                        vat: vatAmt,
                        total: subtotal,
                        profit: (p.price - p.cost) * q,
                        paymentMethod: pm,
                        cashier: 'Admin User'
                    });
                }
            }
            
            creditSales = [
                { id: 'CR1', customer: 'Mama Njeri', phone: '0712345678', amount: 2500, paid: 1000, date: today.toISOString().split('T')[0], dueDate: '2026-02-15' },
                { id: 'CR2', customer: 'John Kamau', phone: '0722111222', amount: 4200, paid: 2000, date: today.toISOString().split('T')[0], dueDate: '2026-02-20' },
                { id: 'CR3', customer: 'Wanjiku Stores', phone: '0733444555', amount: 8500, paid: 3000, date: '2025-12-15', dueDate: '2026-01-15' }
            ];
            
            expenses = [
                { id: 'E1', date: today.toISOString().split('T')[0], category: 'Rent', description: 'Monthly shop rent', amount: 25000, ref: 'RNT-001', recordedBy: 'Admin' },
                { id: 'E2', date: today.toISOString().split('T')[0], category: 'Utilities', description: 'Electricity bill', amount: 3500, ref: 'KPLC-123', recordedBy: 'Admin' },
                { id: 'E3', date: new Date(today.setDate(today.getDate() - 5)).toISOString().split('T')[0], category: 'Transport', description: 'Stock delivery', amount: 2000, ref: '', recordedBy: 'Admin' }
            ];
            
            suppliers = [
                { id: 'SUP1', name: 'Unga Group Ltd', contact: 'James Mwangi', phone: '0720123456', email: 'sales@unga.co.ke', products: 'Maize Flour, Wheat Flour' },
                { id: 'SUP2', name: 'Mumias Sugar', contact: 'Mary Akinyi', phone: '0733987654', email: 'orders@mumias.co.ke', products: 'Sugar' }
            ];
            
            saveAllData();
        }
        // ==================== UTILITIES ====================
        function formatKsh(n) { return 'Ksh ' + (n || 0).toLocaleString('en-KE', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
        function getEmoji(cat) {
            const emojis = { 'Maize Flour': 'ðŸŒ½', 'Sugar': 'ðŸ¬', 'Rice': 'ðŸš', 'Cooking Oil': 'ðŸ«’', 'Milk': 'ðŸ¥›', 'Tea': 'ðŸµ', 'Soft Drinks': 'ðŸ¥¤', 'Water': 'ðŸ’§', 'Bread': 'ðŸž', 'Soap': 'ðŸ§¼', 'Detergent': 'ðŸ«§', 'Snacks': 'ðŸ¿' };
            return emojis[cat] || 'ðŸ“¦';
        }
        function getTodayDate() { return new Date().toISOString().split('T')[0]; }
        function getFilteredSales() {
            const today = new Date(); const todayStr = getTodayDate();
            return sales.filter(s => {
                if (dateFilter === 'today') return s.date === todayStr;
                if (dateFilter === 'week') { const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7); return new Date(s.date) >= weekAgo; }
                if (dateFilter === 'month') { const monthAgo = new Date(today); monthAgo.setMonth(monthAgo.getMonth() - 1); return new Date(s.date) >= monthAgo; }
                if (dateFilter === 'year') { return new Date(s.date).getFullYear() === today.getFullYear(); }
                return true;
            });
        }
        
        function showToast(message, type = 'success', title = '') {
            const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><div class="toast-content"><div class="toast-title">${title || message}</div>${title ? `<div class="toast-message">${message}</div>` : ''}</div><button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        
        // ==================== NAVIGATION ====================
        function switchTab(tab) {
            if (currentUser.role === 'seller' && !['pos'].includes(tab)) {
                showToast('Access restricted to POS only', 'warning');
                return;
            }
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(tab + 'Tab').classList.add('active');
            document.querySelectorAll(`[data-tab="${tab}"]`).forEach(n => n.classList.add('active'));
            
            const titles = { dashboard: ['Dashboard', 'Overview of your business'], pos: ['Point of Sale', 'Process customer transactions'], sales: ['Sales History', 'View all transactions'], credit: ['Credit Sales', 'Manage customer credit'], inventory: ['Inventory', 'Manage your products'], categories: ['Categories', 'Product categories'], suppliers: ['Suppliers', 'Manage suppliers'], expenses: ['Expenses', 'Track business expenses'], accounts: ['Chart of Accounts', 'Accounting structure'], journal: ['Journal Entries', 'Financial transactions'], reports: ['Analytics', 'Business insights'], kra: ['KRA Compliance', 'Tax reporting'], profit: ['Profit & Loss', 'Financial performance'], users: ['Users', 'Manage user accounts'], settings: ['Settings', 'System configuration'] };
            const [title, subtitle] = titles[tab] || ['Dashboard', ''];
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('pageSubtitle').textContent = subtitle;
            closeSidebar();
            
            // Refresh tab specific data
            if (tab === 'dashboard') renderDashboard();
            else if (tab === 'pos') renderPOS();
            else if (tab === 'sales') renderSalesHistory();
            else if (tab === 'credit') renderCreditSales();
            else if (tab === 'inventory') renderInventory();
            else if (tab === 'categories') renderCategories();
            else if (tab === 'suppliers') renderSuppliers();
            else if (tab === 'expenses') renderExpenses();
            else if (tab === 'accounts') renderAccounts();
            else if (tab === 'journal') renderJournal();
            else if (tab === 'reports') renderReports();
            else if (tab === 'kra') renderKRA();
            else if (tab === 'profit') renderProfitLoss();
            else if (tab === 'users') renderUsers();
            else if (tab === 'settings') renderSettings();
        }
        
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobileOverlay').classList.toggle('show'); }
        function closeSidebar() { 
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('open');
            sidebar.classList.remove('show'); // Also remove mobile 'show' class
            document.getElementById('mobileOverlay').classList.remove('show'); 
        }
        function toggleCartMobile() { 
            const cart = document.getElementById('posCart');
            cart.classList.toggle('expanded'); 
        }
        
        // ==================== SUBSCRIPTION MANAGEMENT ====================
        function selectLoginType(type) {
            // Update selected login type
            document.getElementById('selectedLoginType').value = type;
            
            // Update button styles to show selection
            const adminBtn = document.getElementById('adminLoginBtn');
            const sellerBtn = document.getElementById('sellerLoginBtn');
            
            if (type === 'admin') {
                adminBtn.style.borderColor = 'var(--accent-purple)';
                adminBtn.style.background = 'rgba(139,92,246,0.1)';
                sellerBtn.style.borderColor = 'var(--border)';
                sellerBtn.style.background = 'var(--bg-dark)';
            } else {
                sellerBtn.style.borderColor = 'var(--accent-green)';
                sellerBtn.style.background = 'rgba(16,185,129,0.1)';
                adminBtn.style.borderColor = 'var(--border)';
                adminBtn.style.background = 'var(--bg-dark)';
            }
            
            showToast(`${type === 'admin' ? 'ðŸ‘‘ Admin' : 'ðŸ›’ Seller'} login selected`, 'info');
        }
        
        function updateDemoVisibility() {
            // Hide/show login type buttons based on real user status
            const loginTypeSection = document.getElementById('loginTypeSection');
            const loginTypeButtons = document.getElementById('loginTypeButtons');
            
            if (config.isRealUser) {
                // For real users, still show the buttons (they're for role selection, not demo)
                if (loginTypeSection) loginTypeSection.style.display = 'flex';
                if (loginTypeButtons) loginTypeButtons.style.display = 'grid';
            } else {
                // For demo/testing, still show the buttons
                if (loginTypeSection) loginTypeSection.style.display = 'flex';
                if (loginTypeButtons) loginTypeButtons.style.display = 'grid';
            }
        }
        
        function checkSubscriptionStatus() {
            // Only check for real users
            if (!config.isRealUser) return;
            
            const now = new Date();
            const nextDue = config.subscriptionNextDue ? new Date(config.subscriptionNextDue) : null;
            
            // Check if subscription is past due
            if (nextDue && now > nextDue && config.subscriptionStatus !== 'active') {
                config.subscriptionStatus = 'expired';
                saveAllData();
                showSubscriptionModal();
            }
        }
        
        function showSubscriptionModal() {
            // Set your till number for collecting subscription fees
            const adminTill = '7028833'; // Replace with your actual till number
            document.getElementById('subsTillNumber').textContent = adminTill;
            document.getElementById('subscriptionAmount').textContent = `KSh ${config.subscriptionFee.toLocaleString()}`;
            document.getElementById('subscriptionModal').classList.add('show');
        }
        
        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').classList.remove('show');
            // Show toast about limited access
            showToast('âš ï¸ System in limited mode. Please pay to continue.', 'warning');
        }
        
        async function verifySubscriptionPayment() {
            const phoneNumber = document.getElementById('subsPhoneNumber').value.trim();
            
            if (!phoneNumber || phoneNumber.length !== 10) {
                showToast('Please enter a valid phone number (10 digits)', 'error');
                return;
            }
            
            showToast('Verifying payment...', 'info');
            
            // Simulate payment verification (in production, check with M-Pesa API or IntaSend)
            // For now, we'll do a simple confirmation
            
            try {
                // In production, you would:
                // 1. Call IntaSend API to check for payment from this phone number
                // 2. Verify amount matches subscription fee
                // 3. Confirm transaction timestamp is recent
                
                // For now, simulate success after 2 seconds
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Update subscription status
                config.subscriptionStatus = 'active';
                config.subscriptionLastPayment = new Date().toISOString();
                config.subscriptionNextDue = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();
                saveAllData();
                
                // Close modal
                document.getElementById('subscriptionModal').classList.remove('show');
                
                // Show success message
                showToast('âœ… Payment verified! Subscription activated for 30 days.', 'success');
                
                // Sync to cloud if Firebase configured
                if (config.businessId && db) {
                    await db.collection('data').doc(config.businessId).update({
                        'config.subscriptionStatus': 'active',
                        'config.subscriptionLastPayment': config.subscriptionLastPayment,
                        'config.subscriptionNextDue': config.subscriptionNextDue
                    });
                }
                
            } catch (error) {
                console.error('Payment verification error:', error);
                showToast('âŒ Could not verify payment. Please contact support.', 'error');
            }
        }
        
        // Prevent cart from closing when clicking inside cart content on mobile
        document.addEventListener('DOMContentLoaded', () => {
            const cartItems = document.getElementById('cartItems');
            const cartFooter = document.querySelector('.cart-footer');
            
            if (cartItems) {
                cartItems.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            if (cartFooter) {
                cartFooter.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        });
        
        function renderAll() {
            renderDashboard();
            renderPOS();
            updateBadges();
        }
        
        function updateBadges() {
            const pendingCredit = creditSales.filter(c => c.amount - c.paid > 0).length;
            document.getElementById('creditBadge').textContent = pendingCredit;
            document.getElementById('creditBadge').style.display = pendingCredit > 0 ? 'inline' : 'none';
            
            const lowStock = products.filter(p => p.stock <= p.reorder).length;
            document.getElementById('lowStockBadge').textContent = lowStock;
            document.getElementById('lowStockBadge').style.display = lowStock > 0 ? 'inline' : 'none';
        }
        
        function setDateFilter(filter) {
            dateFilter = filter;
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderDashboard();
        }
        
        // ==================== DASHBOARD ====================
        function renderDashboard() {
            const filtered = getFilteredSales();
            const totalRevenue = filtered.reduce((s, x) => s + x.total, 0);
            const totalProfit = filtered.reduce((s, x) => s + (x.profit || 0), 0);
            const totalVat = filtered.reduce((s, x) => s + (x.vat || 0), 0);
            const filteredExpenses = expenses.filter(e => {
                if (dateFilter === 'today') return e.date === getTodayDate();
                if (dateFilter === 'week') { const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7); return new Date(e.date) >= weekAgo; }
                if (dateFilter === 'month') { const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1); return new Date(e.date) >= monthAgo; }
                return true;
            });
            const totalExpenses = filteredExpenses.reduce((s, x) => s + x.amount, 0);
            const netProfit = totalProfit - totalExpenses;
            const creditOutstanding = creditSales.reduce((s, c) => s + (c.amount - c.paid), 0);
            
            document.getElementById('dashRevenue').textContent = formatKsh(totalRevenue);
            document.getElementById('dashProfit').textContent = formatKsh(netProfit);
            document.getElementById('dashSalesCount').textContent = filtered.length;
            document.getElementById('dashCredit').textContent = formatKsh(creditOutstanding);
            document.getElementById('dashCreditCount').textContent = creditSales.filter(c => c.amount - c.paid > 0).length + ' pending';
            
            // KRA Stats
            document.getElementById('kraVatCollected').textContent = formatKsh(totalVat);
            document.getElementById('kraTaxableSales').textContent = formatKsh(totalRevenue - totalVat);
            document.getElementById('kraExemptSales').textContent = formatKsh(filtered.filter(s => s.items.some(i => i.vat === 0)).reduce((s, x) => s + x.total, 0));
            document.getElementById('kraInvoices').textContent = filtered.length;
            
            // Breakdown
            const cashSales = filtered.filter(s => s.paymentMethod === 'Cash');
            const mpesaSales = filtered.filter(s => s.paymentMethod === 'M-Pesa');
            const creditSalesList = filtered.filter(s => s.paymentMethod === 'Credit');
            
            document.getElementById('dashBreakdown').innerHTML = `
                <div class="breakdown-item"><div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(16,185,129,.15);color:var(--accent-green)">ðŸ’µ</div><div><div class="breakdown-label">Cash Sales</div><div class="breakdown-sublabel">${cashSales.length} transactions</div></div></div><div class="breakdown-value">${formatKsh(cashSales.reduce((s,x)=>s+x.total,0))}</div></div>
                <div class="breakdown-item"><div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(59,130,246,.15);color:var(--accent-blue)">ðŸ“±</div><div><div class="breakdown-label">M-Pesa Sales</div><div class="breakdown-sublabel">${mpesaSales.length} transactions</div></div></div><div class="breakdown-value">${formatKsh(mpesaSales.reduce((s,x)=>s+x.total,0))}</div></div>
                <div class="breakdown-item"><div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(249,115,22,.15);color:var(--accent-orange)">ðŸ’³</div><div><div class="breakdown-label">Credit Sales</div><div class="breakdown-sublabel">${creditSalesList.length} transactions</div></div></div><div class="breakdown-value">${formatKsh(creditSalesList.reduce((s,x)=>s+x.total,0))}</div></div>
                <div class="breakdown-item"><div class="breakdown-left"><div class="breakdown-icon" style="background:rgba(239,68,68,.15);color:var(--accent-red)">ðŸ’¸</div><div><div class="breakdown-label">Expenses</div><div class="breakdown-sublabel">${filteredExpenses.length} recorded</div></div></div><div class="breakdown-value" style="color:var(--accent-red)">${formatKsh(totalExpenses)}</div></div>
            `;
            
            renderDashboardCharts(filtered);
        }
        
        function renderDashboardCharts(filtered) {
            // Payment method chart
            const cashTotal = filtered.filter(s => s.paymentMethod === 'Cash').reduce((s,x)=>s+x.total,0);
            const mpesaTotal = filtered.filter(s => s.paymentMethod === 'M-Pesa').reduce((s,x)=>s+x.total,0);
            const creditTotal = filtered.filter(s => s.paymentMethod === 'Credit').reduce((s,x)=>s+x.total,0);
            
            if (charts.payment) charts.payment.destroy();
            charts.payment = new Chart(document.getElementById('paymentChart'), {
                type: 'doughnut',
                data: { labels: ['Cash', 'M-Pesa', 'Credit'], datasets: [{ data: [cashTotal, mpesaTotal, creditTotal], backgroundColor: ['#10b981', '#3b82f6', '#f97316'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
            });
            
            // Revenue trend chart
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                const dayTotal = sales.filter(s => s.date === ds).reduce((s,x) => s + x.total, 0);
                last7Days.push({ date: d.toLocaleDateString('en-KE', { weekday: 'short' }), total: dayTotal });
            }
            
            if (charts.revenue) charts.revenue.destroy();
            charts.revenue = new Chart(document.getElementById('revenueChart'), {
                type: 'line',
                data: { labels: last7Days.map(d => d.date), datasets: [{ label: 'Revenue', data: last7Days.map(d => d.total), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }, x: { ticks: { color: '#64748b' }, grid: { display: false } } } }
            });
            
            // Top products chart
            const productSales = {};
            filtered.forEach(s => s.items.forEach(i => { productSales[i.name] = (productSales[i.name] || 0) + i.qty; }));
            const topProducts = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            if (charts.products) charts.products.destroy();
            charts.products = new Chart(document.getElementById('productsChart'), {
                type: 'bar',
                data: { labels: topProducts.map(p => p[0].substring(0, 15)), datasets: [{ label: 'Units Sold', data: topProducts.map(p => p[1]), backgroundColor: ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'] }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }, y: { ticks: { color: '#94a3b8' }, grid: { display: false } } } }
            });
        }
        // ==================== POS ====================
        function renderPOS() {
            const cats = ['All', ...new Set(products.map(p => p.category))];
            document.getElementById('posCategories').innerHTML = cats.map(c => `<button class="category-chip ${c === selectedCategory ? 'active' : ''}" onclick="filterPOSCategory('${c}')">${c === 'All' ? 'ðŸ·ï¸ All' : getEmoji(c) + ' ' + c}</button>`).join('');
            filterPOSProducts('');
            renderCart();
            // Update M-Pesa display with configured till number
            updateMpesaDisplay();
        }
        
        function filterPOSCategory(cat) { selectedCategory = cat; document.querySelectorAll('.category-chip').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); filterPOSProducts(document.getElementById('posSearch').value); }
        
        function filterPOSProducts(search) {
            const filtered = products.filter(p => {
                const matchCat = selectedCategory === 'All' || p.category === selectedCategory;
                const matchSearch = !search || p.name.toLowerCase().includes(search.toLowerCase());
                return matchCat && matchSearch;
            });
            document.getElementById('posProductGrid').innerHTML = filtered.map(p => {
                const stockClass = p.stock === 0 ? 'out-of-stock' : p.stock <= p.reorder ? 'low-stock' : '';
                const stockLabel = p.stock === 0 ? 'Out of Stock' : p.stock <= p.reorder ? `Low: ${p.stock}` : `${p.stock} in stock`;
                const stockLabelClass = p.stock === 0 ? 'out' : p.stock <= p.reorder ? 'low' : '';
                return `<div class="product-card ${stockClass}" onclick="openQuickAdd('${p.id}')"><div class="product-emoji">${getEmoji(p.category)}</div><div class="product-name">${p.name}</div><div class="sku-code">SKU: ${p.sku || '-'}</div><div class="product-price">${formatKsh(p.price)}</div><div class="product-stock ${stockLabelClass}">${stockLabel}</div></div>`;
            }).join('');
        }
        
        function openQuickAdd(productId) {
            quickAddProduct = products.find(p => p.id === productId);
            if (!quickAddProduct || quickAddProduct.stock === 0) return;
            quickAddQty = 1;
            document.getElementById('quickAddEmoji').textContent = getEmoji(quickAddProduct.category);
            document.getElementById('quickAddName').textContent = quickAddProduct.name;
            document.getElementById('quickAddPrice').textContent = formatKsh(quickAddProduct.price) + ' each';
            document.getElementById('quickQtyDisplay').textContent = quickAddQty;
            document.getElementById('quickTotal').textContent = formatKsh(quickAddProduct.price * quickAddQty);
            openModal('quickAddModal');
        }
        
        function changeQuickQty(delta) {
            if (!quickAddProduct) return;
            quickAddQty = Math.max(1, Math.min(quickAddProduct.stock, quickAddQty + delta));
            document.getElementById('quickQtyDisplay').textContent = quickAddQty;
            document.getElementById('quickTotal').textContent = formatKsh(quickAddProduct.price * quickAddQty);
        }
        
        function confirmQuickAdd() {
            if (!quickAddProduct) return;
            const existing = cart.find(i => i.productId === quickAddProduct.id);
            if (existing) { existing.qty = Math.min(quickAddProduct.stock, existing.qty + quickAddQty); }
            else { cart.push({ productId: quickAddProduct.id, name: quickAddProduct.name, price: quickAddProduct.price, cost: quickAddProduct.cost, qty: quickAddQty, vat: quickAddProduct.vat || 16 }); }
            closeModal('quickAddModal');
            renderCart();
            showToast(`${quickAddProduct.name} added`, 'success');
        }
        
        function renderCart() {
            const cartEl = document.getElementById('cartItems');
            if (cart.length === 0) {
                cartEl.innerHTML = '<div class="cart-empty"><div class="cart-empty-icon">ðŸ›’</div><div class="cart-empty-text">Cart is empty</div><div class="cart-empty-hint">Tap on products to add them</div></div>';
            } else {
                cartEl.innerHTML = cart.map((item, i) => `<div class="cart-item"><div class="cart-item-info"><div class="cart-item-name">${item.name}</div><div class="cart-item-price">${formatKsh(item.price)} Ã— ${item.qty}</div></div><div class="cart-item-controls"><button class="qty-btn minus" onclick="updateCartQty(${i},-1)">âˆ’</button><span class="cart-item-qty">${item.qty}</span><button class="qty-btn plus" onclick="updateCartQty(${i},1)">+</button></div><div class="cart-item-total">${formatKsh(item.price * item.qty)}</div><button class="cart-item-remove" onclick="removeCartItem(${i})">Ã—</button></div>`).join('');
            }
            const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
            const vatAmount = cart.reduce((s, i) => s + (i.vat === 16 ? Math.round(i.price * i.qty * 16 / 116) : 0), 0);
            document.getElementById('cartSubtotal').textContent = formatKsh(subtotal - vatAmount);
            document.getElementById('cartVat').textContent = formatKsh(vatAmount);
            document.getElementById('cartTotal').textContent = formatKsh(subtotal);
            document.getElementById('cartCount').textContent = cart.reduce((s, i) => s + i.qty, 0);
            document.getElementById('completeSaleBtn').disabled = cart.length === 0 || (selectedPayment === 'M-Pesa' && !mpesaConfirmed);
            // ADDED: Update M-Pesa amount
            updateMpesaAmount();
        }
        
        function updateCartQty(index, delta) {
            const item = cart[index];
            const product = products.find(p => p.id === item.productId);
            item.qty = Math.max(1, Math.min(product ? product.stock : 999, item.qty + delta));
            renderCart();
        }
        
        function removeCartItem(index) { cart.splice(index, 1); renderCart(); }
        function clearCart() { cart = []; mpesaConfirmed = false; mpesaData = null; renderCart(); }
        
        // Payment
        function selectPayment(method, btn) {
            selectedPayment = method;
            document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active', 'mpesa-pending', 'mpesa-confirmed'));
            btn.classList.add('active');
            document.getElementById('mpesaPanel').classList.toggle('show', method === 'M-Pesa');
            
            // ADDED: Show IntaSend or Manual mode based on configuration
            if (method === 'M-Pesa') {
                const intasendEnabled = config.intasendEnabled && config.intasendPublicKey && config.intasendSecretKey;
                document.getElementById('mpesaIntasendMode').style.display = intasendEnabled ? 'block' : 'none';
                document.getElementById('mpesaManualMode').style.display = intasendEnabled ? 'none' : 'block';
            }
            
            if (method !== 'M-Pesa') { mpesaConfirmed = false; mpesaData = null; }
            renderCart();
        }
        
        // UPDATED: Manual M-Pesa confirmation functions
        function updateMpesaConfirm(val) {
            const phone = val.trim().replace(/\D/g,'');
            const msg = document.getElementById('mpesaConfirmMsg');
            const btn = document.getElementById('confirmMpesaBtn');
            
            // Check if Till/Paybill is configured
            if (!config.mpesaTill || config.mpesaTill === '') {
                msg.innerHTML = 'âš ï¸ <span style="color:#f59e0b;">Configure Till/Paybill in Settings first!</span>';
                btn.disabled = true;
                return;
            }
            
            if (phone.length === 10 && phone.startsWith('07')) {
                msg.innerHTML = `âœ“ Ready to confirm payment from <strong>${phone}</strong>`;
                btn.disabled = false;
            } else if (phone.length > 0) {
                msg.innerHTML = '<span style="color:#f59e0b;">Enter valid phone (07XXXXXXXX)</span>';
                btn.disabled = true;
            } else {
                msg.innerHTML = '';
                btn.disabled = true;
            }
        }

        function confirmManualMpesa() {
            const phone = document.getElementById('mpesaPhoneConfirm').value.trim().replace(/\D/g,'');
            if (!phone.match(/^07\d{8}$/)) return showToast("Invalid phone number", "error");
            
            // Check if Till/Paybill is configured
            if (!config.mpesaTill || config.mpesaTill === '') {
                showToast("Please configure M-Pesa Till/Paybill in Settings first!", "error");
                return;
            }

            mpesaConfirmed = true;
            mpesaData = { phone, method: 'M-Pesa', till: config.mpesaTill };
            
            // Show success message
            showToast(`âœ“ M-Pesa payment confirmed from ${phone}`, "success");
            
            // Complete the sale
            completeSale();
        }

        function updateMpesaAmount() {
            const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
            const amountEl = document.getElementById('mpesaAmount');
            const amountIntasendEl = document.getElementById('mpesaAmountIntasend');
            const tillEl = document.getElementById('mpesaTillDisplay');
            
            if (amountEl) amountEl.textContent = formatKsh(total);
            if (amountIntasendEl) amountIntasendEl.textContent = formatKsh(total);
            
            if (tillEl) {
                const tillNumber = config.mpesaTill || 'NOT SET';
                tillEl.textContent = tillNumber;
                if (!config.mpesaTill || config.mpesaTill === '') {
                    tillEl.style.color = '#f59e0b';
                    tillEl.textContent = 'NOT CONFIGURED';
                } else {
                    tillEl.style.color = '#10b981';
                }
            }
        }
        
        // ADDED: IntaSend STK Push Integration
        let intasendPollingInterval = null;
        
        async function sendIntasendSTKPush() {
            const phone = document.getElementById('mpesaPhoneIntasend').value.trim().replace(/\D/g,'');
            if (!phone.match(/^07\d{8}$/)) {
                showToast("Invalid phone number. Use format: 07XXXXXXXX", "error");
                return;
            }
            
            if (!config.intasendPublicKey || !config.intasendSecretKey) {
                showToast("IntaSend API not configured. Check Settings.", "error");
                return;
            }
            
            const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
            const invoiceId = 'INV' + Date.now().toString().slice(-8);
            
            // Show loading status
            const statusDiv = document.getElementById('intasendStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(59,130,246,0.1)';
            statusDiv.style.border = '1px solid rgba(59,130,246,0.3)';
            statusDiv.innerHTML = `
                <div style="font-size:1.1rem; font-weight:600; color:#3b82f6; margin-bottom:8px;">ðŸ“² Sending payment request...</div>
                <div style="font-size:0.85rem; color:var(--text-secondary);">Customer will receive prompt on ${phone}</div>
            `;
            
            try {
                const baseUrl = config.intasendEnvironment === 'live' 
                    ? 'https://api.intasend.com' 
                    : 'https://sandbox.intasend.com';
                
                const response = await fetch(`${baseUrl}/api/v1/payment/mpesa-stk-push/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.intasendSecretKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone_number: '254' + phone.substring(1), // Convert 07XX to 2547XX
                        amount: total,
                        api_ref: invoiceId
                    })
                });
                
                const data = await response.json();
                
                if (data.id || data.tracking_id) {
                    // STK Push sent successfully
                    statusDiv.style.background = 'rgba(251,191,36,0.1)';
                    statusDiv.style.border = '1px solid rgba(251,191,36,0.3)';
                    statusDiv.innerHTML = `
                        <div style="font-size:1.1rem; font-weight:600; color:#f59e0b; margin-bottom:8px;">â³ Waiting for customer...</div>
                        <div style="font-size:0.85rem; color:var(--text-secondary);">Customer should enter PIN on their phone</div>
                        <div style="margin-top:8px;">
                            <div style="width:40px; height:40px; border:4px solid var(--border); border-top-color:#f59e0b; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
                        </div>
                    `;
                    
                    // Start polling for payment status
                    const trackingId = data.id || data.tracking_id;
                    startIntasendPolling(trackingId, phone, total, invoiceId);
                } else {
                    throw new Error(data.message || 'STK Push failed');
                }
            } catch (error) {
                statusDiv.style.background = 'rgba(239,68,68,0.1)';
                statusDiv.style.border = '1px solid rgba(239,68,68,0.3)';
                statusDiv.innerHTML = `
                    <div style="font-size:1.1rem; font-weight:600; color:#ef4444;">âŒ Request Failed</div>
                    <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">${error.message}</div>
                `;
                showToast('Payment request failed: ' + error.message, 'error');
            }
        }
        
        function startIntasendPolling(trackingId, phone, amount, invoiceId) {
            let attempts = 0;
            const maxAttempts = 40; // 40 attempts x 3 seconds = 2 minutes
            
            intasendPollingInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(intasendPollingInterval);
                    const statusDiv = document.getElementById('intasendStatus');
                    statusDiv.style.background = 'rgba(239,68,68,0.1)';
                    statusDiv.style.border = '1px solid rgba(239,68,68,0.3)';
                    statusDiv.innerHTML = `
                        <div style="font-size:1.1rem; font-weight:600; color:#ef4444;">â±ï¸ Payment Timeout</div>
                        <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">Customer did not complete payment. Try manual mode.</div>
                    `;
                    return;
                }
                
                try {
                    const baseUrl = config.intasendEnvironment === 'live' 
                        ? 'https://api.intasend.com' 
                        : 'https://sandbox.intasend.com';
                    
                    const response = await fetch(`${baseUrl}/api/v1/payment/status/${trackingId}/`, {
                        headers: {
                            'Authorization': `Bearer ${config.intasendSecretKey}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.state === 'COMPLETE' || data.status === 'COMPLETED') {
                        // Payment successful!
                        clearInterval(intasendPollingInterval);
                        
                        const statusDiv = document.getElementById('intasendStatus');
                        statusDiv.style.background = 'rgba(16,185,129,0.1)';
                        statusDiv.style.border = '1px solid rgba(16,185,129,0.3)';
                        statusDiv.innerHTML = `
                            <div style="font-size:1.5rem; margin-bottom:8px;">âœ…</div>
                            <div style="font-size:1.1rem; font-weight:600; color:#10b981;">Payment Confirmed!</div>
                            <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">Transaction: ${data.mpesa_reference || trackingId}</div>
                        `;
                        
                        mpesaConfirmed = true;
                        mpesaData = { 
                            phone: phone, 
                            method: 'M-Pesa (IntaSend)',
                            transactionId: data.mpesa_reference || trackingId,
                            amount: amount
                        };
                        
                        showToast('âœ“ Payment received! Completing sale...', 'success');
                        
                        // Auto-complete sale after 1 second
                        setTimeout(() => {
                            completeSale();
                        }, 1000);
                        
                    } else if (data.state === 'FAILED' || data.status === 'FAILED') {
                        clearInterval(intasendPollingInterval);
                        const statusDiv = document.getElementById('intasendStatus');
                        statusDiv.style.background = 'rgba(239,68,68,0.1)';
                        statusDiv.style.border = '1px solid rgba(239,68,68,0.3)';
                        statusDiv.innerHTML = `
                            <div style="font-size:1.1rem; font-weight:600; color:#ef4444;">âŒ Payment Failed</div>
                            <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">Customer cancelled or insufficient funds. Try again.</div>
                        `;
                    }
                    // If PENDING, continue polling
                } catch (error) {
                    console.error('IntaSend polling error:', error);
                }
            }, 3000); // Poll every 3 seconds
        }
        
        function completeSale() {
            if (cart.length === 0) return;
            if (selectedPayment === 'Credit') { openModal('creditSaleModal'); return; }
            processSale();
        }
        
        function confirmCreditSale() {
            const customer = document.getElementById('creditCustomerName').value.trim();
            const phone = document.getElementById('creditCustomerPhone').value.trim();
            const dueDate = document.getElementById('creditDueDate').value || new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
            if (!customer || !phone) { showToast('Enter customer name and phone', 'error'); return; }
            const total = cart.reduce((s, i) => s + i.price * i.qty, 0);
            creditSales.push({ id: 'CR' + Date.now(), customer, phone, amount: total, paid: 0, date: getTodayDate(), dueDate });
            localStorage.setItem(STORAGE_KEYS.credit, JSON.stringify(creditSales));
            closeModal('creditSaleModal');
            processSale();
            document.getElementById('creditCustomerName').value = '';
            document.getElementById('creditCustomerPhone').value = '';
        }
        
        function processSale() {
            const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
            const vatAmount = cart.reduce((s, i) => s + (i.vat === 16 ? Math.round(i.price * i.qty * 16 / 116) : 0), 0);
            const profit = cart.reduce((s, i) => s + (i.price - i.cost) * i.qty, 0);
            const sale = {
                id: 'INV' + Date.now().toString().slice(-8),
                date: getTodayDate(),
                time: new Date().toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' }),
                items: [...cart],
                subtotal: subtotal - vatAmount,
                vat: vatAmount,
                total: subtotal,
                profit,
                paymentMethod: selectedPayment,
                mpesaData: selectedPayment === 'M-Pesa' ? mpesaData : null,
                cashier: currentUser.name
            };
            
            sales.unshift(sale);
            localStorage.setItem(STORAGE_KEYS.sales, JSON.stringify(sales));
            
            // Update stock
            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) product.stock = Math.max(0, product.stock - item.qty);
            });
            localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products));
            
            // Create journal entry
            journalEntries.push({
                id: 'JE' + Date.now(),
                date: getTodayDate(),
                ref: sale.id,
                description: `Sales - ${selectedPayment}`,
                debit: selectedPayment === 'Credit' ? 'Accounts Receivable' : (selectedPayment === 'M-Pesa' ? 'M-Pesa' : 'Cash'),
                credit: 'Sales Revenue',
                amount: subtotal
            });
            localStorage.setItem(STORAGE_KEYS.journal, JSON.stringify(journalEntries));
            
            showReceipt(sale);
            
            // Reset cart
            cart = [];
            mpesaConfirmed = false;
            mpesaData = null;
            
            // Stop IntaSend polling if active
            if (intasendPollingInterval) {
                clearInterval(intasendPollingInterval);
                intasendPollingInterval = null;
            }
            
            // UPDATED: Reset M-Pesa panels (both Manual and IntaSend)
            const mpesaPhoneConfirm = document.getElementById('mpesaPhoneConfirm');
            const mpesaPhoneIntasend = document.getElementById('mpesaPhoneIntasend');
            const mpesaConfirmMsg = document.getElementById('mpesaConfirmMsg');
            const confirmMpesaBtn = document.getElementById('confirmMpesaBtn');
            const intasendStatus = document.getElementById('intasendStatus');
            
            if (mpesaPhoneConfirm) mpesaPhoneConfirm.value = '';
            if (mpesaPhoneIntasend) mpesaPhoneIntasend.value = '';
            if (mpesaConfirmMsg) mpesaConfirmMsg.innerHTML = '';
            if (confirmMpesaBtn) confirmMpesaBtn.disabled = true;
            if (intasendStatus) intasendStatus.style.display = 'none';
            
            document.getElementById('mpesaPanel').classList.remove('show');
            document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active', 'mpesa-pending', 'mpesa-confirmed'));
            document.querySelector('[data-method="Cash"]').classList.add('active');
            selectedPayment = 'Cash';
            document.getElementById('mpesaPanel').classList.remove('show');
            
            renderAll();
            showToast('Sale completed!', 'success', 'Transaction Successful');
        }
        
        function showReceipt(sale) {
            document.getElementById('receiptContent').innerHTML = `
                <div class="receipt-header">
                    <div class="receipt-logo">ðŸª ${config.businessName}</div>
                    <div class="receipt-shop">${config.phone ? 'Tel: ' + config.phone : ''}</div>
                    <div class="receipt-info">Receipt: ${sale.id}<br>${sale.date} ${sale.time}<br>Cashier: ${sale.cashier}</div>
                </div>
                <div class="receipt-items">${sale.items.map(i => `<div class="receipt-item"><span>${i.name} Ã—${i.qty}</span><span>${formatKsh(i.price * i.qty)}</span></div>`).join('')}</div>
                <div class="receipt-totals">
                    <div class="receipt-row"><span>Subtotal (Excl. VAT)</span><span>${formatKsh(sale.subtotal)}</span></div>
                    <div class="receipt-row"><span>VAT (16%)</span><span>${formatKsh(sale.vat)}</span></div>
                    <div class="receipt-row grand"><span>TOTAL</span><span>${formatKsh(sale.total)}</span></div>
                </div>
                <div class="receipt-payment ${sale.paymentMethod === 'M-Pesa' ? 'mpesa' : ''}">
                    <strong>Payment:</strong> ${sale.paymentMethod}
                    ${sale.mpesaData ? '<br>M-Pesa Ref: ' + sale.mpesaData.code : ''}
                </div>
                <div class="receipt-footer">
                    Thank you for shopping with us!
                    ${config.mpesaTill ? '<br>M-Pesa Till: ' + config.mpesaTill : ''}
                    <div class="receipt-kra">
                        ${config.kraPin ? 'KRA PIN: ' + config.kraPin + '<br>' : ''}
                        eTIMS Invoice<br>
                        <br>Powered by Rudder Research and Data Analytics
                    </div>
                </div>
            `;
            openModal('receiptModal');
        }
        
        function printReceipt() { window.print(); }
        // ==================== INVENTORY ====================
        function renderInventory() {
            document.getElementById('invCategoryFilter').innerHTML = '<option value="all">All Categories</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
            filterInventory();
        }
        
        function filterInventory() {
            const catVal = document.getElementById('invCategoryFilter').value;
            const stockVal = document.getElementById('invStockFilter').value;
            const search = document.getElementById('invSearch').value.toLowerCase();
            
            let filtered = products.filter(p => {
                const matchCat = catVal === 'all' || p.category === catVal;
                const matchStock = stockVal === 'all' || (stockVal === 'low' && p.stock <= p.reorder && p.stock > 0) || (stockVal === 'out' && p.stock === 0);
                const matchSearch = !search || p.name.toLowerCase().includes(search);
                return matchCat && matchStock && matchSearch;
            });
            
            if (restockMode) {
                document.getElementById('inventoryGrid').style.display = 'grid';
                document.getElementById('inventoryTable').style.display = 'none';
                document.getElementById('inventoryGrid').innerHTML = filtered.map(p => {
                    const stockClass = p.stock === 0 ? 'out' : p.stock <= p.reorder ? 'low' : '';
                    const badgeClass = p.stock === 0 ? 'out' : p.stock <= p.reorder ? 'low' : 'normal';
                    return `<div class="inventory-card ${stockClass}" onclick="openRestockModal('${p.id}')"><div class="inventory-card-emoji">${getEmoji(p.category)}</div><div class="inventory-card-name">${p.name}</div><div class="inventory-card-stock ${badgeClass}">Stock: ${p.stock}</div></div>`;
                }).join('');
            } else {
                document.getElementById('inventoryGrid').style.display = 'none';
                document.getElementById('inventoryTable').style.display = 'block';
                const totalValue = filtered.reduce((s, p) => s + p.cost * p.stock, 0);
                document.getElementById('inventoryTableBody').innerHTML = filtered.map(p => {
                    const margin = p.price > 0 ? Math.round((p.price - p.cost) / p.price * 100) : 0;
                    const stockClass = p.stock === 0 ? 'danger' : p.stock <= p.reorder ? 'warning' : 'success';
                    return `<tr>
                        <td><strong>${getEmoji(p.category)} ${p.name}</strong></td>
                        <td><code>${p.sku || '-'}</code></td>
                        <td>${p.category}</td>
                        <td>${formatKsh(p.cost)}</td>
                        <td>${formatKsh(p.price)}</td>
                        <td><span class="table-status ${margin >= 20 ? 'success' : margin >= 10 ? 'warning' : 'danger'}">${margin}%</span></td>
                        <td><span class="table-status ${stockClass}">${p.stock} units</span></td>
                        <td>${formatKsh(p.cost * p.stock)}</td>
                        <td><button class="action-btn success" onclick="openRestockModal('${p.id}')">+Stock</button><button class="action-btn primary" onclick="editProduct('${p.id}')">Edit</button><button class="action-btn danger" onclick="deleteProduct('${p.id}')">Delete</button></td>
                    </tr>`;
                }).join('') + `<tr style="background:var(--bg-dark);font-weight:700"><td colspan="7">Total Inventory Value</td><td colspan="2">${formatKsh(totalValue)}</td></tr>`;
            }
        }
        
        function toggleRestockMode() {
            restockMode = !restockMode;
            document.getElementById('restockBanner').classList.toggle('show', restockMode);
            filterInventory();
        }
        
        function openRestockModal(productId) {
            restockProduct = products.find(p => p.id === productId);
            if (!restockProduct) return;
            document.getElementById('restockEmoji').textContent = getEmoji(restockProduct.category);
            document.getElementById('restockName').textContent = restockProduct.name;
            document.getElementById('restockCurrentStock').textContent = restockProduct.stock;
            document.getElementById('restockQty').value = 10;
            updateRestockTotal();
            openModal('restockModal');
        }
        
        function setRestockQty(qty) { document.getElementById('restockQty').value = qty; updateRestockTotal(); }
        function updateRestockTotal() {
            const qty = parseInt(document.getElementById('restockQty').value) || 0;
            document.getElementById('restockNewTotal').textContent = (restockProduct ? restockProduct.stock : 0) + qty;
        }
        
        function confirmRestock() {
            if (!restockProduct) return;
            const qty = parseInt(document.getElementById('restockQty').value) || 0;
            if (qty <= 0) { showToast('Enter valid quantity', 'error'); return; }
            restockProduct.stock += qty;
            localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products));
            closeModal('restockModal');
            showToast(`Added ${qty} units to ${restockProduct.name}`, 'success', 'Stock Updated');
            filterInventory();
            updateBadges();
        }
        
        function showAddProductModal() {
            document.getElementById('newProductCategory').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductCost').value = '';
            document.getElementById('newProductPrice').value = '';
            document.getElementById('newProductStock').value = '0';
            document.getElementById('newProductReorder').value = '10';
            openModal('addProductModal');
        }
        
        // UPDATED: Added SKU auto-generation and auto-category detection
        function addNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            let category = document.getElementById('newProductCategory').value;
            const cost = parseFloat(document.getElementById('newProductCost').value) || 0;
            const price = parseFloat(document.getElementById('newProductPrice').value) || 0;
            const stock = parseInt(document.getElementById('newProductStock').value) || 0;
            const reorder = parseInt(document.getElementById('newProductReorder').value) || 10;
            const vat = parseInt(document.getElementById('newProductVat').value) || 16;
            
            if (!name || !price) { showToast('Enter product name and price', 'error'); return; }
            
            // Auto-detect category from product name if not selected
            if (!category) {
                const nameLower = name.toLowerCase();
                if (nameLower.includes('flour') || nameLower.includes('maize') || nameLower.includes('rice') || nameLower.includes('bread')) {
                    category = 'Food & Grains';
                } else if (nameLower.includes('soap') || nameLower.includes('detergent') || nameLower.includes('clean')) {
                    category = 'Cleaning';
                } else if (nameLower.includes('oil') || nameLower.includes('cooking') || nameLower.includes('fat')) {
                    category = 'Cooking';
                } else if (nameLower.includes('drink') || nameLower.includes('soda') || nameLower.includes('juice') || nameLower.includes('water')) {
                    category = 'Beverages';
                } else if (nameLower.includes('milk') || nameLower.includes('yogurt') || nameLower.includes('cheese')) {
                    category = 'Dairy';
                } else if (nameLower.includes('phone') || nameLower.includes('charger') || nameLower.includes('cable')) {
                    category = 'Electronics';
                } else if (nameLower.includes('book') || nameLower.includes('pen') || nameLower.includes('paper')) {
                    category = 'Stationery';
                } else {
                    category = 'General';
                }
                
                // Add category if it doesn't exist
                if (!categories.includes(category)) {
                    categories.push(category);
                    categories.sort();
                    localStorage.setItem(STORAGE_KEYS.categories, JSON.stringify(categories));
                }
            }
            
            // ADDED: SKU generation
            let sku = document.getElementById('newProductSKU')?.value.trim();
            if (!sku) {
                const prefix = (category || "GEN").substring(0,3).toUpperCase();
                sku = prefix + Math.floor(10000 + Math.random() * 90000);
                while (products.some(p => p.sku === sku)) {
                    sku = prefix + Math.floor(10000 + Math.random() * 90000);
                }
            }
            
            products.push({ id: 'P' + Date.now(), sku, name, category, cost, price, stock, reorder, vat });
            localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products));
            closeModal('addProductModal');
            showToast(`Product added to ${category}`, 'success');
            renderInventory();
            renderPOS();
        }
        
        function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            products = products.filter(p => p.id !== id);
            localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products));
            renderInventory();
            renderPOS();
        }
        
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            // Populate category dropdown
            document.getElementById('editProductCategory').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Populate edit modal with current values
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductCategory').value = product.category;
            document.getElementById('editProductCost').value = product.cost;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductStock').value = product.stock;
            document.getElementById('editProductReorder').value = product.reorder;
            document.getElementById('editProductVat').value = product.vat;
            
            // Show modal
            openModal('editProductModal');
        }
        
        function saveProductEdit() {
            const id = document.getElementById('editProductId').value;
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            // Update product with new values
            product.name = document.getElementById('editProductName').value.trim();
            product.category = document.getElementById('editProductCategory').value;
            product.cost = parseFloat(document.getElementById('editProductCost').value) || 0;
            product.price = parseFloat(document.getElementById('editProductPrice').value) || 0;
            product.stock = parseInt(document.getElementById('editProductStock').value) || 0;
            product.reorder = parseInt(document.getElementById('editProductReorder').value) || 10;
            product.vat = parseInt(document.getElementById('editProductVat').value) || 16;
            
            if (!product.name || !product.price) {
                showToast('Enter product name and price', 'error');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products));
            
            closeModal('editProductModal');
            showToast('Product updated successfully', 'success');
            renderInventory();
            renderPOS();
        }
        
        // ==================== CATEGORIES ====================
        function renderCategories() {
            document.getElementById('categoriesGrid').innerHTML = categories.map(c => `
                <div class="inventory-card" style="cursor:default">
                    <div class="inventory-card-emoji">${getEmoji(c)}</div>
                    <div class="inventory-card-name">${c}</div>
                    <div class="inventory-card-stock normal">${products.filter(p => p.category === c).length} products</div>
                </div>
            `).join('');
        }
        
        function showAddCategoryModal() {
            const name = prompt('Enter new category name:');
            if (name && !categories.includes(name)) {
                categories.push(name);
                localStorage.setItem(STORAGE_KEYS.categories, JSON.stringify(categories));
                renderCategories();
                showToast('Category added', 'success');
            }
        }
        
        // ==================== SUPPLIERS ====================
        function renderSuppliers() {
            document.getElementById('suppliersTableBody').innerHTML = suppliers.map(s => `
                <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.contact}</td>
                    <td>${s.phone}</td>
                    <td>${s.email}</td>
                    <td>${s.products}</td>
                    <td><button class="action-btn primary" onclick="editSupplier('${s.id}')">Edit</button><button class="action-btn danger" onclick="deleteSupplier('${s.id}')">Delete</button></td>
                </tr>
            `).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No suppliers added yet</td></tr>';
        }
        
        function showAddSupplierModal() {
            const name = prompt('Supplier Name:');
            if (!name) return;
            const contact = prompt('Contact Person:') || '';
            const phone = prompt('Phone Number:') || '';
            const email = prompt('Email:') || '';
            const prods = prompt('Products Supplied:') || '';
            suppliers.push({ id: 'SUP' + Date.now(), name, contact, phone, email, products: prods });
            localStorage.setItem(STORAGE_KEYS.suppliers, JSON.stringify(suppliers));
            renderSuppliers();
            showToast('Supplier added', 'success');
        }
        
        function deleteSupplier(id) {
            if (!confirm('Delete this supplier?')) return;
            suppliers = suppliers.filter(s => s.id !== id);
            localStorage.setItem(STORAGE_KEYS.suppliers, JSON.stringify(suppliers));
            renderSuppliers();
        }
        
        // ==================== CREDIT SALES ====================
        function renderCreditSales() {
            const today = getTodayDate();
            const pending = creditSales.filter(c => c.amount - c.paid > 0);
            const totalCredit = creditSales.reduce((s, c) => s + c.amount, 0);
            const totalPaid = creditSales.reduce((s, c) => s + c.paid, 0);
            const totalBalance = totalCredit - totalPaid;
            
            document.getElementById('creditTotal').textContent = formatKsh(totalCredit);
            document.getElementById('creditPaid').textContent = formatKsh(totalPaid);
            document.getElementById('creditBalance').textContent = formatKsh(totalBalance);
            
            document.getElementById('creditTableBody').innerHTML = creditSales.map(c => {
                const balance = c.amount - c.paid;
                const isOverdue = c.dueDate && new Date(c.dueDate) < new Date(today) && balance > 0;
                return `
                <tr>
                    <td><strong>${c.customer}</strong></td>
                    <td>${c.phone}</td>
                    <td>${formatKsh(c.amount)}</td>
                    <td style="color:var(--accent-green)">${formatKsh(c.paid)}</td>
                    <td style="color:var(--accent-orange);font-weight:700">${formatKsh(balance)}</td>
                    <td>${c.dueDate || 'N/A'}</td>
                    <td><span class="table-status ${balance === 0 ? 'success' : isOverdue ? 'danger' : 'warning'}">${balance === 0 ? 'Paid' : isOverdue ? 'Overdue' : 'Pending'}</span></td>
                    <td>${balance > 0 ? `<button class="action-btn success" onclick="openPaymentModal('${c.id}')">Pay</button>` : ''}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="8" style="text-align:center;color:var(--text-muted)">No credit sales</td></tr>';
        }
        
        function openPaymentModal(id) {
            const credit = creditSales.find(c => c.id === id);
            if (!credit) return;
            paymentCreditId = id;
            document.getElementById('paymentCustomer').textContent = credit.customer;
            document.getElementById('paymentBalance').textContent = formatKsh(credit.amount - credit.paid);
            document.getElementById('paymentAmount').value = '';
            openModal('paymentModal');
        }
        
        function recordCreditPayment() {
            const credit = creditSales.find(c => c.id === paymentCreditId);
            if (!credit) return;
            const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            if (amount <= 0) { showToast('Enter valid amount', 'error'); return; }
            credit.paid = Math.min(credit.amount, credit.paid + amount);
            localStorage.setItem(STORAGE_KEYS.credit, JSON.stringify(creditSales));
            closeModal('paymentModal');
            showToast(`Payment of ${formatKsh(amount)} recorded`, 'success');
            renderCreditSales();
            updateBadges();
        }
        
        // ==================== EXPENSES ====================
        function renderExpenses() {
            const today = getTodayDate();
            const thisMonth = today.substring(0, 7);
            const todayExp = expenses.filter(e => e.date === today).reduce((s, e) => s + e.amount, 0);
            const monthExp = expenses.filter(e => e.date.startsWith(thisMonth)).reduce((s, e) => s + e.amount, 0);
            const totalExp = expenses.reduce((s, e) => s + e.amount, 0);
            
            document.getElementById('expenseToday').textContent = formatKsh(todayExp);
            document.getElementById('expenseMonth').textContent = formatKsh(monthExp);
            document.getElementById('expenseTotal').textContent = formatKsh(totalExp);
            
            document.getElementById('expenseTableBody').innerHTML = expenses.slice(0, 50).map(e => `
                <tr>
                    <td>${e.date}</td>
                    <td><span class="table-status info">${e.category}</span></td>
                    <td>${e.description}</td>
                    <td style="color:var(--accent-red);font-weight:700">${formatKsh(e.amount)}</td>
                    <td>${e.recordedBy || 'Admin'}</td>
                    <td><button class="action-btn danger" onclick="deleteExpense('${e.id}')">Delete</button></td>
                </tr>
            `).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No expenses recorded</td></tr>';
            
            renderExpenseCharts();
        }
        
        function renderExpenseCharts() {
            // Category chart
            const categoryTotals = {};
            expenses.forEach(e => { categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount; });
            
            if (charts.expenseCategory) charts.expenseCategory.destroy();
            charts.expenseCategory = new Chart(document.getElementById('expenseCategoryChart'), {
                type: 'pie',
                data: { labels: Object.keys(categoryTotals), datasets: [{ data: Object.values(categoryTotals), backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#06b6d4'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 12 } } } }
            });
        }
        
        function showAddExpenseModal() { openModal('addExpenseModal'); }
        
        function addExpense() {
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const ref = document.getElementById('expenseRef').value.trim();
            
            if (!description || amount <= 0) { showToast('Enter description and amount', 'error'); return; }
            
            expenses.unshift({ id: 'EXP' + Date.now(), date: getTodayDate(), category, description, amount, ref, recordedBy: currentUser.name });
            localStorage.setItem(STORAGE_KEYS.expenses, JSON.stringify(expenses));
            
            // Journal entry
            journalEntries.push({ id: 'JE' + Date.now(), date: getTodayDate(), ref: 'EXP', description: `Expense: ${description}`, debit: category, credit: 'Cash', amount });
            localStorage.setItem(STORAGE_KEYS.journal, JSON.stringify(journalEntries));
            
            closeModal('addExpenseModal');
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseRef').value = '';
            showToast('Expense recorded', 'success');
            renderExpenses();
            renderDashboard();
        }
        
        function deleteExpense(id) {
            if (!confirm('Delete this expense?')) return;
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem(STORAGE_KEYS.expenses, JSON.stringify(expenses));
            renderExpenses();
        }
        
        // ==================== ACCOUNTING ====================
        function renderAccounts() {
            const accounts = {
                assets: [{ name: 'Cash', balance: sales.filter(s => s.paymentMethod === 'Cash').reduce((s,x) => s + x.total, 0) - expenses.reduce((s,e) => s + e.amount, 0) },
                        { name: 'M-Pesa', balance: sales.filter(s => s.paymentMethod === 'M-Pesa').reduce((s,x) => s + x.total, 0) },
                        { name: 'Accounts Receivable', balance: creditSales.reduce((s,c) => s + (c.amount - c.paid), 0) },
                        { name: 'Inventory', balance: products.reduce((s,p) => s + p.cost * p.stock, 0) }],
                liabilities: [{ name: 'VAT Payable', balance: sales.reduce((s,x) => s + (x.vat || 0), 0) },
                              { name: 'Accounts Payable', balance: 0 }],
                equity: [{ name: 'Retained Earnings', balance: sales.reduce((s,x) => s + (x.profit || 0), 0) - expenses.reduce((s,e) => s + e.amount, 0) }],
                revenue: [{ name: 'Sales Revenue', balance: sales.reduce((s,x) => s + x.total, 0) }],
                expense: [{ name: 'Cost of Goods Sold', balance: sales.reduce((s,x) => s + x.items.reduce((a,i) => a + i.cost * i.qty, 0), 0) },
                          { name: 'Operating Expenses', balance: expenses.reduce((s,e) => s + e.amount, 0) }]
            };
            
            const renderAccountList = (list, positive) => list.map(a => `<div class="account-balance"><span class="account-name">${a.name}</span><span class="account-amount ${a.balance >= 0 === positive ? 'positive' : 'negative'}">${formatKsh(Math.abs(a.balance))}</span></div>`).join('');
            
            document.getElementById('assetAccounts').innerHTML = renderAccountList(accounts.assets, true);
            document.getElementById('liabilityAccounts').innerHTML = renderAccountList(accounts.liabilities, false);
            document.getElementById('equityAccounts').innerHTML = renderAccountList(accounts.equity, true);
            document.getElementById('revenueAccounts').innerHTML = renderAccountList(accounts.revenue, true);
            document.getElementById('expenseAccounts').innerHTML = renderAccountList(accounts.expense, false);
        }
        
        function renderJournal() {
            document.getElementById('journalTableBody').innerHTML = journalEntries.slice(0, 50).map(j => `
                <tr>
                    <td>${j.date}</td>
                    <td>${j.ref}</td>
                    <td>${j.description}</td>
                    <td style="color:var(--accent-red)">${formatKsh(j.amount)}</td>
                    <td style="color:var(--accent-green)">${formatKsh(j.amount)}</td>
                    <td><button class="action-btn primary" onclick="viewJournalEntry('${j.id}')">View</button></td>
                </tr>
            `).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No journal entries</td></tr>';
        }
        
        function showAddJournalModal() {
            showToast('Journal entry feature coming soon!', 'info');
        }
        
        function showAddAccountModal() {
            showToast('Chart of accounts feature coming soon!', 'info');
        }
        
        function viewJournalEntry(id) {
            showToast('Journal entry details coming soon!', 'info');
        }
        // ==================== REPORTS & ANALYTICS ====================
        function renderReports() {
            const grossRevenue = sales.reduce((s, x) => s + x.total, 0);
            const grossProfit = sales.reduce((s, x) => s + (x.profit || 0), 0);
            const totalExpenses = expenses.reduce((s, e) => s + e.amount, 0);
            const netProfit = grossProfit - totalExpenses;
            
            document.getElementById('reportGrossRevenue').textContent = formatKsh(grossRevenue);
            document.getElementById('reportGrossProfit').textContent = formatKsh(grossProfit);
            document.getElementById('reportExpenses').textContent = formatKsh(totalExpenses);
            document.getElementById('reportNetProfit').textContent = formatKsh(netProfit);
            document.getElementById('reportNetProfit').style.color = netProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            renderReportCharts();
            renderTopProducts();
        }
        
        function renderReportCharts() {
            // Sales trend (30 days)
            const days = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                const dayTotal = sales.filter(s => s.date === ds).reduce((s, x) => s + x.total, 0);
                days.push({ date: d.getDate(), total: dayTotal });
            }
            
            if (charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(document.getElementById('salesTrendChart'), {
                type: 'line',
                data: { labels: days.map(d => d.date), datasets: [{ label: 'Daily Sales', data: days.map(d => d.total), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#64748b', callback: v => 'Ksh ' + v.toLocaleString() }, grid: { color: '#1e293b' } }, x: { ticks: { color: '#64748b' }, grid: { display: false } } } }
            });
            
            // Profit vs Expenses
            const months = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(); d.setMonth(d.getMonth() - i);
                const m = d.toISOString().substring(0, 7);
                const mProfit = sales.filter(s => s.date.startsWith(m)).reduce((s, x) => s + (x.profit || 0), 0);
                const mExpense = expenses.filter(e => e.date.startsWith(m)).reduce((s, e) => s + e.amount, 0);
                months.push({ month: d.toLocaleDateString('en-KE', { month: 'short' }), profit: mProfit, expense: mExpense });
            }
            
            if (charts.profitExpense) charts.profitExpense.destroy();
            charts.profitExpense = new Chart(document.getElementById('profitExpenseChart'), {
                type: 'bar',
                data: { labels: months.map(m => m.month), datasets: [{ label: 'Profit', data: months.map(m => m.profit), backgroundColor: '#10b981' }, { label: 'Expenses', data: months.map(m => m.expense), backgroundColor: '#ef4444' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8' } } }, scales: { y: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }, x: { ticks: { color: '#64748b' }, grid: { display: false } } } }
            });
            
            // Category sales
            const catSales = {};
            sales.forEach(s => s.items.forEach(i => {
                const p = products.find(pr => pr.id === i.productId);
                const cat = p ? p.category : 'Other';
                catSales[cat] = (catSales[cat] || 0) + i.price * i.qty;
            }));
            
            if (charts.categorySales) charts.categorySales.destroy();
            charts.categorySales = new Chart(document.getElementById('categorySalesChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(catSales), datasets: [{ data: Object.values(catSales), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', boxWidth: 12 } } } }
            });
            
            // Hourly sales
            const hourly = Array(24).fill(0);
            sales.forEach(s => {
                if (s.time) {
                    const h = parseInt(s.time.split(':')[0]);
                    hourly[h] += s.total;
                }
            });
            
            if (charts.hourly) charts.hourly.destroy();
            charts.hourly = new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: { labels: Array.from({ length: 24 }, (_, i) => i + ':00'), datasets: [{ label: 'Sales', data: hourly, backgroundColor: '#8b5cf6' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }, x: { ticks: { color: '#64748b', maxRotation: 45 }, grid: { display: false } } } }
            });
        }
        
        function renderTopProducts() {
            const productSales = {};
            sales.forEach(s => s.items.forEach(i => {
                productSales[i.name] = (productSales[i.name] || 0) + i.price * i.qty;
            }));
            const top = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            document.getElementById('topProductsList').innerHTML = top.map((p, i) => `
                <div class="breakdown-item">
                    <div class="breakdown-left">
                        <div class="breakdown-icon" style="background:var(--bg-dark);font-weight:700">${i + 1}</div>
                        <div class="breakdown-label">${p[0]}</div>
                    </div>
                    <div class="breakdown-value">${formatKsh(p[1])}</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted);text-align:center">No sales data</p>';
        }
        
        // ==================== KRA COMPLIANCE ====================
        function renderKRA() {
            updateKRAReport();
        }
        
        function updateKRAReport() {
            const period = document.getElementById('kraPeriod').value;
            const now = new Date();
            let filtered = sales;
            
            if (period === 'month') {
                const m = now.toISOString().substring(0, 7);
                filtered = sales.filter(s => s.date.startsWith(m));
            } else if (period === 'quarter') {
                const qStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                filtered = sales.filter(s => new Date(s.date) >= qStart);
            } else {
                filtered = sales.filter(s => new Date(s.date).getFullYear() === now.getFullYear());
            }
            
            const totalSales = filtered.reduce((s, x) => s + x.total, 0);
            const outputVat = filtered.reduce((s, x) => s + (x.vat || 0), 0);
            const inputVat = expenses.reduce((s, e) => s + Math.round(e.amount * 16 / 116), 0);
            const netVat = outputVat - inputVat;
            
            document.getElementById('kraTotalSales').textContent = formatKsh(totalSales);
            document.getElementById('kraOutputVat').textContent = formatKsh(outputVat);
            document.getElementById('kraInputVat').textContent = formatKsh(inputVat);
            document.getElementById('kraNetVat').textContent = formatKsh(netVat);
            document.getElementById('kraNetVat').parentElement.style.background = netVat >= 0 ? 'rgba(239,68,68,.2)' : 'rgba(16,185,129,.2)';
            
            document.getElementById('kraInvoiceCount').textContent = filtered.length;
            document.getElementById('kraStandardRated').textContent = formatKsh(filtered.filter(s => s.items.some(i => i.vat === 16)).reduce((s, x) => s + x.total, 0));
            document.getElementById('kraZeroRated').textContent = formatKsh(filtered.filter(s => s.items.some(i => i.vat === 0)).reduce((s, x) => s + x.total, 0));
            
            // Due date
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 20);
            document.getElementById('kraVatDue').textContent = nextMonth.toLocaleDateString('en-KE', { day: 'numeric', month: 'short' });
            const daysUntil = Math.ceil((nextMonth - now) / (1000 * 60 * 60 * 24));
            document.getElementById('kraDaysUntil').textContent = daysUntil + ' days';
            document.getElementById('kraDaysUntil').style.color = daysUntil < 7 ? 'var(--accent-red)' : 'var(--accent-yellow)';
            
            // Details table
            document.getElementById('kraDetailsTable').innerHTML = `
                <tr><td>Total Sales (Incl. VAT)</td><td>${formatKsh(totalSales)}</td><td>-</td></tr>
                <tr><td>Standard Rated Sales (16%)</td><td>${formatKsh(totalSales - outputVat)}</td><td>${formatKsh(outputVat)}</td></tr>
                <tr><td>Zero Rated Sales (0%)</td><td>${formatKsh(0)}</td><td>Ksh 0</td></tr>
                <tr><td>Exempt Sales</td><td>${formatKsh(0)}</td><td>N/A</td></tr>
                <tr style="background:var(--bg-dark)"><td><strong>Output VAT</strong></td><td></td><td><strong>${formatKsh(outputVat)}</strong></td></tr>
                <tr><td>Input VAT (from Expenses)</td><td></td><td style="color:var(--accent-green)">- ${formatKsh(inputVat)}</td></tr>
                <tr style="background:rgba(59,130,246,.1)"><td><strong>Net VAT Payable</strong></td><td></td><td><strong style="color:${netVat >= 0 ? 'var(--accent-red)' : 'var(--accent-green)'}">${formatKsh(netVat)}</strong></td></tr>
            `;
        }
        
        function generateETIMSReport() {
            showToast('eTIMS report generated', 'success', 'Report Ready');
            exportKRAReport();
        }
        
        function exportKRAReport() {
            const wb = XLSX.utils.book_new();
            const kraData = sales.map(s => ({
                'Invoice No': s.id,
                'Date': s.date,
                'Time': s.time,
                'Items': s.items.map(i => i.name).join(', '),
                'Subtotal': s.subtotal,
                'VAT': s.vat,
                'Total': s.total,
                'Payment': s.paymentMethod
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kraData), 'Tax Report');
            XLSX.writeFile(wb, `KRA_Report_${getTodayDate()}.xlsx`);
            showToast('KRA report exported', 'success');
        }
        
        // ==================== PROFIT & LOSS ====================
        function renderProfitLoss() { updateProfitLoss(); }
        
        function updateProfitLoss() {
            const period = document.getElementById('plPeriod').value;
            const now = new Date();
            let filteredSales = sales, filteredExp = expenses;
            
            if (period === 'month') {
                const m = now.toISOString().substring(0, 7);
                filteredSales = sales.filter(s => s.date.startsWith(m));
                filteredExp = expenses.filter(e => e.date.startsWith(m));
            }
            
            const revenue = filteredSales.reduce((s, x) => s + x.total, 0);
            const cogs = filteredSales.reduce((s, x) => s + x.items.reduce((a, i) => a + i.cost * i.qty, 0), 0);
            const grossProfit = revenue - cogs;
            const opExpenses = filteredExp.reduce((s, e) => s + e.amount, 0);
            const netIncome = grossProfit - opExpenses;
            
            // Group expenses
            const expByCategory = {};
            filteredExp.forEach(e => { expByCategory[e.category] = (expByCategory[e.category] || 0) + e.amount; });
            
            document.getElementById('profitLossStatement').innerHTML = `
                <table class="data-table">
                    <thead><tr><th>Description</th><th style="text-align:right">Amount (Ksh)</th></tr></thead>
                    <tbody>
                        <tr style="background:rgba(16,185,129,.1)"><td><strong>Revenue</strong></td><td style="text-align:right"><strong>${formatKsh(revenue)}</strong></td></tr>
                        <tr><td style="padding-left:24px">Sales Revenue</td><td style="text-align:right">${formatKsh(revenue)}</td></tr>
                        <tr style="background:rgba(239,68,68,.05)"><td><strong>Cost of Goods Sold</strong></td><td style="text-align:right;color:var(--accent-red)"><strong>(${formatKsh(cogs)})</strong></td></tr>
                        <tr style="background:rgba(59,130,246,.1)"><td><strong>Gross Profit</strong></td><td style="text-align:right"><strong>${formatKsh(grossProfit)}</strong></td></tr>
                        <tr><td><strong>Operating Expenses</strong></td><td></td></tr>
                        ${Object.entries(expByCategory).map(([cat, amt]) => `<tr><td style="padding-left:24px">${cat}</td><td style="text-align:right;color:var(--accent-red)">(${formatKsh(amt)})</td></tr>`).join('')}
                        <tr><td style="padding-left:24px"><em>Total Operating Expenses</em></td><td style="text-align:right;color:var(--accent-red)"><em>(${formatKsh(opExpenses)})</em></td></tr>
                        <tr style="background:${netIncome >= 0 ? 'rgba(16,185,129,.2)' : 'rgba(239,68,68,.2)'}"><td><strong style="font-size:1.1rem">Net Income</strong></td><td style="text-align:right;font-size:1.1rem"><strong style="color:${netIncome >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${formatKsh(netIncome)}</strong></td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function exportProfitLoss() {
            showToast('Profit & Loss exported', 'success');
        }
        // ==================== USERS ====================
        function renderUsers() {
            document.getElementById('usersTableBody').innerHTML = users.map(u => `
                <tr>
                    <td><strong>${u.name}</strong><br><small style="color:var(--text-muted)">${u.email || 'No email'}</small></td>
                    <td>${u.username}</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px">
                            <code style="background:var(--bg-dark);padding:4px 8px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:0.85rem">${u.password || 'â€¢â€¢â€¢â€¢â€¢â€¢'}</code>
                            <button onclick="copyToClipboard('${u.password}', 'Password copied!')" style="background:transparent;border:none;cursor:pointer;font-size:1rem" title="Copy password">ðŸ“‹</button>
                        </div>
                    </td>
                    <td><span class="table-status ${u.role === 'admin' ? 'info' : 'success'}">${u.role === 'admin' ? 'ðŸ‘‘ Admin' : 'ðŸ›’ Seller'}</span></td>
                    <td><span class="table-status ${u.status === 'active' ? 'success' : 'danger'}">${u.status}</span></td>
                    <td>${u.lastLogin ? new Date(u.lastLogin).toLocaleString('en-KE') : 'Never'}</td>
                    <td>
                        <button class="action-btn primary" onclick="openResetPasswordModal(${u.id})">ðŸ”‘ Reset</button>
                        ${u.id !== currentUser.id ? `<button class="action-btn ${u.status === 'active' ? 'warning' : 'success'}" onclick="toggleUserStatus(${u.id})">${u.status === 'active' ? 'Disable' : 'Enable'}</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        // Helper function to copy text to clipboard
        function copyToClipboard(text, successMsg) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(successMsg || 'Copied to clipboard!', 'success');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    showToast('Failed to copy', 'error');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast(successMsg || 'Copied to clipboard!', 'success');
                } catch (err) {
                    showToast('Failed to copy', 'error');
                }
                document.body.removeChild(textArea);
            }
        }
        
        // UPDATED: Admin-only access to add user modal
        function showAddUserModal() { 
            if (currentUser?.role !== 'admin') {
                showToast("Only admin can add users", "error");
                return;
            }
            openModal('addUserModal'); 
        }
        
        // UPDATED: Admin-only user creation with credential display
        function addNewUser() {
            if (currentUser?.role !== 'admin') {
                showToast("Only admin can create users", "error");
                return;
            }

            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (!name || !email || !username || !password) {
                showToast("All fields required", "error");
                return;
            }
            if (users.some(u => u.username === username)) {
                showToast("Username taken", "error");
                return;
            }
            if (users.some(u => u.email === email)) {
                showToast("Email already used", "error");
                return;
            }

            users.push({
                id: Date.now(),
                name, email, username, password,
                role, status: 'active', lastLogin: null
            });

            saveAllData();
            closeModal('addUserModal');

            // Show credentials clearly
            const msg = `User created!\n\nUsername: ${username}\nPassword: ${password}\nEmail: ${email}\nRole: ${role}\n\nCopy and send to the employee (WhatsApp/SMS).`;
            alert(msg);  // or use your showToast / custom modal
            showToast("User created - credentials shown", "success");
            renderUsers();
        }
        
        let resetUserId = null;
        function openResetPasswordModal(userId) {
            resetUserId = userId;
            const user = users.find(u => u.id === userId);
            if (user) {
                document.getElementById('resetUserName').textContent = user.name;
                document.getElementById('resetUserEmail').textContent = user.email || user.username;
                document.getElementById('resetNewPassword').value = '';
                document.getElementById('resetConfirmPassword').value = '';
                openModal('resetPasswordModal');
            }
        }
        
        function confirmPasswordReset() {
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;
            
            if (!newPassword || !confirmPassword) { showToast('Fill all password fields', 'error'); return; }
            if (newPassword !== confirmPassword) { showToast('Passwords do not match', 'error'); return; }
            if (newPassword.length < 6) { showToast('Password must be at least 6 characters', 'error'); return; }
            
            const user = users.find(u => u.id === resetUserId);
            if (user) {
                user.password = newPassword;
                localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(users));
                closeModal('resetPasswordModal');
                showToast(`Password reset for ${user.name}`, 'success');
                renderUsers();
            }
        }
        
        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                user.status = user.status === 'active' ? 'inactive' : 'active';
                localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(users));
                renderUsers();
            }
        }
        
        // ==================== SETTINGS ====================
        function renderSettings() {
            document.getElementById('settingBusinessName').value = config.businessName || '';
            document.getElementById('settingKraPin').value = config.kraPin || '';
            document.getElementById('settingPhone').value = config.phone || '';
            document.getElementById('settingMpesa').value = config.mpesaTill || '';
            document.getElementById('settingMpesaPaybillNumber').value = config.mpesaPaybillNumber || '';
            document.getElementById('settingMpesaPaybillAccount').value = config.mpesaPaybillAccount || '';
            document.getElementById('settingMpesaPochi').value = config.mpesaPochi || '';
            document.getElementById('settingMpesaSend').value = config.mpesaSend || '';
            document.getElementById('settingVatRate').value = config.vatRate || 16;
            document.getElementById('settingReceiptFooter').value = config.receiptFooter || 'Thank you for shopping with us!';
            
            // ADDED: Load IntaSend settings
            document.getElementById('settingIntasendEnabled').checked = config.intasendEnabled || false;
            document.getElementById('settingIntasendPublicKey').value = config.intasendPublicKey || '';
            document.getElementById('settingIntasendSecretKey').value = config.intasendSecretKey || '';
            document.getElementById('settingIntasendEnvironment').value = config.intasendEnvironment || 'test';
            toggleIntasendFields();
            
            // ADDED: Check for pending IntaSend registration
            checkPendingIntasendRegistration();
        }
        
        function checkPendingIntasendRegistration() {
            const pending = localStorage.getItem('intasend_pending_client');
            if (pending) {
                try {
                    const clientInfo = JSON.parse(pending);
                    const timeSince = Date.now() - new Date(clientInfo.timestamp).getTime();
                    const hoursSince = Math.floor(timeSince / (1000 * 60 * 60));
                    
                    // Show reminder if less than 7 days old
                    if (hoursSince < 168) {
                        showToast(`Reminder: Pending IntaSend registration for ${clientInfo.businessName}`, 'info');
                    } else {
                        // Clear old pending registrations
                        localStorage.removeItem('intasend_pending_client');
                    }
                } catch (e) {
                    localStorage.removeItem('intasend_pending_client');
                }
            }
        }
        
        function saveSettings() {
            config.businessName = document.getElementById('settingBusinessName').value.trim();
            config.kraPin = document.getElementById('settingKraPin').value.trim();
            config.phone = document.getElementById('settingPhone').value.trim();
            config.mpesaTill = document.getElementById('settingMpesa').value.trim();
            config.mpesaPaybillNumber = document.getElementById('settingMpesaPaybillNumber').value.trim();
            config.mpesaPaybillAccount = document.getElementById('settingMpesaPaybillAccount').value.trim();
            config.mpesaPochi = document.getElementById('settingMpesaPochi').value.trim();
            config.mpesaSend = document.getElementById('settingMpesaSend').value.trim();
            config.vatRate = parseInt(document.getElementById('settingVatRate').value) || 16;
            config.receiptFooter = document.getElementById('settingReceiptFooter').value.trim();
            
            // ADDED: Save IntaSend settings
            config.intasendEnabled = document.getElementById('settingIntasendEnabled').checked;
            config.intasendPublicKey = document.getElementById('settingIntasendPublicKey').value.trim();
            config.intasendSecretKey = document.getElementById('settingIntasendSecretKey').value.trim();
            config.intasendEnvironment = document.getElementById('settingIntasendEnvironment').value;
            
            // Clear pending client registration if keys were just added
            if (config.intasendPublicKey && config.intasendSecretKey) {
                const pending = localStorage.getItem('intasend_pending_client');
                if (pending) {
                    const clientInfo = JSON.parse(pending);
                    showToast(`IntaSend setup complete for ${clientInfo.businessName}! ðŸŽ‰`, 'success');
                    localStorage.removeItem('intasend_pending_client');
                }
            }
            
            localStorage.setItem(STORAGE_KEYS.config, JSON.stringify(config));
            
            // Update M-Pesa display in POS cart immediately
            updateMpesaDisplay();
            
            showToast('Settings saved', 'success');
        }
        
        // Update M-Pesa display in cart with saved till number
        function updateMpesaDisplay() {
            const tillEl = document.getElementById('mpesaTillDisplay');
            if (tillEl) {
                // Priority: Till > Paybill > Pochi > Send Money
                if (config.mpesaTill) {
                    tillEl.textContent = config.mpesaTill;
                } else if (config.mpesaPaybillNumber) {
                    tillEl.textContent = config.mpesaPaybillNumber + (config.mpesaPaybillAccount ? ' (Acc: ' + config.mpesaPaybillAccount + ')' : '');
                } else if (config.mpesaPochi) {
                    tillEl.textContent = config.mpesaPochi;
                } else if (config.mpesaSend) {
                    tillEl.textContent = config.mpesaSend;
                } else {
                    tillEl.textContent = 'Not set';
                }
            }
        }
        
        // ADDED: IntaSend Integration Functions
        function toggleIntasendFields() {
            const enabled = document.getElementById('settingIntasendEnabled').checked;
            const hasKeys = config.intasendPublicKey && config.intasendSecretKey;
            
            // Show quick register if enabling but no keys yet
            if (enabled && !hasKeys) {
                document.getElementById('intasendQuickRegister').style.display = 'block';
                document.getElementById('intasendFields').style.display = 'none';
            } else if (enabled && hasKeys) {
                document.getElementById('intasendQuickRegister').style.display = 'none';
                document.getElementById('intasendFields').style.display = 'block';
            } else {
                document.getElementById('intasendQuickRegister').style.display = 'none';
                document.getElementById('intasendFields').style.display = 'none';
            }
        }
        
        function toggleQuickRegister() {
            // Switch between quick register and manual API entry
            const quickReg = document.getElementById('intasendQuickRegister');
            const fields = document.getElementById('intasendFields');
            
            if (quickReg.style.display !== 'none') {
                quickReg.style.display = 'none';
                fields.style.display = 'block';
            } else {
                quickReg.style.display = 'block';
                fields.style.display = 'none';
            }
        }
        
        function openIntasendRegistration() {
            const businessName = document.getElementById('regBusinessName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const kraPin = document.getElementById('regKraPin').value.trim();
            
            if (!businessName || !email || !phone) {
                showToast('Please fill in Business Name, Email, and Phone', 'error');
                return;
            }
            
            // Validate email
            if (!email.includes('@')) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Validate phone
            if (!phone.match(/^07\d{8}$/)) {
                showToast('Phone must be 10 digits starting with 07', 'error');
                return;
            }
            
            // Store client info temporarily for reference
            const clientInfo = {
                businessName,
                email,
                phone,
                kraPin,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('intasend_pending_client', JSON.stringify(clientInfo));
            
            // Open IntaSend registration in new tab
            const registrationUrl = 'https://intasend.com/account/signup';
            window.open(registrationUrl, '_blank');
            
            // Show instructions
            showToast('IntaSend registration opened! Follow the steps, then return here with API keys.', 'success');
            
            // Show modal with detailed instructions
            showIntasendInstructions(clientInfo);
        }
        
        function showIntasendInstructions(clientInfo) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal large">
                    <div class="modal-header">
                        <h3 class="modal-title">ðŸ“‹ IntaSend Registration Steps</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
                        <div style="padding:16px; background:rgba(16,185,129,0.1); border-radius:8px; margin-bottom:16px;">
                            <strong style="color:#10b981;">âœ… Client Info (Copy this):</strong><br>
                            <div style="margin-top:8px; font-family:'JetBrains Mono',monospace; font-size:0.9rem;">
                                <strong>Business:</strong> ${clientInfo.businessName}<br>
                                <strong>Email:</strong> ${clientInfo.email}<br>
                                <strong>Phone:</strong> ${clientInfo.phone}<br>
                                ${clientInfo.kraPin ? `<strong>KRA PIN:</strong> ${clientInfo.kraPin}<br>` : ''}
                            </div>
                        </div>
                        
                        <h4 style="color:var(--accent-blue); margin-top:16px;">Step 1: Fill Registration Form</h4>
                        <p style="color:var(--text-secondary); margin:8px 0; line-height:1.6;">
                            In the IntaSend tab that just opened:<br>
                            â€¢ Enter the client's business name<br>
                            â€¢ Use their email (they'll receive verification)<br>
                            â€¢ Enter their phone number<br>
                            â€¢ Create a password (save it securely)<br>
                            â€¢ Select "Business" account type
                        </p>
                        
                        <h4 style="color:var(--accent-blue); margin-top:16px;">Step 2: Verify Email</h4>
                        <p style="color:var(--text-secondary); margin:8px 0; line-height:1.6;">
                            â€¢ Client receives email from IntaSend<br>
                            â€¢ They click verification link<br>
                            â€¢ Account gets activated
                        </p>
                        
                        <h4 style="color:var(--accent-blue); margin-top:16px;">Step 3: Complete Business Verification</h4>
                        <p style="color:var(--text-secondary); margin:8px 0; line-height:1.6;">
                            Login to IntaSend dashboard and upload:<br>
                            â€¢ Business registration/certificate<br>
                            â€¢ KRA PIN certificate<br>
                            â€¢ ID/Passport of owner<br>
                            â€¢ (Verification takes 1-3 business days)
                        </p>
                        
                        <h4 style="color:var(--accent-blue); margin-top:16px;">Step 4: Get API Keys</h4>
                        <p style="color:var(--text-secondary); margin:8px 0; line-height:1.6;">
                            Once verified:<br>
                            â€¢ Go to Dashboard â†’ API Keys<br>
                            â€¢ Copy <strong>Public Key</strong> (starts with ISPubKey_)<br>
                            â€¢ Copy <strong>Secret Key</strong> (starts with ISSecretKey_)<br>
                            â€¢ Select Test or Live environment
                        </p>
                        
                        <h4 style="color:var(--accent-blue); margin-top:16px;">Step 5: Return Here & Enter Keys</h4>
                        <p style="color:var(--text-secondary); margin:8px 0; line-height:1.6;">
                            â€¢ Close this modal<br>
                            â€¢ Click "I already have API keys â†’"<br>
                            â€¢ Paste Public Key and Secret Key<br>
                            â€¢ Select environment (Test/Live)<br>
                            â€¢ Click "Test API Connection"<br>
                            â€¢ Save Settings âœ…
                        </p>
                        
                        <div style="margin-top:20px; padding:12px; background:rgba(251,191,36,0.1); border-left:3px solid #f59e0b; border-radius:4px;">
                            <strong style="color:#f59e0b;">â±ï¸ Timeline:</strong><br>
                            <span style="color:var(--text-secondary); font-size:0.85rem;">
                                â€¢ Registration: 5 minutes<br>
                                â€¢ Email verification: Instant<br>
                                â€¢ Business verification: 1-3 business days<br>
                                â€¢ API keys available: Immediately after verification
                            </span>
                        </div>
                        
                        <div style="margin-top:12px; padding:12px; background:rgba(59,130,246,0.1); border-left:3px solid #3b82f6; border-radius:4px;">
                            <strong style="color:#3b82f6;">ðŸ’¡ Pro Tip:</strong><br>
                            <span style="color:var(--text-secondary); font-size:0.85rem;">
                                While waiting for verification, use <strong>Test Mode</strong> to try the system with sandbox/fake money. Switch to Live Mode once verified.
                            </span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn success" onclick="this.closest('.modal-overlay').remove()">Got it! ðŸ‘</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function testIntasendConnection() {
            const publicKey = document.getElementById('settingIntasendPublicKey').value.trim();
            const secretKey = document.getElementById('settingIntasendSecretKey').value.trim();
            const environment = document.getElementById('settingIntasendEnvironment').value;
            
            if (!publicKey || !secretKey) {
                showToast('Please enter both Public Key and Secret Key', 'error');
                return;
            }
            
            showToast('Testing IntaSend connection...', 'info');
            
            try {
                // Test API connection by getting account balance/status
                const baseUrl = environment === 'live' 
                    ? 'https://api.intasend.com' 
                    : 'https://sandbox.intasend.com';
                
                const response = await fetch(`${baseUrl}/api/v1/payment/status/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${secretKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok || response.status === 404) {
                    // 404 is OK - means API is accessible, just no transactions yet
                    showToast('âœ… IntaSend API Connected Successfully!', 'success');
                } else {
                    showToast('âŒ API connection failed. Check your keys.', 'error');
                }
            } catch (error) {
                showToast('âŒ Connection error: ' + error.message, 'error');
            }
        }
        
        function resetSystemData() {
            if (!confirm('âš ï¸ WARNING: This will DELETE all sales, inventory, expenses, and credit data!\n\nUsers will be preserved but all business data will be reset to demo state.\n\nAre you absolutely sure?')) {
                return;
            }
            
            if (!confirm('This action CANNOT be undone! Click OK to proceed with data reset.')) {
                return;
            }
            
            // Clear all business data but preserve users
            localStorage.removeItem(STORAGE_KEYS.products);
            localStorage.removeItem(STORAGE_KEYS.sales);
            localStorage.removeItem(STORAGE_KEYS.credit);
            localStorage.removeItem(STORAGE_KEYS.expenses);
            localStorage.removeItem(STORAGE_KEYS.categories);
            localStorage.removeItem(STORAGE_KEYS.suppliers);
            localStorage.removeItem(STORAGE_KEYS.journal);
            
            // Reset arrays
            products = [];
            sales = [];
            creditSales = [];
            expenses = [];
            categories = [];
            suppliers = [];
            journalEntries = [];
            
            // Load demo data
            loadDemoData();
            
            showToast('System data reset successfully', 'success', 'Reset Complete');
            
            // Refresh current view
            renderAll();
        }
        
        // ==================== CLOUD SYNC ====================
        async function syncFromCloud() {
            if (!config.businessId) return;
            
            try {
                // Use simple key-value storage from localStorage with business ID prefix
                const cloudKey = `cloud_${config.businessId}`;
                const cloudData = localStorage.getItem(cloudKey);
                
                if (cloudData) {
                    const data = JSON.parse(cloudData);
                    
                    // Merge cloud data with local data
                    if (data.users && data.users.length > 0) {
                        // Keep local users and merge with cloud users
                        const localUserIds = users.map(u => u.id);
                        const newCloudUsers = data.users.filter(u => !localUserIds.includes(u.id));
                        users = [...users, ...newCloudUsers];
                        localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(users));
                    }
                    
                    // Update other data if cloud is newer
                    if (data.products) products = data.products;
                    if (data.sales) sales = data.sales;
                    if (data.config) {
                        // Merge config but keep local businessId
                        const localBusinessId = config.businessId;
                        config = { ...config, ...data.config, businessId: localBusinessId };
                    }
                    
                    saveAllData();
                    console.log('âœ… Synced from cloud');
                }
            } catch (error) {
                console.error('Cloud sync error:', error);
            }
        }
        
        async function syncToCloud() {
            // Skip if offline, no business ID, or no database connection
            if (!navigator.onLine || !config.businessId || !db) {
                if (!navigator.onLine) {
                    console.log('âš ï¸ Offline - sync skipped, data saved locally');
                }
                return;
            }
            
            try {
                // Use set with merge: true instead of update
                // This creates the document if it doesn't exist, or updates it if it does
                await db.collection('data').doc(config.businessId).set({
                    products: products,
                    sales: sales,
                    creditSales: creditSales,
                    expenses: expenses,
                    categories: categories,
                    suppliers: suppliers,
                    config: config,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log('âœ… Synced to Firebase');
            } catch (error) {
                // Silent fail for offline mode
                if (error.code === 'unavailable' || error.message.includes('network')) {
                    console.log('âš ï¸ Network unavailable - data saved locally only');
                } else {
                    console.error('Firebase sync error:', error);
                }
            }
        }
        
        // Auto-sync every 30 seconds
        setInterval(() => {
            if (config.businessId && currentUser && db) {
                syncToCloud();
            }
        }, 30000);
        
        // ==================== EXPORT ====================
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Sales
            const salesData = sales.map(s => ({ Date: s.date, Time: s.time, Receipt: s.id, Items: s.items.map(i => i.name).join(', '), Total: s.total, VAT: s.vat, Payment: s.paymentMethod, Cashier: s.cashier }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salesData), 'Sales');
            
            // Inventory
            const invData = products.map(p => ({ Name: p.name, Category: p.category, Cost: p.cost, Price: p.price, Stock: p.stock, Value: p.cost * p.stock }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invData), 'Inventory');
            
            // Expenses
            const expData = expenses.map(e => ({ Date: e.date, Category: e.category, Description: e.description, Amount: e.amount }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expData), 'Expenses');
            
            // Credit
            const creditData = creditSales.map(c => ({ Customer: c.customer, Phone: c.phone, Amount: c.amount, Paid: c.paid, Balance: c.amount - c.paid, Due: c.dueDate }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(creditData), 'Credit Sales');
            
            XLSX.writeFile(wb, `BiasharaFlow_Export_${getTodayDate()}.xlsx`);
            showToast('Data exported to Excel', 'success');
        }
        
        function exportSalesToExcel() {
            const wb = XLSX.utils.book_new();
            const data = sales.map(s => ({ Date: s.date, Time: s.time, Receipt: s.id, Items: s.items.map(i => `${i.name} x${i.qty}`).join(', '), Subtotal: s.subtotal, VAT: s.vat, Total: s.total, Payment: s.paymentMethod, Cashier: s.cashier }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Sales');
            XLSX.writeFile(wb, `Sales_${getTodayDate()}.xlsx`);
            showToast('Sales exported', 'success');
        }
        
        function exportInventory() {
            const wb = XLSX.utils.book_new();
            const data = products.map(p => ({ Name: p.name, Category: p.category, Cost: p.cost, Price: p.price, Margin: Math.round((p.price - p.cost) / p.price * 100) + '%', Stock: p.stock, ReorderLevel: p.reorder, Value: p.cost * p.stock }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Inventory');
            XLSX.writeFile(wb, `Inventory_${getTodayDate()}.xlsx`);
            showToast('Inventory exported', 'success');
        }
        
        function handleGlobalSearch(query) {
            // Simple global search implementation
            console.log('Searching for:', query);
        }
        
        // ADDED: Client onboarding functions
        function showOnboardModal() {
            if (currentUser.role !== 'admin') return showToast("Admin only", "error");
            document.getElementById('onboardName').value = '';
            document.getElementById('onboardProducts').value = '';
            openModal('onboardModal');
        }

        function processOnboard() {
            const name = document.getElementById('onboardName').value.trim();
            const lines = document.getElementById('onboardProducts').value.trim().split('\n').filter(l => l.trim());
            if (!name || !lines.length) return showToast("Name and products required", "error");

            let added = 0;
            lines.forEach(line => {
                const [n, cat, c, p, s] = line.split('|').map(x => x.trim());
                if (!n || !p) return;
                let sku = (cat || 'GEN').substring(0,3).toUpperCase() + Math.floor(10000 + Math.random()*90000);
                while (products.some(pr => pr.sku === sku)) sku = (cat || 'GEN').substring(0,3).toUpperCase() + Math.floor(10000 + Math.random()*90000);

                products.push({
                    id: 'P'+Date.now()+added,
                    sku,
                    name: n,
                    category: cat || 'General',
                    cost: parseFloat(c)||0,
                    price: parseFloat(p)||0,
                    stock: parseInt(s)||0,
                    reorder: 10,
                    vat: 16
                });
                added++;
            });
            saveAllData();
            showToast(`Added ${added} products for ${name}`, "success");
            closeModal('onboardModal');
            renderInventory();
            renderPOS();
        }
        
        function showNotifications() {
            showToast('No new notifications', 'info');
        }
        
        function showProfile() {
            console.log('Show profile');
        }
        
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && sidebar.classList.contains('show')) {
                if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            }
        });
        
        // Initialize app
        function initApp() {
            loadAllData();
            
            // Check for persisted user first (localStorage), then session
            const persistedUser = localStorage.getItem('lastLoggedUser');
            const sessionUser = sessionStorage.getItem('currentUser');
            
            if (sessionUser) {
                currentUser = JSON.parse(sessionUser);
            } else if (persistedUser) {
                // Restore from localStorage if session expired
                currentUser = JSON.parse(persistedUser);
                sessionStorage.setItem('currentUser', persistedUser);
            }
            
            if (!currentUser) {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
            } else {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                renderAll();
            }
        }
        
        // Run on page load
        window.addEventListener('DOMContentLoaded', initApp);
        
        // PWA Service Worker Registration with Enhanced Offline Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'biasharaflow-v2';
                    const urlsToCache = [
                        './',
                        './?standalone=true'
                    ];
                    
                    self.addEventListener('install', (event) => {
                        console.log('[ServiceWorker] Installing...');
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => {
                                    console.log('[ServiceWorker] Caching app shell');
                                    return cache.addAll(urlsToCache);
                                })
                                .then(() => self.skipWaiting())
                        );
                    });
                    
                    self.addEventListener('activate', (event) => {
                        console.log('[ServiceWorker] Activating...');
                        event.waitUntil(
                            caches.keys().then((cacheNames) => {
                                return Promise.all(
                                    cacheNames.map((cacheName) => {
                                        if (cacheName !== CACHE_NAME) {
                                            console.log('[ServiceWorker] Removing old cache:', cacheName);
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            }).then(() => self.clients.claim())
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    // Cache hit - return response from cache
                                    if (response) {
                                        return response;
                                    }
                                    
                                    // Clone the request
                                    const fetchRequest = event.request.clone();
                                    
                                    return fetch(fetchRequest).then((response) => {
                                        // Check if valid response
                                        if (!response || response.status !== 200 || response.type !== 'basic') {
                                            return response;
                                        }
                                        
                                        // Clone the response
                                        const responseToCache = response.clone();
                                        
                                        caches.open(CACHE_NAME).then((cache) => {
                                            cache.put(event.request, responseToCache);
                                        });
                                        
                                        return response;
                                    }).catch(() => {
                                        // Network failed, return cached response if available
                                        return caches.match(event.request);
                                    });
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('[PWA] Service Worker registered - Offline mode available'))
                    .catch((err) => console.log('[PWA] Service worker registration failed:', err));
            });
        }
        
        // Online/Offline Status Monitoring
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            const offlineBanner = document.getElementById('offlineBanner');
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            if (isOnline) {
                if (offlineBanner) offlineBanner.classList.add('hidden');
                if (syncStatus) {
                    syncStatus.classList.remove('offline');
                    syncStatus.classList.add('online');
                }
                if (syncText) syncText.textContent = 'Online';
                console.log('[Status] Online - Data will sync');
            } else {
                if (offlineBanner) offlineBanner.classList.remove('hidden');
                if (syncStatus) {
                    syncStatus.classList.remove('online');
                    syncStatus.classList.add('offline');
                }
                if (syncText) syncText.textContent = 'Offline';
                console.log('[Status] Offline - Working locally');
            }
        }
        
        // Monitor connection status
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        window.addEventListener('load', updateOnlineStatus);
        
    </script>
</body>
</html>
